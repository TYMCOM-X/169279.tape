
:*************************************************************************
: FILENAME :  KANJ25.301, 
:             THIS PATCH IS ON LINK BASIS. THIS PATCH CAN BE INSTALLED
:             INTO X.25 XCOM. FOR X.75 GATEWAY OR X.25 GATEWAY, PLS
:             USE KANJ75.301.
:************************************************************************
:
: THIS PATCH IS UPGRADED FROM (JWANG:37:8NEXTD.300 OF VERSION 3.00) TO
: VERSION 3.01  (CHANGE 3.00 BY TOCHI-NSC.JAPAN)
: 8NEXTENDED MODE HOST USE THE PARITY BIT AS A CONTROL BIT.
: ANY ORIGINATOR CALL THIS HOST SHOULD ENABLE THE 8NEXTENDED CHARACTER
: FUNCTION.
: FUNCTION OF THIS PATCH:
:   1. IF THE HIGHEST BIT (PARITY BIT) IS ON, TREAT THIS CHARACTER
:      IN A NON-TERMINATOR. SO, SKIP CHECK THE PAD FORWARDING CHARACTER.
:      DAMAC2 AT DAT120 AND DAT160.
:   2. IF THE HIGHEST BIT ON, ECHO IT FOR FULLDUPLEX TERMINAL AND NOT ECHO
:      IT BACK FOR HALFDUPLEX TERMINAL. OTHERWSIE, THE CODE HANDLES AS BEFORE.
:      DAMAC1 AT DAT160.
:      ALL THE CHARACTERS WHOSE HEX VALUE ARE IN THE RANGE '80 -- FF'
:      ARE ASSUMED TO BE ECHOABLE. (OTHERWISE, WE NEED TO EXPAND
:      ECHOABLE FROM THE RANGE 00-7F TO '00-FF'---ANOTHER PATCH
:      IS REQUIRED FOR THIS CASE.)
:   3. NOT ECHO '0A' FOR 8D, '0D' FOR '8A'.
:      ECHO '0A' INSTEAD OF '8A' FOR '0D', '0D' NOT '8D' FOR '0A'.
:      (SUPPOSE ECHO LF OR CR IS ENABLED ON THE SYSGEN---DEFINED ON TYMFILE)
:      DAMAC1 AT DAT160.
:   4. SEND ETM BACK TO ORIGINATOR AFTER CALL ACCEPTED PACKET RECEIVED FROM
:      HOST (I.E., FROM THE LINK.)
:   5. SEND LTM TO CONSAT WHEN XCOM RECEIVES 'LEVEL 1 PACKET-- INVITATION TO 
:      CLEAR' FROM HOST.
:   6. IF PADOPTION XONOFF IS GENNED IN THE SLOT, DON'T MASK OFF THE
:      PARITY BIT FOR XONOFF CHARACTER.
:
:  *** FOR 8NEXTENDED HOST, THE INPARITY(...) SHOULD USE 'SAVE' OPTION
:  *** OR USE DEFAULT.
:
:  
:  *** ENABLE THIS PATCH ON SOME PARTICULAR LINK BY ADDING
:  *** EXTD8N[8000 IN THE COMMAND FILE AFTER ASSEMBLING THIS PATCH
:      IF LINK 0 IS CONNECTED TO 8NEXTENDED HOST.
:  *** OR ADD EXTD8N[4000 IF LINK 1.
:
:
:********************limitation****************************************
:
: REVISED ON NOV 25, 1986 BY JWANG.
:
: SOME INSTRUCTIONS'S ADDRESS CHANGED FROM DAT160+?? TO DAT170-??
: TO MAKE IT MORE GENERAL. THE JAPAN X.25 SLOT ISN'T GENERATED WITH
: DNOP CONDITION. BUT KDD X.75 GATEWAY GENED WITH DNOP SET TO 1 AND
: SO, ONE MORE INSTRUCTION WAS GENERATED BETWEEN DAT160 AND DAT170.
: THIS FORCE THIS ORIGINAL PATCH GIVEN TO JAPAN DOESN'T FIT TO KDD.
: THE CAHNGE FROM DAT160+?? TO DAT170-?? TO MAKE IT MORE GENERAL
: AND THEN CAN BE USED FOR JAPAN AND KDD. 
: DUE TO NO SYMBOL EXISTS BETWEEN DAT160 AND DAT170, THERE IS STILL
: ONE LIMITATION STATED AS BELOW:
: TO USE THIS PATCH,'PBCIND' SHOULDN'T BE DEFINED ON SYSGEN TIME.
: OTHERWISE THE WHOLE SET OF INSTRUCTIONS UNDER 'IF \PBCIND' WILL
:  BE GENERATED AND THE ADDRESS OF DAT170-?? NEEDS TO BE CHANGED.
: THERE IS NO WAY TO GET RID OF THIS LIMITATION DUE TO NO SYMBOL
: CAN BE USED BETWEEN DAT160 AND DAT170.********limitation*************
:**********************************************************************
:======================================================================
:
: PART 1.
:
PATCH(860922,1200,JWANG,PA0PTR,,4)
EXTD8N  BC      0,0,0,0
CONPATCH(DAT130-16,,6)
        J       PA1PTR,,
CONPATCH(PA1PTR,,22)
        LB      R4,LINUM,,
        TBT     R4,EXTD8N,,
        JEFS    .+0A
        CR      R0,R8           :PARITY BIT ON?
        JN      DAT130-0A,,     :YES, NOT TERMINATOR
        LB      R2,XMTASC,R8,   :CHECK TERMINATOR
        J       DAT130-10,,
CONPATCH(DAT170-16,,6)
        J       PA1PTR,,
CONPATCH(PA1PTR,,22)
        LB      R4,LINUM,,
        TBT     R4,EXTD8N,,
        JEFS    .+0A
        CR      R0,R8           :PARITY BIT ON?
        JN      DAT170-0A,,     :YSE, NOT TERMINATOR
        LB      R2,XMTASC,R8,   :CHECK TERMINATOR
        J       DAT170-10,,
:
:==========================================================================
: PART 2.
:
CONPATCH(DAT170-9E,,6)
        J       PA1PTR,,
CONPATCH(PA1PTR,,4A)
        TBT     R4,HLFDUP,,
        JN      LFCR            :NO ECHO FOR HALFDUPLEX
        LB      R4,LINUM,,
        TBT     R4,EXTD8N,,
        JEFS    .+8
        CR      R0,R8           :PARITY BIT ON?
        JN      LFCR1           :ECHO IT BACK
        TBT     R8,DETBL,R9,    :ECHOABLE? DEFINE ON TYMFILE/
        JE      LFCR
LFCR1   JAL     R4,PUTCH,,
:======================================================================
:
: PART 3
:
LFCR    LB      R4,LINUM,,
        TBT     R4,EXTD8N,,
        JEFS    .+0A
        CR      R0,R8           :PARITY BIT ON?
        JN      DAT170-24,,     :YES, SKIP INSERTING 0A OR 0D
        J       DAT170-8C,,
CONPATCH(DAT170-62,,4)
        LHI     R0,0A
CONPATCH(DAT170-2C,,4)
        LHI     R0,0D
:
:============================================================
:
: PART 4.
:
CONPATCH(PCA310+30,,6)
        J       PA1PTR,,
CONPATCH(PA1PTR,,1E)
        TBT     RL,EXTD8N,,
        JN      PCA310+44,,     :SEND ETM
        TBT     RL,ETM.F,,
        JE      PCA340,,
        J       PCA310+38,,
:**********************************************************************
:
: PART 5. SEND 'LTM' TO CONSAT at the time xcom receives
:          Q-BIT packet 'invitation to clear' from Host.
CONPATCH(RLEV12,,8)
        J       PA1PTR,,
        NOPR    0,0
CONPATCH(PA1PTR,,42)
        TBT     RL,EXTD8N,,
        JE      NOLTM           :NOT TO SEND LTM
        LHL     R1,DPORT,,
        TBT     R1,TURKEY,,     :IS IT A TURKEY CALL?
        JN      NOLTM           :IF NOT FROM CONSAT, SKIP SENDING LTM
        CTLMSG(LTM)             :SEND LTM TO CONSAT
NOLTM   LHL     R5,IPORT,,
        TBT     R5,EXTCAL,,
        J       RLEV12+8,,
:
: SEND LTM TO CONSAT WHEN CLEAR REQUEST RECEIVED FROM THE LINK
:
CONPATCH(RTCLR+8,,6)
        J       PA1PTR,,
CONPATCH(PA1PTR,,2E)
        JN      RTEILL,,
        TBT     RL,EXTD8N,,
        JE      TCLR05
        CTLMSG(LTM)
TCLR05  LIS     R0,0
        J       RTCLR+0E,,
:
:============================================================================
: PART 6. IF PADOPTION XONOFF IS TURNED ON , SKIP MASKING OFF THE PARITY
:         BIT WHEN WE COMPARE DATA FROM THE LINK WITH XON (11) AND XOFF (13)
:         CHARACTERS.
:
   IF   PDO.|XONOF|
CONPATCH(TDA141,,6)
        J       PA1PTR,,
CONPATCH(PA1PTR,,1A)
        JAL     R4,PICKCH,,
        LR      R7,R0
        TBT     RL,EXTD8N,,
        JE      TDA141+6,,              :WILL MASK OFF THE PARITY BIT
        J       TDA141+0A,,             :WILL NOT TURN OFF PARITY BIT
ENDPATCH(THE PADOPTION XONOFF TURNED ON, NOT MASK OFF PARITY BIT FOR XON/XOFF)
   EI
ENDPATCH(IF THE HOST IS 8NEXTENDED, SEND ETM TO ORIGINATOR AND FOLLOWINGS)
ENDPATCH(ECHO 0A FOR 0D NOT 8D)
ENDPATCH(ECHO 0D FOR 0A NOT 8A)
ENDPATCH(ECHO THE CHARACTER IN WHICH THE PARITY BIT IS ON)
ENDPATCH(THE CHARACTER WITH PARITY ON IN NOT TREATED AS TERMINATOR)
ENDPATCH(SEND LTM WHEN INVITATION TO CLEAR RECEIVED FROM THE LINK)
