:=====================================================================
:=
:=                        T H E   S N O S T
:=                        -----------------
:= DATE: AUGUST 11, 1987
:= WRITTEN BY: PHIL SNEDDON
:=
:======================================================================

         SEG A.DATA

         GL IMORG,GOTZAP,LENGTH,INPTSW,REST,HPORT,GOTORG
         GL NOTNDL,CTLC,CTL10,CTL15,CONTC,CONT10,CONT15
         GL CONT6,CONTD,CONT1A,CONT8,RPORT,MAXCIR
         GL CTL9,CONT9,CTL4,CONT4,CTLB,CONTB,CTL17,CONT17
         GL CTLF,CONTF,CONT16,CTL16,CONT14,CTL14,DOECHO
         GL CTL19,CONT19,CTLE,CONTE,CTL12,CONT12,CTL1,CONT1
         GL CTL2,CONT2,CONT3,CTL3,CTL5,CONT5
         IF SPCSEQ
         GL CTL18,CONT18
         ELSE
         KILL CTL18,CONT18
         EI
OBSIZE   EQ PKTSIZ*2
IBUFSZ   EQ (PKTSIZ+2)*RCVQA         
STSSIZ   EQ 0E
IDXWRP   EQ ((PKTSIZ+2)*RCVQA)-(PKTSIZ+6)  :SIO RBUF INDEX WRAP POINT
LUN      EQ 0
CONMOM   EQ 90
FRCMBO   EQ 0B0
FRCMBI   EQ 0A0




        IF SYS38
ACVPU    XC 000040002D00000000006B8000110201050000000001
        ELSE
ACVPU    XC 000040002D000000ABFD6B8000110201050000000003
       EI (SYS38)
ACVPUL   EQ $A22

:--- as of 03/08/90 this format for NMVT is just a guess ---:
NMVTBF   XC 000040002C00000000020B800041038D00000000000000
         RE $A200                     :TRYING A HUGE NMVT
         BC 88
         ER
NMVTLN   EQ $A220

ZAPMSG   SC /"9E/                     :DETACH
SETECH   SC /"B1"00"01/
BELL     SC /"87/
PROMPT   SC /"8D"8A"DB"BE/
CRALF    SC /"8A"8D/
BKSPC    SC /"88"A0"88/               :BACKSPACE AND ERASE
PUSFE    SC / IDLE/
PUSFF    SC / POLLING/
PUS0     SC / INACTIVE/
PUS12    SC / IN FLUX/
PUS3     SC / PENDING/
PUS4     SC / ACTIVE/
PUS7     SC / DISC/
BADPU    SC /"8D"8A"87ADDRESS IS TOO LONG. EXTRA CHARACTER DISCARDED"8A"8D/
BADLUM   SC /"8D"8A"87INVALID LU ADDRESS - START OVER"8A"8D/
WORKNG   SC /working.../
LEFT01   SC /"8A"8D"87NO PU TO ASSIGN THIS LU TO"8A"8D/
LEFT02   SC /"8A"8DENTER PU NUMBER (X FOR ALL)"BA/
LEFT03   SC /"8A"8D"87 Out of RANGE! Command ABORTED!/
LEFT04   SC /"8A"8DUA WILL BE IGNORED/
LEFT05   SC /"8A"8DWILL RE-ACT TO UA NOW/
LEFT06   SC /"8A"8DENTER RELATIVE PU NUMBER (X FOR ALL)"BA /            
LEFT07   SC /"8A"8DNOW ENTER THE RELATIVE LU ON THIS PU (X FOR ALL)"BA /
LEFT08   SC /"8A"8A"8D"BCescape!"87"BE/
LEFT09   SC /"8A"8D"87 TERMSELF"AFRSHUTD RSP WILL NOT BE SENT"8D"8A/
         IF RSHUTD
LEFT0A   SC /"8A"8D ----- SENDING RESPONSE TO REQUEST SHUTDOWN -----"8A"8D/
         ELSE
LEFT0A   SC /"8A"8D ----- SENDING RESPONSE TO TERM-SELF -----"8A"8D/
         EI
LEFT0B   SC /"8A"8DSEND RESPONSE TO TERMSELF"AFRSHUTD AT THIS TIME"BA (Y"AFN)/
LEFT0C   SC /ENTER RELATIVE LU NUMBER IN HEX (MAX IS F)"BA /
LEFT0D   SC /ENTER FIRST BYTE OF RU"BA /
LEFT0E   SC /"8D"8AMANUAL OVERRIDE IS NOW OFF"8A"8D/
LEFT0F   SC /"8A"8DENTER TEXT AND TERMINATE WITH CR (TOGGLE "DEX)"8A"8D-"3E/
LEFT10   SC /        3 TO SET THE EXPEDITE BIT IN THE TH"8A"8D/
LEFT11   SC /"8A"8DINPUT THE NEW RH --"BE /
LEFT12   SC /"8A"8DENTER THE NEW SNF --"BE /
LEFT13   SC /"8A"8DENTER A 1 TO CHANGE THE LENGTH OF THE RU"8A"8D      /
LEFT14   SC /  2 TO CHANGE THE RH"8D"8A/
LEFT15   SC /"8A"8DENTER THE LENGTH OF THE RU--"BE/
LEFT16   SC /        4 TO RESET THE EXPEDITE BIT IN THE TH"8A"8D/
LEFT17   SC /SPECIAL FRAME SEQUENCE HAS BEEN SENT"87"8A"8D/
LEFT18   SC /"8A"8DENTER THE NEW RU --"BE /
LEFT19   SC /        A TO RESPOND TO FMD DATA AUTOMATICALLY"8A"8D/
LEFT1A   SC /--"BE /
LEFT1B   SC /"8A"8DWILL NOW RESPOND TO FMD DATA AUTOMATICALLY/
LEFT1C   SC /"8A"8DWILL NO LONGER RESPOND TO FMD DATA/
LEFT1D   SC /"8A"8D --- COUNTERS HAVE BEEN RESET ---/
LEFT1E   SC /"8A"8DSEND CONTINUOUS XIDs"BF--"BE /
LEFT1F   SC /"8A"8D   1 = SEND DISCONNECT/
LEFT20   SC /"8A"8D   2 = SEND DE-ACTPU/
LEFT21   SC /"8D"8A *** NOW SENDING SDLC TEST FRAMES ***"8A"8D/
LEFT22   SC /"8A"8D *** NO LONGER SENDING SDLC TEST FRAMES ***"8A"8D/
LEFT23   SC /"8A"8D   3 = ENTER IDLE STATE"8A"8D/
LEFT24   SC /"8A"8D ***  NOW SENDING HIGH VOLUME RESPONSE TIME FRAMES ***/
LEFT25   SC /"8A"8D ***  NO LONGER SENDING RESPONSE TIME DATA FRAMES ***/
LEFT26   SC /        5 TO CHANGE THE RH OF SSCP DATA"8A"8D/
LEFT27   SC /        6 TO COMPLIMENT THE FIRST SEGMENT BIT IN SSCP DATA"8A"8D/
LEFT28   SC /        7 TO COMPLIMENT THE LAST SEGMENT BIT IN SSCP DATA"8A"8D/
LEFT29   SC / <the bit is now 0>"8A"8D/
LEFT2A   SC / <the bit is now 1>"8A"8D/
LEFT2B   SC /"8A"8DENTER RELATIVE LU NUMBER (X FOR ALL PRINT JOBS)--"BE/
LEFT2C   SC /"8A"8D ** All PRiNT jOBS wiLL SToP sHoRtLy **"8a"8d/
LEFT2D   SC /   4 = SEND NMVT"8A"8D/
LEFT2E   SC /   5 = QUERY or CHANGE STATE OF DTR"8A"8D/
LEFT2F   SC /"8A"8DENTER 1 - QUERY STATE OF DTR/
LEFT30   SC /"8A"8D      2 - CHANGE STATE OF DTR/
LEFT31   SC /"8A"8D-dtr-"BE /
LEFT32   SC /"8A"8D"DE"DE"DE DTR is now HIGH "DE"DE"DE/
LEFT33   SC /"8A"8Dvvv DTR is now LOW vvv/
LEFT34   SC /        8 TO CHANGE THE REASON CODE IN THE MANUAL UNBIND"8A"8D/
LEFT35   SC /"8A"8D-gimme the new reason-"BE /
LEFT36   SC /   6 = DISPLAY ERROR COUNTERS"8A"8D/
LEFT37   SC /        9 TO DISPLAY LAST SCREEN RECEIVED FOR LU 0"8A"8D/
LEFT38   SC /"8D"8AENTER 1 TO INPUT RU FOR LU-LU SESSION"8A"8D/
LEFT39   SC /      2 TO INPUT RU FOR SSCP-LU SESSION"8A"8D/
LEFT3A   SC /"8A"8DENTER 1 TO CHANGE LENGTH OF LU-LU RU"8A"8D/
LEFT3B   SC /      2 TO CHANGE THE LENGTH OF THE SSCP-LU RU"8A"8D/
LEFT3C   SC /   7 = ALTER T1 TIMER"8A"8D/
LEFT3D   SC /"8A"8D   1 = SUSPEND T1/
LEFT3E   SC /"8A"8D   2 = CHANGE VALUE OF T1/
LEFT3F   SC /"8A"8D   3 = RESTORE T1 TO ORIGINAL VALUE/
LEFT40   SC /"8A"8DT1"BE/
LEFT41   SC /"8A"8D T1 TIMER RESTORED TO DEFAULT/
LEFT42   SC /"8A"8D T1 TIMER SUSPENDED/
LEFT43   SC /"8A"8D NEW VALUE FOR T1 IN FASTC HEX "BC 7FFF"BA /
LEFT44   SC /"8A"8D"87 ** error"BA VALUE TOO LARGE **/
LEFT45   sc /   8 = SEND FRAME OUTSIDE THE WINDOW"8d"8A/
LEFT46   SC /"8A"8D   1=SEND BAD RR"8A"8D/
LEFT47   SC /   2=SEND BAD N"A8S"A9"8A"8D/
LEFT48   SC /   3=SEND BAD N"A8R"A9"8A"8D/
LEFT49   SC /   4=SEND BAD N"A8S"A9 and N"A8R"A9"8A"8D/
LEFT4A   SC /   5=SEND BAD FRAME"8A"8D/
LEFT4B   SC /   6=SKIP 1 N(S) COUNTER DURING RESP TIME TESTING"8A"8D/
LEFT4C   SC /   9 = STEP THROUGH FOREGROUND TRACE"8A"8D/
LEFT4D   SC /"8A"8D"87 not configured for FOREGROUND trace "8A"8D/
LEFT4E   SC / --- all caught up --- "8a"8d/
ERMG00   SC /"8D"8A"8A       FRMR   FRMR TIM   REJ    REJ TIM    UNKN/
ERMG01   SC /   RXMT   TOOF   RNR  /
ERMG02   SC /"8A"8D       ----   --------   ---    -------    ----/
ERMG03   SC /   ----   ----   ---  /
ERMG04   SC /"8A"8DPU 0"BA  XXXX   XXXXXXXX   XXXX   XXXXXXXX   XXXX  /
ERMG05   SC / XXXX   XXXX   XXXX   /
ERMG06   SC /"8D"8A"8AGLOBAL COUNTERS -      SIO RETRY"BA XXXX  /
ERMG07   SC /"8A"8D                      RETRY TIME"BA XXXXXXXX  /
ERMG08   SC /"8A"8D                  ADDRESS ERRORS"BA XXXX  /
ERMG09   SC /"8A"8D                    CURRENT TIME"BA XXXXXXXX   /
NOTSUP   SC /"8D"8A"87 SORRY BUT THAT RU IS NOT SUPPORTED"8A"8D/
BADHEX   SC /"8D"8A"87 YOU DIDN"A7T FOLLOW DIRECTIONS"8A"8D/
BADPU2   SC /"8D"8A"87ADDRESS IS TOO SHORT. ENTER MISSING CHARACTER"8A"8D/
BADPU3   SC /"8D"8ALAST ADDRESS ENTERED DID NOT MATCH AN ADDRESS GENNED /
BADPU4   SC /IN THIS SLOT."8D"8ARE-ENTER LAST ADDRESS"BA /
BOOTMG   SC /"8D"8A"8A"8A"8Ano"AE"8A"8A"8A"8A"8D/
AUFWDR   SC /"8D"8A"8ASNOST SENDS YOU A 53..."8A"8D"87/
THEADR   SC /"8A"8D  "FC-----TH-----"FC/
RHEADR   SC / "FC-RH--"FC"8A"8D/
DSPERM   SC /"8A"8D UNEXPECTED EXIT FROM PRINT ROUTINE"8A"8D/
DSPNDT   SC /"8A"8D NO DATA FOR LU 0"8A"8D/
BNR1     SC /"8D"8A"8A"8A"8A"87/
BNR2     SC /                                 /
BNR3     SC /* WELCOME TO  *"8D"8A"8A/
BNR4     SC /                               /
BNR5     SC /T H E   S N O S T"8D"8A/
BNR6     SC /-----------------"8D"8A/




HLP1     SC /"8A"8D         SNOST COMMANDS"BA"8D"8A/
HLP2     SC /         ---------------"8A"8D/
HLPA     SC /  "DEA - SEND XID"8A"8D/
HLPB     SC /  "DEB - SEND SDLC TEST FRAMES"8A"8D/
HLPC     SC /  "DEC - START RESPONSE-TIME TESTING "8A"8D/
HLPF     SC /  "DEF - START POLLING PHYSICAL UNITS"8A"8D/
HLPD     SC /  "DED - VARIOUS LINK LEVEL CMDS "A8DISC DACTPU etc"A9"8A"8D/
HLPE     SC /  "DEE - STOP SPECIFIED PRINT JOB"8A"8D/
HLPH     SC /  "DEH - PRINT LIST OF SNOST COMMANDS"8A"8D/
HLPI     SC /  "DEI - IGNORE UA FOR SPECIFIED PU"8A"8D/
HLPK     SC /  "DEK - DE-ACTIVATE THE SPECIFIED LU"8A"8D/
HLPL     SC /  "DEL - ACTIVATE LOGICAL UNITS"8A"8D/
HLPN     SC /  "DEN - TO CHANGE THE SNF FOR A SPECIFIED LU"8A"8D/
HLPO     SC /  "DEO - MANUAL ENTRY OF RU TO SEND"8A"8D/
HLPP     SC /  "DEP - ACTIVATE PHYSICAL UNITS"8A"8D/
HLPR     SC /  "DER - TO RESET FMD COUNTERS AND ERROR COUNTERS"8A"8D/
HLPT     SC /  "DET - ENTER TEXT FOR SINGLE SEGMENT RU"8D"8A/
HLPU     SC /  "DEU - DISPLAY STATUS OF ALL PHYSICAL AND LOGICAL UNITS"8D"8A/
HLPV     SC /  "DEV - TURN OFF MAUNAL ENTRY"8A"8D/
HLPW     SC /  "DEW - DON'T SEND TERMSELF"AFRSHUTD RSP"8A"8D/
         IF SPCSEQ
HLPX     SC /  "DEX - SEND THE SPECIAL FRAME SEQUENCE"8A"8D/
         EI
HLPY     SC /  "DEY - VARIOUS MANUAL OPTION CHANGES"8A"8D/
HLPZ     SC /  "DEZ - LOGOFF"8A"8D/
PUPRM0   SC /"8D"8ATO ACTIVATE ALL PHYISICAL UNITS ENTER "A2X"A2/
PUPRMP   SC /"8D"8AELSE ENTER P.U. ADDRESSES SEPARATED BY COMMAS"BA /
LUPRM0   SC /"8D"8ATO ACTIVATE ALL LOGICAL UNITS ENTER "A2X"A2/
LUPRM1   SC /"8D"8AELSE ENTER THE P.U. WHOSE LU"A7S YOU WANT TO ACTIVATE"BA/
LUPRM2   SC /"8D"8ANOW ENTER "A2X"A2 TO ACTIVATE ALL THE LU"A7S FOR THIS/
LUPRM3   SC / PU"8A"8DOR ENTER LU ADDRESSES SEPARATED BY COMMAS"BA/
STAT1    SC /"8D"8AP.U. ADDR"BA    /
STAT2    SC /"8D"8AL.U. ADDR"BA/
STAT3    SC /                                                               /
STAT4    SC /"8D"8AL.U. STAT"BA/
STAT5    SC /                                                               /
STAT6    SC /"8A"8DFMD  RCVD"BA/
STAT7    SC /                                                               "8A/
STAT8    SC /   * FRMR received! * /
STAT9    SC /   * REJ received! *  /
ACTMSG   SC /"8A"8D L.U. ACTIVATIONS HAVE BEEN SENT"8A"8D/
POLMSG   SC /"8A"8DPHYSICAL UNIT IS NOW POLLING"87"8A"8D/
RATLU    XC 01000000000000000100000000000000010000000000000001
         XC 0000000000010000000000


ZERSTR  HC 0                          :BEGINNING OF RESET AREA
PIGGY0  WS 10                         :DEBUGGING STORAGE FOR PIGLET
FMDCTR  HS NUMLU                      :STORAGE TO COUNT FMD DATA RECEIVED
HPORT   HC 0                          :TEMP STORAGE FOR GUY TO GET BOOTED
PTDELY  HS NUMLU                      :PRINT DELAY
REQCRT  HS NUMLU                      :REQUESTING CRT OF PRINTER
PRNTCT  HS NUMLU                      :NUMBER OF PRINT RECORDS SENT
PREVRR  BS NUMPU                      :LAST RR CONTROL FIELD
DEFSES  BC 0                          :0D=LU-LU SESSION  45=SSCP-LU SESSION
FRSTPJ  WC 0,0,0,0                    :FIRST PRINT JOB ARRAY (FOR BRACKET)
PACIND  WS NUMLU/20+1                 :PACING-REQUESTED INDICATOR
FIRSTZ  HC 0
SCNDSZ  HC 0
THRDSZ  HC 0
LASTSZ  HC 0
ADDP30  WC 0
ADDP31  WC 0
ADDP32  WC 0
ADDP33  WC 0
APPLIC  HC 0                          :APPLICATION (OAF)
INPTSW  HC 0                          :ISICOP CONTROL FLAG
ENDSW   HC 0                          :END OF IMORG ADDRESS INPUT SWITCH
OUTWSW  HC 0                          :OUTSIDE-THE-WINDOW SWITCH
BDRRSW  HC 0                          :SEND BAD RR SWITCH
BDNSSW  HC 0                          :SEND BAD N(S) SW used in SNDRR
BDNRSW  HC 0                          :SEND BAD N(R) SW
BDSRSW  HC 0                          :SEND BAD N(S) and N(R) SW
BDFMSW  HC 0                          :SEND BAD FRAME
RREEFS  HC 0                          :skip an N(S) counter
RREEFI  WC 0                          :ARRAY TO INDICATE DATA RCV'D DURING RTT
RREEFC  HC 0                          :COUNTER OF THOSE (ABOVE) EVENTS
UAIGNR  HC 0                          :IGNORE UA FLAG
TSTFRM  HC 0                          :SEND-TEST-FRAME-ARRAY
RESPBT  HC 0                          :RESPONSE-TIME-TEST BIT FLAG
INTRPT  HC 0                          :SEND EXPIDITED FRAME NOW FLAG ARRAY
XCURPU  HC 0                          :current PU sending response time frames
RPDMSW  HC 0                          :ARRAY TO PREVENT DM-DISC LOOP
MANUAL  HC 0,0,0,0,0,0,0,0            :ARRAY TO INDICATE MANUAL REQUESTS
CMTARY  WC 0,0,0,0,0,0                :1=CRT IS RUNNING CMT STRESS TEST
ONEPRT  WC 0,0,0,0,0,0                :1=STOP LU.T1 PRINT WHEN +RSP TO LAST
SC78AR  WC 0,0,0,0,0,0                :DECISION MAKER FOR SENDING SC7 OR SC8
DRPDLU  WS 4                          :DEF-RSP-DFC-LU-LU-SESSIONS
DRPDSC  WS 4                          :DEF-RSP-DFC-SSCP-LU-SESSIONS
DRPSLU  WS 4                          :DEF-RSP-SC-LU-LU-SESSIONS
DRPSSC  WS 4                          :DEF-RSP-SC-SSCP-LU-SESSIONS
DRPLUL  WS 4                          :DEFINITE-RSP-FOR-LU-LU-SESSION
DRPSCP  WS 4                          :DEFINITE-RSP-FOR-SSCP-LU-SESSION
PUTXMT  HC 0                          :NEXT PU TO XMT DURING RESPONSE TIME TEST
CANDXM  HC 0                          :CANDIDATE FOR RESP TIME
FGRTAR  WC 0                          :INDICATES WHICH PU FG IS ON
BGRTAR  WC 0                          :RESP TIME TEST B.G. PU
XMTRCV  HC 0                          :1=RCV state  0=XMT state
RCVTMO  HC 0                          :counter of RCV timeouts in CXLU
LUTXMT  WS NUMPU                      :NEXT LU TO XMT DURING RESPONSE TIME TEST
        IF VTAMRF
VTAUTO  HC 0                          :1=AUTO RESPONSE TO FMD FROM CMH
        EI
PUDACR  HC 0                          :DE-ACTIVATE PU ARRAY
PUACTR  HC 0                          :ACTIVATE PU FLAG
NMVTAR  HC 0                          :SEND NMVT TO PU
DONTHG  HC 0                          :SNRM & DISC WAIT FLAG
                                      :BIT 2 = DTR CHNG BIT
SKPLUP  HC 0                          :SKip LU Processing in B.G.
HOLDPU  HC 0
HOLDLU  HC 0
CHARIX  HC 0
BIDRJC  BS NUMLU                      :BID REJECT COUNTER
ZEREND  HC 0                          :END OF RESET AREA

HLDPTR  HC 0
FRMCTR  HS NUMPU                      :FRMR COUNTER
UNKNCT  HS NUMPU                      :UNKNOWN CONTROL FIELD
REJCTR  HS NUMPU                      :FRAME REJECT COUNTER
ADERCT  HC 0                          :ADDRESS ERROR COUNTER
RSPERR  HC 0                          :
RSPETM  WC 0
REXMCT  HS NUMPU                      :NUMBER OF TIMES HAD TO CALL REXMIT
TOOFST  HS NUMPU                      :NUMBER OF TIMES HIF IGNORED ALL DATA
NEGCTR  HS NUMLU                      :NEGATIVE RESPONSES FOR LUs
DTLCTR  HC 0                          :DATA LOSS COUNTER
NOLCTR  HC 0                          :NO LU COUNTER
REJIND  HC 0                          :1=REJ RECEIVED FOR THAT PU
FRMIND  HC 0                          :1=FRMR received for that PU
RNRCTR  HS NUMPU                      :RNR COUNTER
SIORCT  HC 0                          :SIO RETRANSMIT COUNTER
HLDSNS  HC 0                          :TEMP STORAGE FOR POSSIBLE SENSE DATA
DEGUB   HC 0
FGNHL1  WC 0                          :HOLD REGISTER 1 IN FOREGROUND
HOLD4   WC 0
HOLD5   WC 0
HOLD6   WC 0
HOLD7   WC 0
SAVP7   WC 0
HOLDB2  WC 0
HOLDB9  WC 0                          :BACKGROUND STORAGE FOR R9
HOLD8   WC 0
DSPSAV  WS 0A
HLDSPT  BC 0
CONVEC  BC 0                          :NOTIFY CONTROL VECTOR CODE
SUSPEND BC 0                          :SUSPENDED OUTPUT INDICATOR
LUSRET  WC 0
REJTIM  WC 0                          :TIME LAST REJ WAS RECEIVED
FRMTIM  WC 0                          :TIME LAST FRMR WAS RECEIVED
RSNTIM  WC 0                          :TIME OF LAST UNDERRUN
LINTIM  WC 0                          :RR & XMT TIMEOUT CLOCK FOR ENTIRE LINE
SCTIME  WC 0                          :SIO CHECK TIME
SCHR2   WC 0                          :SIO-CHECK HOLD R2
        IF SIODBG                     :DEBUGGING SIO
SIXTIM  WC 0                          :SAVE LAST TIME SIO FRAME CAME IN
TRAP8   WC 0                          :SAVE R8 FOR SIO DEBUGGING
        EI
SAVALL  WS 10                         :HOLDER FOR BAKWAT
SAVMCK  WS 10                         :STORAGE FOR STRMCK
SIOALL  WS 10                         :STORAGE FOR SIOCHK
HOLD5F  WC 0                          :GENERIC FOREGROUND STORAGE
HOLD8F  WC 0                          :HOLDER FOR FOREGROUND
XFRAME  HC 0
XMTCNT  HC 0                          :TRANSMIT FRAME COUNT
SIOIDX  HC 0                          :CURRENT SIO IOUT# BUFFER IN USE
LASTFM  HC 0
LASTRR  HC 0                          :REL # OF LAST PU TO SEND A RR
HLDSNF  HC 0                          :TEMP STORAGE FOR SEQ NUM FIELD
HLBSNF  HC 0                          :TEMP STORAGE FOR BACKGROUND SNF STUFF
HLDBYT  BC 0
RUH1    BC 0                          :TEMP STORAGE FOR RU HEADER BYTE 1
SID000  HC 0
SID001  HC 0
SID002  HC 0
SID003  HC 0                          :THESE SID COUNTERS ARE FOR DEBUGGING
CURPU   HC 0
SAV3BS  WC 0                          :TEMP STORAGE FOR FIRST 3 BYTES OF PKT
HLDLIX  HC 0                          :TEMP STORAGE FOR BUFLIX
PIXLIX  HC 0                          :PU OR LU INDEX SWITCH
RUCNT   HC 0                          :RU NIBBLE COUNT
MODESW  HC 0                          :HEX/ASCII MODE
MANIX   HC 0                          :MANDAT INDEX
MANMAX  HC 0                          :MAXIMUM INPUT ALLOWED FOR MANIX
NIBHLD  HC 0
MANLU   HC 0                          :MANUAL LU
JAIL0   WS 1                          :STORAGE FOR R0
JAIL2   WS 1
HLDR5   WS 1
HLDR7   WS 1
ECHST   WS 10                         :ECHO STORE AREA
OUTRSP  WC 0                          :FLAG FOR OUTSTANDING RSP
PUSTUF  WC 0                          :INDICATION OF STUFF RECEIVED FOR PU
LUSTUF  WC 0                          :INDICATION OF STUFF RECEIVED FOR LU
TMSTUF  WC 0                          :INDICATION THAT A TIMER IS RUNNING
BITSIZ  HC 0                          :TEMP STORAGE FOR ISIS DATA LENGTH
LUPUNM  HC 0                          :STORAGE FOR NUMBER OF LU'S PER PU
CURLU   HC 0                          :HOLDER FOR CURRENT LU #DX  HC 0
FGCURL  HC 0                          :HOLDER FOR CURRENT LU BEING PROCESSED
HLDCNT  HC 0
TMPSNF  HC 0                          :TEMP STORAGE FOR REQ'S SNF
RUB2A3  HC 0                          :TEMP STORAGE FOR RU BYTES 2 AND 3
RPORT   HS MAXCIR                     :STORAGE FOR GOOD GUY
HLDHEX  WC 0                          :BINHEX HOLD AREA
ZERHLT  WC 0
ZERLEN  EQ ZERHLT-ZERSTR              :END OF HALT & RESTART AREA
        WC 0
LUDMPL  BC 0
LUDMP   RE 90
        BC 20
        ER
DTRARY  HC 0                          :0=DTR UP
FASTC.  WC 0
SLOWC.  WC 0
LSTFTM  WC 0                          :LAST TIMER WHILE WAITING FOR FINAL BIT

WNDARY  WC 0                          :NULL ENTRY FOR 0
        WC BDRRSW
        WC BDNSSW
        WC BDNRSW
        WC BDSRSW
        WC BDFMSW
        WC RREEFS                     :RECREATE RREEF (SEND 1,2,4)

LU1ARY  WC 0,0,0,0,0,0,0,0            :LU TYPE 1 ARRAY
LU3ARY  WC 0,0,0,0,0,0,0,0            :LU TYPE 3 ARRAY
        IF S7200
T1VAL   EQ RRTMO+$A190
        ELSE
T1VAL   EQ RRTMO+$A40
        EI
T1TIME  HC T1VAL
SNRM    BC 93
XID     BC 0BF
DISC    BC 53
HLFMCM  BC 0                          :HOLD FMD COMMAND
MANLRU  BC 0                          :HOLD MANUAL RU
MARKER  HC 0FFFF                      :INPUT BUFFER MARKER
BGSRET  WC 0  

        BC 0
DSPFLG  BC 14
FLGHLD  WC 0,20202020
FLGTHD  WC 0,0
        WC 20208A8D

SHOTRC  MACRO [
        IF FGTRCE
        LHL  R2,RPORT,, 
        L    R3,FGBUFT,R6,
        SLLS R3,3
        L    R7,FGLOCT,R3,
        ST   R7,FLGHLD,,
        LHL  R7,FGLOCT+4,R3,
        STH  R7,FLGHLD+4,,
        LA   R8,FLGTHD,,
        ST   R9,HOLDB9
        LIS  R9,4
        LA   R10,FGBUFT+4,R6,
        JAL  R4,BINHEX,,
        L    R9,HOLDB9
        LA   R3,DSPFLG,,
        JAL  R5,OCS,, 
        EI ]
        
        BND 2

        SEG A.CODE
HLPLIN  MACRO(TXT)[
        LH  R2,RPORT
        LA  R3,TXT
        JAL R5,OCS,,]
  

FGLOG   MACRO(LOC)[
        IF FGTRCE
PREVOG  EQ .
        ORG FGLOCT+LGQQ*8
        AC /LOC/
        ORG PREVOG
LGQQ    EQ LGQQ+1
        STM  R14,FGSTML,,
        LHL  R14,FGTIX,,
        LHI  R15,LGQQ-1
        ST   R15,FGBUFT,R14,
        L    R15,FASTC,,
        ST   R15,FGBUFT+4,R14,
        AIS  R14,8
        NHI  R14,3FF
        STH  R14,FGTIX,, 
        LM   R14,FGSTML,,
        EI   ]

        SEG A.DATA


:======================================================================
: SNA FORMAT DEFINITION

TH1      EQ 02
TH2      EQ 03
TH3      EQ 04
TH4      EQ 05
TH5      EQ 06
THSNF    EQ 06
TH6      EQ 07
RH1      EQ 08
RH2      EQ 09
RH3      EQ 0A
RU1      EQ 0B
RU2      EQ 0C
RU3      EQ 0D
RU4      EQ 0E
RU5      EQ 0F
RU6      EQ 10


::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  FRAME BUFFER AREA

        SEG  3
BUFINT  EQ  .                         :BEGINNING OF BUFFER INITIALIZATION
BUFPU   BS NUMPU*WINDSZ*LUBSIZ        :DIAGNOSTIC PU STORAGE AREA
        BND 2
BUFPIX  BS NUMPU
        BND 2
BUFPPW  BS NUMPU                      :CURRENT NUM UNPROCESSED BKGND PACKETS
        BND 2
BUFLU   BS NUMLU*WINDSZ*LUBSIZ      :DIAGNOSTIC LU STORAGE AREA
        BND 2
BUFLIX  BS NUMLU                      :RELATIVE BUFLU INDEX
        BND 2
BUFLPW  BS NUMLU                      :CURRENT NUMBER OF UNPROCESSED BKGND PKTS
        BND 4
BUFEND  EQ  .                         :END OF BUFFER AREA
BFSIZE  EQ  BUFEND-BUFINT             :LENGTH OF BUFFER AREA
        REMARK %   genning decision tables

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  LUSTAT STATE TABLE

         SEG A.DATA
         BND 4
         IF NOTIFY
LUSTBL   XC 00010009000300040000050000000000     :00-0F 
         ELSE
LUSTBL   XC 00010002000300040000050000000000     :00-0F
         EI (NOTIFY)
         XC 06000007000008000000000900000900     :10-1F
         XC 00000A00090009000900090009000900     :20-2F
         XC 09000000090009000900000900000000     :30-3F
         XC 00090009000009000900000000000900     :40-4F
         XC 00090000000000000000000000000900     :50-5F
         XC 00000900000900090009000900090009     :60-6F
         XC 00090000000000000900000000000000     :70-7F
         XC 00000000000000000000000000000000     :80-8F
         XC 00000000000000000000000000000000     :90-9F
         XC 00000000000000000000000000000000     :A0-AF
         XC 00000000000000000000000000000000     :B0-BF
         XC 00000000000000000000000000000000     :C0-CF
         XC 00000000000000000000000000000000     :D0-DF
         XC 00000000000000000000000000000000     :E0-EF
         XC 00000000000000000000000000000000     :F0-FF



: - - -  FMD COMMAND TABLE  - - - :

FMDTBL   XC 00010000000000001300000000000000     :00-0F
         XC 00000000000000000000000000000000     :10-1F
         XC 00000000000000000000000000000000     :20-2F
         XC 00000000000000000000000000000000     :30-3F
         XC 00000000000000000000000000000000     :40-4F
         XC 1C201700000000000000000000000000     :50-5F
         XC 00000000000000000000001210021100     :60-6F
         XC 000000000000001500000D0E0F030000     :70-7F
         XC 0014000000000000181F000000000000     :80-8F
         XC 1D1D1B1E0000001900001A0000000000     :90-9F
         XC 00000000000000000000000000000000     :A0-AF
         XC 00000000000000000000000000000000     :B0-BF
         XC 00160000000000000000000000000000     :C0-CF
         XC 00000000000000000000000000000000     :D0-DF
         XC 00000000000000000000000000000000     :E0-EF
         XC 000405060708090A0B0C000000000000     :F0-FF

: - - -  CHECK-LU-TIME-TABLE  - - - :

CHKTBL   XC 00000000000000000000000000000000     :00-0F
         XC 00000000000000000000000000000000     :10-1F
         XC 0000000000000000000000000000000F     :20-2F
         XC 000000000000000600000D00000E0000     :30-3F
         XC 00000200000100000010000000000000     :40-4F
         XC 02000300000000000000000000000000     :50-5F
         XC 04000000020002000700080009000A00     :60-6F
         XC 0B000000000000000005000000000000     :70-7F
         XC 0C000000000000000000000000000000     :80-8F
         XC 00000000000000000000000000000000     :90-9F
         XC 00000000000000000000000000000000     :A0-AF
         XC 00000000000000000000000000000000     :B0-BF
         XC 00000000000000000000000000000000     :C0-CF
         XC 00000000000000000000000000000000     :D0-DF
         XC 00000000000000000000000000000000     :E0-EF
         XC 00000000000000000000000000000000     :F0-FF





         BND 2
:-----  TABLE OF FIELD FORMATED FMD RUs  -----:

FMDFRL   HC 04                        :LENGTH /2
FMDFTB   WC 00810620                  :NOTIFY
         WC 00010683                  :TERMSELF

:-----  FORMATED FMD RU CONVERSION TABLE  -----:

FMDFCV   HC 0081                      :NOTIFY 
         HC 0001                      :TERMSELF

:-----  WORK AREA FOR CONVERSION  -----:

FMDFRU   WC 0

:-------  LUSTAT TO FMD STATE CONVERSION TABLE  -------:

LUSFMD   XC 99999999999999999999999999999999   :00-0F
         XC 99999999999999999999999997999999   :10-1F
         XC 99999999995099519999999399939999   :20-2F
         XC 99999999999999999990999991999999   :30-3F
         XC 99999999529999999999999999999999   :40-4F
         XC 99999999999999999999999999999989   :50-5F
         XC 99999999999999999999999999999999   :60-6F
         XC 99999299999999999999999999999999   :70-7F
         XC 99999999999999999999999999999999   :80-8F
         XC 99999999999999999999999999999999   :90-9F
         XC 99999999999999999999999999999999   :A0-AF
         XC 99999999999999999999999999999999   :B0-BF
         XC 99999999999999999999999999999999   :C0-CF
         XC 99999999999999999999999999999999   :D0-DF
         XC 99999997999999999999999999999999   :E0-EF
         XC 99999999999999999999999999999999   :F0-FF


        SEG A.DATA
:--- used to send bad frame ---
CRUMFM  XC 2C0000000000
        XC 038000
        RE 38
        BC 40
        ER

VTAMSZ  EQ $A 130
VTAMBN  XC 000040002C0000000000038000     :VTAM BANNER
        XC 4015401540404040404040404040404040404040404040404040404040
        XC 404040404040
        XC E6C5D3C3D6D4C540E3D640E2E3C9C77DE2154015
        XC 404040404040404040404040404040404040404040404040404040404040
        XC 4040404040E54040E34040C14040D415151515
        XC C5D5E3C5D940D3D6C7D6D57A40
        BND 4
VTM000  XC 000C00002C0000000000CB800004  :THIS GUY FOLLOWS THE VTAM BANNER
        BND 4
VTMRSP  XC 000040002C0000000000838000   :+RSP TO VTAM LOGON
VTMRSL  EQ $A13
NTFBUF  XC 000040002C00000000008B8000810620       :NOTIFY RESPONSE
NTFBFL  EQ $A16
        BND 4
BINDBF  XC 000040002D00000000006B800031010303B1   :BIND REQUEST
        IF HIFDRP
        XC A0
        ELSE
        XC 90
        EI
        if BRBID
        XC 30
        else
        XC 10
        ei
        XC 80000085850000020000000000000000
        XC 00020000
        BND 4
MANBN1  XC 000040002D00000000006B800031010303B1  :MANUAL LU.T1 BIND
        IF HIFDRP
        XC A0
        ELSE
        XC 90
        EI
        XC 30800001E8C6010101000000000000000000020000
        BND 4
MANBN2  XC 000040002D00000000006B800031010303B1  :MANUAL LU.T2 BIND
        IF HIFDRP
        XC A0
        ELSE
        XC 90
        EI
        XC 308000
        IF PACING
        XC 01
        ELSE
        XC 00
        EI
        XC 8585010102000000000000000000020000
        BND 4
MANBN3  XC 000040002D00000000006B800031010303B1  :MANUAL LU.T3 BIND
        IF HIFDRP
        XC A0
        ELSE
        XC 90  :BIND BYTE 05 
        EI
        XC 30800001E8C6010103000000000000000000020000
        BND 4
SDTBUF  XC 000040002D00000000006B8000A0     :SDT
        BND 4

STATRP  XC 000040002C0000000000CB800004
        BND 4
FMDRSP  XC 000040002C0000000000838000
        BND 4
:-- NEGATIVE RSP FOR SSCP DATA --:
FMDNRP  XC 000040002C00000000008790001001
        XC 000000000000                           :EXTRA FOR WRITING TO MEM
        BND 4
DFCBID  XC 000040002C00000000004B8000C8
        BND 4
CLERBF  XC 000040002D00000000006B8000A1
CLERLN  EQ $A14
        BND 4
UNBNBF  XC 000040002D00000000006B80003201
UNBNLN  EQ $A15
        BND 4
MANUBN  XC 000040002D00000000006B80003202         :MANUAL UNBIND REASON 02
        BND 4
DALBUF  XC 000040002D00000000006B80000E01
DALLEN  EQ $A15
        BND 4
        IF RSHUTD
SHDRSP  XC 000040002D0000000000CB8000C2
SHDLEN  EQ $A14
        ELSE
TRMSRP  XC 000040002C00000000008B8000010683
TRMLEN  EQ $A16
        EI (RHSUTD)
        BND 2
SHUTCR  XC 000040002D0000000000CB8000C1
SHCLEN  EQ $A14
SIGBUF  XC 000040002D00000000004B8000C900010000    :SIG
        BND 2
SHUTDR  XC 000040002D00000000004B8000C0
SHDLEN  EQ $A14
        BND 4
CHDIRE  XC 000040002C0000000000039040
        BND 4


:^_^_^_^_^_^_^_^_^_^_^_^_^_^_^_^_^_^_^_^
: THESE ARE EBCDIC CHARACTERS

A.       EQ 0C1
B.       EQ 0C2
C.       EQ 0C3
D.       EQ 0C4
E.       EQ 0C5
F.       EQ 0C6
G.       EQ 0C7
H.       EQ 0C8
I.       EQ 0C9
J.       EQ 0D1
K.       EQ 0D2
L.       EQ 0D3
M.       EQ 0D4
N.       EQ 0D5
O.       EQ 0D6
P.       EQ 0D7
Q.       EQ 0D8
R.       EQ 0D9
S.       EQ 0E2
T.       EQ 0E3
U.       EQ 0E4
V.       EQ 0E5
W.       EQ 0E6
X.       EQ 0E7
Y.       EQ 0E8
Z.       EQ 0E9
N0.      EQ 0F0
N1.      EQ 0F1
N2.      EQ 0F2
N3.      EQ 0F3
N4.      EQ 0F4
N5.      EQ 0F5
N6.      EQ 0F6
N7.      EQ 0F7
N8.      EQ 0F8
N9.      EQ 0F9



APLSC1  XC 000040002C0000000000029080
        XC F5C311C2E31DE83CC36B6011C3F460
        XC 11C47A6011C5C46011C5D71DC4
        BC S.,N.,A.,40,H.,O.,S.,T.,40,E.,M.,U.,L.,A.,T.,O.,R.,40
        BC P.,R.,I.,M.,A.,R.,Y.,40,M.,E.,N.,U.  
        XC 11C6C91DE86011C6D460
        XC 11C6F0                          :R6,C33
APLPUX  BC P.,U.,7A,40,40,40,40,40,L.,U.,7A,40,40,40
        XC 11C75A6011C7E43CC86B60
        XC 114BD31D60                                           
        BC E.,N.,T.,E.,R.,7A,1D,0E8,C.,L.,E.,A.,R.,1D,60
        BC F.,O.,R.,40,S.,C.,R.,E.,E.,N.,40,N0.,N2.,11,4B,0F6,1D,0E8
        BC P.,F.,N6.,40,40,1D,60,F.,O.,R.,40,C.,M.,T.,40,S.,T.,R.,E.,S.,S.
        BC 40,T.,E.,S.,T.
        XC 114C6A1DE8                                                
        BC P.,A.,N1.,40,40,1D,60,F.,O.,R.,40,S.,C.,R.,E.,E.,N.,40,N0.,N3.
        XC 114DC61DE8                                                 
        BC P.,F.,N7.,40,40,1D,60,T.,O.,40,S.,E.,N.,D.,40,T.,O.,40,A.
        BC 40,P.,R.,I.,N.,T.,E.,R.,11,4D,7A,1D,0E8,P.,A.,N2.,40,40,1D,60
        BC F.,O.,R.,40,N2.,40,S.,T.,A.,G.,E.,40,P.,A.,C.,I.,N.,G.
APL1SZ  EQ $A260  :260           :INCLUDING 2 BYTE LENGTH FIELD AT BEGINNING
        BND 4
APLS02  XC 000040002C0000000000009000    :MIDDLE SECTION OF CHAIN
        BC 11,4E,0D6,1D,0E8,P.,F.,N8.
        BC 40,40,1D,60,T.,O.,40,S.,E.,N.,D.,40,L.,A.,R.,G.,E.,40
        BC L.,U.,4B,T.,N1.
        BC 40,P.,R.,I.,N.,T.
        XC 114F4A1DE8                                             
        BC P.,A.,N3.,40,40,1D,60,T.,O.,40,L.,O.,G.,O.,F.,F.,40,40,40,40
        XC 114FE61DE8                                       
        BC P.,F.,N9.,40,40,1D,60,F.,O.,R.,40,S.,C.,R.,E.,E.,N.,40,N1.,N4.
        XC 11505A1DE8                                   
        BC P.,F.,N1.,40,40,1D,60,F.,O.,R.,40,S.,C.,R.,E.,E.,N.,40,N0.,N6.
        XC 1150F61DE8                        
        BC P.,F.,N1.,N0.,40,1D,60,F.,O.,R.,40,N1.,40,P.,A.,G.,E.,40,L.,U. 
        BC 4B,T.,N1.,40,P.,R.,I.,N.,T.
        XC 11D16A1DE8                              
        BC P.,F.,N2.,40,40,1D,60,A.,U.,T.,O.,40,A.,L.,T.,E.,R.,4B,40,S.,C.
        BC R.,E.,E.,N.
        XC 11D2C61DE8                    
        BC P.,F.,N1.,N1.,40,1D,60,F.,O.,R.,40,N1.,40,L.,U.,4B,T.,N1.,40,W.
        BC 61,P.,A.,C.,I.,N.,G.
        XC 11D27A1DE8          
        BC P.,F.,N3.,40,40,1D,60,F.,O.,R.,40,S.,C.,R.,E.,E.,N.,40,N0.,N8.,40
        XC 11D3D61DE8                                              
APL1Z2  EQ $A252                 :INCLUDING 2 BYTE LENGTH FIELD AT BEGINNING
        BND 4
        IF BRBID
APLS03  XC 000040002C0000000000019020   :LAST ELEMENT IN CHAIN WITH CDI ON
        ELSE
APLS03  XC 000040002C0000000000019000   :CDI CAN'T BE ON IF EBI IS ON
        EI
        BC P.,F.,N1.,N2.,40,1D,60,E.,X.,T.,E.,R.,N.,A.,L.,40,D.,E.,F.,4B,40  
        BC S.,C.,R.,E.,E.,N.
        XC 11D44A1DE8                                        
        BC P.,F.,N4.,40,40,1D,60,A.,L.,T.,E.,R.,N.,A.,T.,E.,40,C.,R.,T.,50
        BC P.,R.,T.
        XC 11D4E61DE8                                           
        BC E.,N.,T.,E.,R.,1D,60,F.,O.,R.,40
        BC S.,C.,R.,E.,E.,N.,40,N1.,N8.,11,0D5,5A,1D,0E8                
        BC P.,F.,N5.,40,40,1D,60,P.,A.,C.,I.,N.,G.,40,R.,E.,Q.            
        BC 40,S.,C.,R.,E.,E.,N.
        XC 11D7F4                                 
        BC F.,O.,R.,40,S.,C.,R.,E.,E.,N.,S.,40,N0.,N6.,60,N1.,N8.,40
        BC Y.,O.,U.,40,C.,A.,N.,40,E.,N.,T.,E.,R.,40,S.,O.,M.,E.,40
        BC J.,U.,N.,K.,40,F.,I.,R.,S.,T.,7A,1D,40,13
APL1Z3  EQ $A177
        BND 4

        IF VTAMRF                     :IF GENNED FOR CMH
FMDUMY  XC 000040002C0000000000039020  :DUMMY RESPONSE WITH CDI SET FOR CMH
DUMLEN  EQ $A13                        :LENGTH

VTMLG1  XC 000040002C00000000000390A0  :TH & RH FOR VHR LOGON STRING1
        XC F1C1E3C5C3C8E2C5D9E57A      :<CMD><WCC>TECHSERV:
        XC F7F7F1F3                    :CMH HOST NUMBER 7713
        XC 5ED4D6E3C8C5D940D3D6C4C5    :<SEMI>MOTHER LODE
VTMLN1  EQ $A40

VTMLG2  XC 000040002C0000000000039020  :TH & RH VHR LOGON STRING2
        XC F1C1E3C5C3C8E2C5D9E57A      :<CMD><WCC>TECHSERV:
        XC F7F7F1F2                    :CMHE HOST NUMBER 7712
        XC 5ED4D6E3C8C5D940D3D6C4C5    :<SEMI>MOTHER LODE
VTMLN2  EQ $A40

VTMLG3  XC 000040002C0000000000039020  :TH & RH VHR LOGON STRING3 (DSP)
        XC F1C1F38D8D8D8D              :<CMD><WCC>3<CR><CR><CR><CR>
VTMLN3  EQ $A20

VTMLG4  XC 000040002C0000000000039020  :TH & RH VHR LOGON STRING4
        XC F1C1                        :<CMD><WCC>
VTMLN4  EQ $A15
        EI
        BND 4


:--- THIS IS SCREEN 6 WHICH IS REQUESTED WITH PF1 ---:

SCRN60   XC 000040002C0000000000039020    
         XC F5C31140401DE83CC66A40E8E4C2E8E4C2406040             :20 CHARS
         XC E2C3D9C9D7E340D2C5E8E6D6D9C4405C3CC94A40             :20 CHARS
         XC 3CC9617B3C4A5A407B404040404040E2C3D9C5C5             :20 CHARS
         XC D540F0F61D401340404040407B3C4B6A403C4CC1             :20 CHARS
         XC 7B
SCRZ60   EQ $A94
        BND 4



:------------------------------------------------------------------------

OFFSCN  XC 000040002C0000000000038020                     :13 CHARS
        XC F5C7114FD21D60D7C1F340D4C5C1D5E240D3D6C7D6C6C6 :23 CHARS
        XC 406040D7D9C5D7C1D9C540E3D640C2C51DE8E4D5C2D6E4 :23 CHARS
        XC D5C41D6013
OFFSCZ  EQ $A64

         BND 4
MANDAT   XC 000040002C0000000000039020
         XC F5C3114040F1F2F3F4F5F6F7F8
         BS $A200
MANDLN   EQ $A26

         BND 4
DACTPU   XC 000040002D00000000046B80001202
DACTPL   EQ $A15
         BND 4
MNACLU   XC 000040002D00000000006B80000D0201     :MANUAL ACTLU
MNACLN   EQ $A16                                 :LENGTH

SSCPDT   XC 000040002C0000000000038000          :SSCP DATA
         RE $A200
         BC 96                        :o
         ER
         IF PKTSIZ-$A512
         RE $A213
         BC 89
         ER
         EI
SSCPDL   EQ $A200+13
         IF PKTSIZ-$A512
SSCPDL   EQ SSCPDL*2
         EI




:----------------------------
: RU TYPE,LENGTH & ADDRESS TABLE

         BND 4
RUTABL   XC A00E0000                  :SDT
         XC 31280000                  :LU.T2 BIND
         XC 320F0000                  :UNBIND
         XC F51A0000                  :DATA (EXCEPTION RSP)
         IF PKTSIZ-$A512
         XC F7FA0000                  :LARGE RU
         ELSE
         XC 99000000                  :DON'T MATCH
         EI
         XC 81100000                  :+RSP TO NOTIFY
         XC 040E0000                  :+RSP TO LUSTAT
         XC A10E0000                  :CLEAR
         IF RSHUTD
         XC C20E0000                  :+RSP TO RSHUTD
         ELSE
         XC 01100000                  :+RSP TO TERMSELF
         EI
         XC 0D100000                  :ACTLU
         XC 0E0F0000                  :DACTLU
         XC 15820000                  :VTAM BANNER
         XC C00E0000                  :SHUTD
         XC C80E0000                  :BID
         XC C10E0000                  :+RSP TO SHUTC
         XC 770D0000                  :+RSP TO VTAM LOGON
         XC C9120000                  :SIG RQ
         XC F6D50000                  :SSCP DATA
         XC 41280000                  :LU.T1 BIND
         XC 43280000                  :LU.T3 BIND
         XC 78110000                  :-RSP TO FMD SSCP STUFF
         IF VTAMRF
         XC F4280000                  :VHR LOGON 1
         XC F3280000                  :VHR LOGON 2
         XC F2140000                  :VHR LOGON 3
         XC F10F0000                  :VHR LOGON 4
         EI (VTAMFR)
RUTLEN   EQ .
RUTLEN   EQ RUTLEN-RUTABL

:--- HELP FOR MANUAL ENTRY ---:
MANHL1   SC /"8A"8D  A0 - SDT                  31 - LU.T2 BIND/
MANH1A   SC /"8A"8D  41 - LU.T1 BIND           43 - LU.T3 BIND/
MANHL2   SC /"8A"8D  F5 - DATA                 32 - UNBIND/
MANHL3   SC /"8A"8D  81 - +RSP TO NOTIFY       04 - +RSP TO LUSTAT/
MANHL4   SC /"8A"8D  A1 - CLEAR                15 - VTAM BANNER/
MANHL5   SC /"8A"8D  C2 - +RSP TO RSHUTD       01 - +RSP TO TERMSELF/
MANHL6   SC /"8A"8D  0D - ACTLU                0E - DACTLU/
MANHL7   SC /"8A"8D  C0 - SHUTD                C8 - BID/
MANHL8   SC /"8A"8D  C1 - +RSP TO SHUTC        77 - +RSP TO VTAM LOGON/
MANHL9   SC /"8A"8D  C9 - SIG                  F6 - SSCP DATA/
MANHLA   SC /"8A"8D  F7 - BIG RU               78 - -RSP TO SSCP STUFF"8a"8d/
         IF VTAMRF
MANHLX   SC /"8A"8D  F4 - VHR LOGON 1          F3 - VHR LOGON 2/
MANHLY   SC /"8A"8D  F2 - VHR LOGON 3          F1 - VHR LOGON 4/
         EI


BUFWSR   XC 000040002C0000000000039020  :TELL USER WSFQR RCV'd FROM HOST
         XC F5C3114BE71D607B40D9C5C3C5C9E5C5C440C6F340  :21 CHARS
         XC C3C1D5D5C5C440D9C5E2D7D6D5E2C5407B13
BUFWSZ   EQ $A52




:--  ASCII TO EBCDIC CONVERSION TABLE

EBCONT  XC 00010203372D2E2F1605150B0C0D0E0F
        XC 10111200003D322618193F271C1D1E1F    :10-1F
        XC 405A7F7B5B6C507D4D5D5C4E6B604B61    :20-2F
        XC F0F1F2F3F4F5F6F7F8F97A5E4C7E6E6F    :30-3F
        XC 7CC1C2C3C4C5C6C7C8C9D1D2D3D4D5D6    :40-47
        XC D7D8D9E2E3E4E5E6E7E8E9C05FD04B6D    :50-5F
        XC 78818283848586878889919293949596    :60-6F
        XC 979899A2A3A4A5A6A7A8A9C0FAD0A14B    :70-7F

:---  ASCII-to-hex conversion (including lower case)  ---:
AXAXAX  XC FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF    :00-0F
        XC FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF    :10-1F
        XC FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF    :20-2F
        XC 00010203040506070809FFFFFFFFFFFF    :30-3F
        XC FF0A0B0C0D0E0FFFFFFFFFFFFFFFFFFF    :40-4F
        XC FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF    :50-5F
        XC FF0A0B0C0D0E0FFFFFFFFFFFFFFFFFFF    :60-6F
        XC FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF    :70-7F



::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::::                                                                    ::::
::::                 B  A  C  K  G  R  O  U  N  D                       ::::
::::                                                                    ::::
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

         REMARK %   genning BACKGROUND
         SEG A.CODE
START
         LIS R1,0
         LIS R0,0
         IF MULCHN                    :MULCHN=1 USE SEGMENTING
         RBT R0,BINDBF+12
         ELSE
         SBT R0,BINDBF+12             :USE MULTIPLE CHAINS
         EI
START2   STB R0,ZERSTR,R1
         AIS R1,1
         CHI R1,ZERLEN
         JL  START2
         LIS R1,0
START3   STB R0,BUFINT,R1,
         AIS R1,1
         CI  R1,BFSIZE
         JL  START3
         STH R0,WAITBT,,
         STH R0,RRARAY,,
         STH R0,GOTRR,,
         STH R0,RNRARY,,
         LHI R2,0F                    :INIT PUSTAT TO 0F
         LHI R3,0FE                   :INIT PUACT TO FE
         LIS R9,0
         LHI R1,NUMPU-1
START4   STB R0,PURRNR,R1
         STB R0,HIFRR,R1
         STB R0,EXPNS,R1
         STB R0,PURRNS,R1
         STB R0,RRTMOC,R1,
         STB R2,PUSTAT,R1
         STB R3,PUACT,R1
         STH R0,SNF,R1,R1
         SIS R1,1
         JGE START4
         LHI R1,NUMLU-1
START5   STB R0,LUSTAT,R1,
         STH R0,LUSNF,R1,R1
         STH R0,SNFLU,R1,R1
         SIS R1,1
         JGE START5
         LIS R7,0
START6   LB  R6,LU1T0,R7,            :IS THIS LU LU.T1?
         JEFS START7                 :NO
         SBT R7,LU1ARY,,
START7   LB  R6,LU3T0,R7,            :IS THIS LU LU.T3?
         JEFS START8                 :N0
         SBT R7,LU3ARY,,
START8   AIS R7,1
         CHI R7,NUMLU
         JL  START6
         LA  R0,STRFGN,,
         SVC SYS,1
         JAL R7,HSTNUM



:----------------------------------------------------------------------

CONPU    LIS R2,0            :PU INDEX
         LIS R3,0            :PU ASCII INDEX
CONPU2   LA  R8,HLDHEX,,     :TEMP STORAGE FOR CONVERTED ADDRESS
         LIS R9,1            :CONVERT TWO CHARACTERS
         LA  R10,PUTAB,R2    :BINHEX INPUT AREA
         JAL R4,BINHEX       :CONVERT HEX PU ADDRESS TO ASCII
         LH  R10,HLDHEX
         STH R10,PUTABA,R3
         AIS R2,1
         AIS R3,2
         CHI R2,NUMPU
         JL  CONPU2


CONLU    LIS R2,0
         LIS R3,0
CONLU2   LA  R8,HLDHEX
         LIS R9,1                     :CONVERT TWO CHARACTERS
         LA  R10,DAF,R2,
         JAL R4,BINHEX
         LH  R10,HLDHEX
         STH R10,LUTABA,R3
         AIS R2,1
         AIS R3,2
         CHI R2,NUMLU
         JL  CONLU2



::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE BUILDS THE SUPPORTED RU TABLE 

CRETRU   LA   R3,SDTBUF
         STH  R3,RUTABL+2
         LA   R3,MANBN2
         STH  R3,RUTABL+6
         LA   R3,MANUBN               :UNBIND
         STH  R3,RUTABL+0A
         LA   R3,MANDAT
         STH  R3,RUTABL+0E
         IF PKTSIZ-$A512
         LA   R3,BIGRU,, 
         ELSE
         LIS  R3,0
         EI
         STH  R3,RUTABL+12
         LA   R3,NTFBUF
         STH  R3,RUTABL+16
         LA   R3,STATRP               :+RSP TO LUSTAT
         STH  R3,RUTABL+1A
         LA   R3,CLERBF               :CLEAR
         STH  R3,RUTABL+1E
         IF   RSHUTD
         LA   R3,SHDRSP
         ELSE
         LA   R3,TRMSRP               :+RSP TO TERMSELF
         EI
         STH  R3,RUTABL+22
         LA   R3,MNACLU               :ACTLU
         STH  R3,RUTABL+26
         LA   R3,DALBUF               :DACTLU
         STH  R3,RUTABL+2A
         LA   R3,VTAMBN               :VTAM BANNER
         STH  R3,RUTABL+2E
         LA   R3,SHUTDR               :SHUTD
         STH  R3,RUTABL+32
         LA   R3,DFCBID
         STH  R3,RUTABL+36            :BID
         LA   R3,SHUTCR               :+RSP SHUTC
         STH  R3,RUTABL+3A
         LA   R3,FMDRSP               :+RSP TO VTAM LOGON
         STH  R3,RUTABL+3E
         LA   R3,SIGBUF               :SIG RQ
         STH  R3,RUTABL+42
         LA   R3,SSCPDT               :SSCP DATA
         STH  R3,RUTABL+46
         LA   R3,MANBN1               :LU.T1 BIND
         STH  R3,RUTABL+4A
         LA   R3,MANBN3
         STH  R3,RUTABL+4E
         LA   R3,FMDNRP               :-RSP TO FMD SSCP STUFF
         STH  R3,RUTABL+52
         IF VTAMRF
         LA   R3,VTMLG1
         STH  R3,RUTABL+RUTLEN-0E     :VHR LOGON STRING 1
         LA   R3,VTMLG2
         STH  R3,RUTABL+RUTLEN-0A
         LA   R3,VTMLG3               :VHR LOGON STRING 3
         STH  R3,RUTABL+RUTLEN-06
         LA   R3,VTMLG4
         STH  R3,RUTABL+RUTLEN-02
         EI (VTAMRF)



::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THRASH CHECKS THE IRING FOR DATA

THRASH   JAL R4,LOOK         :CHECK FOR MSG IN IRING
         J   REST2           :NO MSG IN RING
         JE  CNTMSG          :GO PROCESS CONTROL MSG
         CHI R2,0            :IS THIS MESSAGE A NEEDLE
         JE  GOTNDL          :GOT A NEEDLE
         J   NOTNDL


:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  MAIN BACKGROUND DISMISS AREA                                     :::

REST     LIS R2,0
         RBT R2,SUSPEND               :SUSPENDED OUTPUT?
         JE  THRASH                   :IF NOT THEN PROCESS INPUT
         LM  R6,DSPSAV                :OTHERWISE CONTINUE OUTPUT
         JR  R13                      :R13 CONTAINS CONTINUATION ADDRESS
REST2    LIS R2,0
         TBT R2,SKPLUP                :RESPONSE-TIME TESTING?
         JN  REST4                    :YES, SKIP THIS STUFF
         JAL R5,PROPBP                :PROCESS DATA FOR THE PU'S
         JAL R5,PROLBP                :PROCESS DATA FOR THE LUs
         LIS R2,0
         JAL R5,CKLUTM                :CHECK LU TIMERS
REST4    JAL R0,BGFGST
         L   R0,FASTC,,
         ST  R0,FASTC.
         L   R0,SLOWC,,
         ST  R0,SLOWC.
         SVC DISMIS
         J   REST   

:==========================================================================
: COME HERE IF WAITING FOR FOREGROUND TO SEND A FRAME

BAKWAT   SVC DISMIS
         STM R0,SAVALL                :SAVE EVERYTHING
         LHI R5,NUMPU-1
BAKWA4   LB  R6,PUSTAT,R5             :LOOKING FOR RR'R RECEIVED
         CHI R6,4                     :GOT ONE?
         JN  BAKWA6                   :NO
         LR  R7,R5
         SLLS R7,2
         L   R8,FASTC,,
         L   R4,PUTIM,R7              :GET THIS CLOCK
         SR  R8,R4
         CHI R8,RRTMO                 :TIME FOR ANOTHER RR?
         JL  BAKWA6                   :NO
         LIS R7,7                     :IF YES, CHANGE STATE TO 7
         STB R7,PUSTAT,R5
BAKWA6   SIS R5,1
         JGE BAKWA4                   :JUMP IF ANY LEFT
         LM  R0,SAVALL
         JR  R9



:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

GOTDAT   J   REST

GOTNDL   LH  R8,RPORT
         CHI R8,0
         JN  BOOTEM                   :GET RID OF THIS GUY CUZ PORT IN USE
         STH R1,RPORT
         JAL R4,GETH
         JAL R4,FLUSH                 :CHUCK REST OF NEEDLE
         LH  R2,RPORT
         LA  R3,SETECH                :TURN ON CONSAT ECHO
         JAL R5,OCM
         JAL R8,SNDBNR                :SEND "SNOST BANNER"
         JAL R8,HLPLST                :SEND LIST OF SNOST COMMANDS
         J   REST

:--------------------------------------------------------------------------
: THIS ROUTINE CLEARS RPORT WHEN OPERATOR CIRCUIT IS ZAPPED OR DETACHED

GOTZAP   LIS R2,0
         STH R2,RPORT                 :PUT HIM TO REST
         STH R2,HPORT
         J   REST

:--------------------------------------------------------------------------
: COME HERE IF THERE IS ALREADY AN OPERATOR LOGGED ON

BOOTEM   STH R1,HPORT
         LR  R2,R1
         LA  R3,BOOTMG                :SEND GET LOST MESSAGE
         JAL R5,OCS
         LH  R2,HPORT
         LA  R3,ZAPMSG
         JAL R5,OCM
         JAL R4,GETH
         JAL R4,FLUSH
         J   REST




:--------------------------------------------------------------------------
: THIS ROUTINE SENDS OUT THE GREETING MESSAGE TO THE OPERATOR

SNDBNR   HLPLIN(BNR1)
         HLPLIN(BNR2)
         HLPLIN(BNR3)
         HLPLIN(BNR4)
         HLPLIN(BNR5)
         HLPLIN(BNR4)
         HLPLIN(BNR6)
         JR  R8

:-------------------------------------------------------------------------
: THIS ROUTINE SENDS THE LIST OF COMMANDS TO THE OPERATOR

HLPLST   HLPLIN(HLP1)
         HLPLIN(HLP2)
         HLPLIN(HLPA)
         HLPLIN(HLPB)
         HLPLIN(HLPC)
         HLPLIN(HLPD)
         HLPLIN(HLPE)
         HLPLIN(HLPF)
         HLPLIN(HLPH)
         HLPLIN(HLPI)
         HLPLIN(HLPK)
         HLPLIN(HLPL)
         HLPLIN(HLPN)
         HLPLIN(HLPO)
         HLPLIN(HLPP)
         HLPLIN(HLPR)
         HLPLIN(HLPT)
         HLPLIN(HLPU)
         HLPLIN(HLPV)
         HLPLIN(HLPW)
         IF SPCSEQ
         HLPLIN(HLPX)
         EI
         HLPLIN(HLPY)
         HLPLIN(HLPZ)
         HLPLIN(PROMPT)
         JR  R8




:=========================================================================

CNTMSG   J   REST

:-----------------------------------------------------------------------

GOTORG   J   REST


:-----------------------------------------------------------------------
: INSERT STONKY'S "ISICOP" ROUTINE HERE
        MO  .,ISICOP

        SEG A.DATA

        GL  DOECHO,NOTNDL,CURIN,DETCH
ECHBUF  BS 50
DATLEN  HC 0
DOECHO  HS MAXCIR
CURIN   HC 0
ALEFT   HC 0
FINDED  HC 0
GRBALL  SC/"AA/
RDBALL  SC/"AB/
ORBALL  SC/"AD/
DETCH   SC/"9E/

        SEG A.CODE

NOTNDL  LIS R8,0
FINPOR  LH  R7,RPORT,R8
        CR  R7,R1
        JE  OPNING      : MATCHED RPORT
        AIS R8,2
        CHI R8,MAXCIR*2 : MORE RPORTS TO EXAMINE?
        JE  ADDPR       : NO RPORT MATCHED
        J   FINPOR      : FIND THAT PORT

ADDPR   LIS R8,0
TRYGIN  LH  R7,RPORT,R8 : FIND FIRST OPENING IN TABLE
        CHI R7,0        : BY LOOKING FOR ZERO
        JE  OPNING      : OPENING FOUND
        AIS R8,2
        CHI R8,MAXCIR*2
        JL  TRYGIN      : LOOK AGAIN
        CHI R2,9D       :DATA?
        JG  BADSTF      :NO
        JAL R4,GETCH    :GET LENGTH OF THIS ORPHANED JUNK
        JAL R4,FLUSH    :DESTROY IT
        J   REST        :FORGET ABOUT HIM
BADSTF  LB  R0,LENGTH,R2,  :GET LENGTH OF THIS BOY
        JAL R4,FLUSH       :HEAVE-HO
        J   REST

OPNING  STH R8,CURIN    : STORE INDEX
        STH R1,RPORT,R8 : STORE RPORT, POSSIBLY REPETITIVE
        CHI R2,$009D
        JG  NONDAT      : BIGGER THAN 9D ISIS
        LH  R7,INPTSW,R8
        JN  IMORG       : RETURN TO PHIL IF NOT 0
        JAL R4,GETCH    : BOOT THE ISIS DATA MSG LENGTH
        STH R0,DATLEN   : STORE LEN OF MESSAGE IN THERE

BOBUNG  LIS R8,1
        STH R8,ALEFT
BAGOFR  JAL R4,GETCH    : GET FIRST CHARACTER

KCS     EQ  1
        RE  $A26
        IF  \CTL|KCS|
         NHI  R0,7F          : AND OFF PARITY
         CHI  R0,CTL|KCS|
         JN   .+$A14
         LA   R13,CONT|KCS|,,  : LOAD REG WITH ADDRESS OF JUMP
         J    CONTRL
        EI
KCS     EQ  KCS+1
        ER

        J   HOP1         : NO CONTROL CHARACTERS FOUND NEEDED BY IMORG

: A CONTROL CHARACTER WAS FOUND IN THE REPEAT NEEDED BY IMORG

CONTRL  LIS R5,1
        STH R5,FINDED     : SET FINDED TO 1 CUZ WE FOUND CONTROL WE NEED
        LH  R8,ALEFT
        LH  R7,DATLEN
        SR  R7,R8
        JE  MORG         :LAST DATA OF MESSAGE WAS CONTROL NOW ELIR
        LR  R0,R7
        JAL R4,FLUSH      :DATA FOLLOWED CONTROL, SO THROW IT AWAY
        J   DPLUS

HOP1    STB R0,ECHBUF,R8
        LH  R8,ALEFT
        AIS R8,1
        STH R8,ALEFT
        LH  R7,DATLEN
        CR  R7,R8
        JGE BAGOFR
        JAL R4,ELIR

: ALL THE DATA HAS BEEN YANKED OUTTA THIS ISIS MESSAGE.  IF IT NEEDS TO
: BE ECHOED SHIP IT BACK

HOP2    LH  R8,CURIN
        LH  R7,DOECHO,R8
        JE  DPLUS       :WE HAVE TAKEN IN FULL ISIS DATA MSG.  NONE OF IT
                       :IS NEEDED BY PHIL OR NEEDS TO ECHOED OR IS CNTRL
        LH  R8,ALEFT   :GET LEN OF NECESSARY DATA
        SIS R8,1
        LIS R7,0
        STB R8,ECHBUF,R7   :STORE NEW VALUE IN ECHBUF FOR LEN
        LH  R8,CURIN       :GET INDEX
        LH  R2,RPORT,R8
        LA  R3,ECHBUF
        JAL R5,OCS
DPLUS   LH  R5,FINDED
        JE  REST           :CONTROL CHARS NOT FOUND
        LIS R5,0
        STH R5,FINDED
        JR  R13

MORG    JAL R4,ELIR
        J   DPLUS

: ALL NON DATA NON NEEDLES PASS THRU HERE.  AFTER PROCESSING THE MESSAGE
: IS FLUSHED AWAY.  UNKNOWN BALLS AND MESSAGE ARE FLUSHED BUT CAN BE ADDED.

NONDAT  CHI R2,$0 0AA              :GREEN?
        JE  GREENR
        CHI R2,$0 0AB              :RED?
        JE  REDRET
        CHI R2,$0 0AC              :YELLOW?
        JE  YELLA
        CHI R2,$0 0AD              :ORANGE?
        JE  ORANGA
        CHI R2,$0 0A6              :EDEM?
        JE  XEDEM
        CHI R2,$0 0A7              :LDEM?
        JE  XLDEM
        CHI R2,$0 9E               :DETACH?
        JE  ADETCH
        CHI R2,$0 9F               :A ZAP?
        JE  ADETCH
        CHI R2,$0 0AF              :HANG?
        JE  ADETCH
        LB  R0,LENGTH,R2,
        JAL R4,FLUSH
        J   REST

GREENR  LB  R0,LENGTH,R2,
        JAL R4,FLUSH
        LA  R3,GRBALL
        LH  R8,CURIN
        LH  R2,RPORT,R8
        JAL R5,OCM
        LHI R8,0          :BEFORE REST REMEMBER DON'T ECHO
        LH  R7,CURIN
        STH R8,DOECHO,R7
        J   REST

REDRET  LB  R0,LENGTH,R2, :RED FOUND AND SHIPPED
        JAL R4,FLUSH
        LA  R3,RDBALL
        LH  R8,CURIN
        LH  R2,RPORT,R8
        JAL R5,OCM
        LHI R8,1          :BEFORE WE REST REMEMBER TO ECHO
        LH  R7,CURIN
        STH R8,DOECHO,R7
        J   REST

YELLA   LB  R0,LENGTH,R2, :YELLOW FOUND ORANGE SHIPPED
        JAL R4,FLUSH
        LA  R3,ORBALL
        LH  R8,CURIN
        LH  R2,RPORT,R8
        JAL R5,OCM
        J   REST

ORANGA  LB  R0,LENGTH,R2,
        JAL R4,FLUSH
        J   GOTORG        :ALERT ORANGE BALL FOUND

XEDEM   LB  R0,LENGTH,R2,
        JAL R4,FLUSH
        LHI R8,1
        LH  R7,CURIN
        STH R8,DOECHO,R7     :MUST ECHO WHEN CONSAT DEFERS
        J   REST

XLDEM   LB  R0,LENGTH,R2,
        JAL R4,FLUSH
        LHI R8,0
        LH  R7,CURIN
        STH R8,DOECHO,R7     :CONSAT LEFT DO NOT ECHO
        J   REST

ADETCH  LB  R0,LENGTH,R2,
        JAL R4,FLUSH
        J   GOTZAP        :ZAP OR DETACH FOUND


        EM






:========================================================================
: THIS ROUTINE EXAMINES THE INPUT SWITCH (INPTSW) TO SEE WHICH ROUTINE
: TO JUMP TO.

IMORG   LHL R13,INPTSW                :GET INPUT SWITCH
        LHL R12,IMORGB,R13,R13        :GET ROUTINE TO EXECUTE
        J   FSEG,R12,

:*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*
:*#   IMORG BRANCH TABLE
IMORGB  HC REST-FSEG                  :00
        HC REST-FSEG                  :01
        HC REST-FSEG                  :02
        HC REST-FSEG                  :03
        IF NUMPU-1
        HC CONT50-FSEG                :04 GET PU NUMBER TO STOP PRINT JOB
        ELSE
        HC REST-FSEG                  :04
        EI
        HC REST-FSEG                  :05
        HC CONT51-FSEG                :06 GET LU NUMBER TO STOP PRINT JOB
        HC REST-FSEG                  :07
        HC DTRQNC-FSEG                :08 QUERY/CHANGE STATE OF DTR
        HC REST-FSEG                  :09
        HC REST-FSEG                  :0A
        HC REST-FSEG                  :0B
        HC C4FGD2-FSEG                :0C GO STEP THROUGH F.G. TRACE
        HC C4OUT0-FSEG                :0D SEND FRAME OUTSIDE WINDOW
        HC CNT467-FSEG                :0E CHANGE T1 TIMER PART II
        HC CNT463-FSEG                :0F CHANGE T1 TIMER
        HC INPTPU-FSEG                :10 ACTPU 
        HC CONTL2-FSEG                :11 GET PU FOR THIS LU (ACTLU)
        HC CONTL6-FSEG                :12 GET LU TO ACTIVATE 
        HC CONT92-FSEG                :13 INGORE UA
        HC CONT62-FSEG                :14 START POLLING
        HC CONT42-FSEG                :15 SEND DISC
        HC CONTB5-FSEG                :16 GET SECOND DIGIT OF LU FOR DACTLU
        HC CONTT7-FSEG                :17 INPUTTING TEST TO MAN SSCP DATA
        HC CONTB2-FSEG                :18 PU INPUT FOR DACTLU
        HC CONTB4-FSEG                :19 LU INPUT FOR DACTLU
        HC CONTT1-FSEG                :1A ASK ABOUT MAN SSCP OR LU          
        HC CONTT2-FSEG                :1B INPUTTING TEXT TO MAN DATA
        HC CONTY0-FSEG                :1C INPUT NEW MANDAT RH
        HC CONTN0-FSEG                :1D REL LU# FOR SNF
        HC CONTN3-FSEG                :1E GET NEW SNF
        HC CONTY5-FSEG                :1F LENGTH OF RH OF MANDAT
        HC CNT176-FSEG                :20 RESP TO "SEND TERM/SHUTD" QUESTION
        HC CNTYY0-FSEG                :21 INPUT NEW UNBIND REASON CODE
        HC CONTY8-FSEG                :22 LENGTH OF MANDAT RU
        HC CONTY2-FSEG                :23 ASK ABOUT CHANGING LENGTH OF SSCP OR LU RU
        HC CONTF2-FSEG                :24 REL LU FOR MANUAL
        HC CONTFA-FSEG                :25 ASK FOR MANUAL RU
        HC CONTFC-FSEG                :26 GOT 2nd CONT-O ASK FOR RU
        HC CNT162-FSEG                :27 ASK FOR REL LU TO BE TURNED OFF
        IF VTAMRF
        HC CONTN0-FSEG                :28 ASK FOR LU TO SET VTAUTO
        ELSE
        HC REST-FSEG                  :28
        EI
        HC CONTA0-FSEG                :29 ANSWER TO CONTINUOUS XIDs
        HC CONT46-FSEG                :2A ANSWER TO DISC OR ACTPU
        HC CONT20-FSEG                :2B PU NUMBER FOR TEST FRAME
        HC CONTYQ-FSEG                :2C CANT REMEMBER


:=========================================================================



:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::                                                                     :::
:::                  T A B L E   S E T U P   A R E A                    :::
:::                                                                     :::
::: THE TABLE SETUP AREA HAD TO BE MOVED FROM THE BEGINNING OF THE      :::
::: PROGRAM DUE TO ITS SIZE.  OTHERWISE RX3 INSTRUCTIONS WOULD BE       :::
::: REQUIRED IN SEVERAL PLACES.                                         :::
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

        REMARK %   genning TABLE SETUP area
        SEG A.DATA
        BND 2
PUTAB                                 :TABLE OF PU ADDRESSES
K       EQ 0
        RE NUMPU
PUT|K|  BC PU|K|
K       EQ K+1
        ER
        BND 2
PUTABA                                :PU TABLE OF ASCII ADDRESSES
        RE NUMPU
        HC 0
        ER

LUTABA                                :LU TABLE OF ASCII ADDRESSES
        RE NUMLU
        HC 0
        ER
        BND 2
PUSTAT
        RE NUMPU
        BC 0F 
        ER
RRTMOC  RE NUMPU                      :RR TIMEOUT COUNTER
        BC 0
        ER

        BND 2
PUTIM   WS NUMPU
TFRMTM  WS NUMPU                      :TEST FRAME TIMER
        BND 2
        BND 2
PURRNR
        RE NUMPU
        BC 0
        ER
HIFRR   RE NUMPU
        BC 0
        ER
EXPNS   RE NUMPU                      :NEXT EXPECTED N(S) IN RESPONSE TIME TEST
        BC 0
        ER
        BND 2
PURRNS  
        RE NUMPU
        BC 0
        ER
PURTN  
        RE NUMPU
        BC 0
        ER
PUACT
        RE NUMPU
        BC 0FE
        ER

        BND 2


HLDACL  
        RE $A14*NUMPU
        BC 0FF
        ER


K       EQ 0
Q       EQ 0
:--- THIS DAF IS FOR RESPONSE-TIME BLAST FRAMES
Q       EQ 2
DAFR    RE NUMPU
        RE 20
        BC Q
Q       EQ Q+1
        ER
Q       EQ 2
        ER

K       EQ 0
DAF     
        RE NUMPU
JJ      EQ LUADD|K|
        RE NMLUP|K|
        BC JJ
JJ      EQ JJ+1
        ER
K       EQ K+1
        ER
OAF     BC 0                          :OUR OAF IS 0
        BND 2
K       EQ 0
LUPRPU                                :"NUMBER OF LU'S PER PU" ARRAY
        RE NUMPU
        BC NMLUP|K|
K       EQ K+1
        ER
        BND 2
K       EQ 0
LUSTAT                                :LU STATE ARRAY
        RE NUMPU
        RE NMLUP|K|
        BC 0
        ER
K       EQ K+1
        ER
        BND 2
SNF
        RE NUMPU
        IF SYS38
        HC 0
        ELSE
        HC 0ABFB                      :START NUMBERING AT 0BFB
        EI (SYS38)
        ER
:--- THIS SNF IS FOR RESPONSE-TIME BLASTINE
LUSNFR   RE NUMPU
         RE 20
         HC 0
         ER
         ER

LUSNF 
        RE NUMLU
        HC 1
        ER
SNFLU
        RE NUMLU
        HC 0
        ER
LUACT   XC 000040002D00000000006B80000D0201   :ACTIVATE LU COMMAND
LUACTL  EQ $A16
        BND 2



         SEG A.DATA
         BND 2
K        EQ 0
PUADLU                                :PU ADDRESSES PER LU
        RE NUMPU
        RE NMLUP|K|
        BC PU|K|
        ER
K       EQ K+1
        ER

        SEG 3
        BND 2
        BND 2
XMTPIX  BS NUMPU                      :NUMBER OF NEXT BUFFER TO USE
        BND 2
XMTNPW  BS NUMPU                      :NUMBER OF UNACKNOWLEDGED PACKETS
        BND 2
LUDFRS  BS NUMLU                      :THE "DEFINITE RESPONSE REQUIRED" ARRAY
        SEG A.DATA
        BND 2
LUTIME  WS NUMLU                      :TIMER ARRAY FOR LU'S

RRARAY  HC 0                          :RECEIVER READY FLAG ARRAY
GOTRR   HC 0                          :SET WHEN DATA SENT, RESET WHEN RR RCVD
DATSNT  hc 0
RNRARY  HC 0                          :RECEIVER NOT READY ARRAY
WAITBT  HC 0                          :WHEN SET MEANS DON'T WRITE TO IOUT0


:-----------------   S I O    A R E A   ------------------
        SEG 0D

         BND 10
SIOSTR
OUTBUF   HS  40
         BND 10
DTRMIP   WC  0,0,0,0
         BND 10
:--- RR trailer frame
OUTRR    HS  10

:-- OUTPUT BUFFER FOR I-FRAMES  --
         BND 10
:IFSIZE   EQ  90                       :BUFFER SIZE FOR I-FRAMES
IOUT0    HS  IFSIZE
IOUT1    HS  IFSIZE
IOUT2    HS  IFSIZE
IOUT3    HS  IFSIZE
IOUT4    HS  IFSIZE
IOUT5    HS  IFSIZE
IOUT6    HS  IFSIZE
IOUT7    HS  IFSIZE
IOUT8    HS  IFSIZE

:--  SETUP CHANNEL COMMAND PROGRAM  --

         BND 100
SETUP    WC  30018
         WC  31420
         WC  31100
         WC  303D8
         WC  305EB
         WC  3877E
         WC  313D9
         WC  0
         BND 10
:--  DTR MANIPULATION COMMANDS  --:
DTRUCM   WC 305E2,0,0,0
DTRDCM   WC 30560,0,0,0

:--  OUTPUT CHANNEL COMMAND PROGRAM  --

         BND 10
SIOOUT   HC  8,OUTBUF/10,0,0,0,0,0,0
         HC  0,0,0,0,0,0,0,0
         HC  0,0,0,0,0,0,0,0
         HC  0,0,0,0,0,0,0,0
         HC  0,0,0,0,0,0,0,0
         HC  0,0,0,0,0,0,0,0
         HC  0,0,0,0,0,0,0,0
:--  I-FRAME ROTOR LIST  --
         BND 100
SIOCHN   HC  0,IOUT0/10,0,(SIOCHN+10)/10,0,0,0,0
         HC  0,IOUT1/10,0,(SIOCHN+20)/10,0,0,0,0
         HC  0,IOUT2/10,0,(SIOCHN+30)/10,0,0,0,0
         HC  0,IOUT3/10,0,(SIOCHN+40)/10,0,0,0,0
         HC  0,IOUT4/10,0,(SIOCHN+50)/10,0,0,0,0
         HC  0,IOUT5/10,0,(SIOCHN+60)/10,0,0,0,0
         HC  0,IOUT6/10,0,(SIOCHN+70)/10,0,0,0,0
         HC  0,IOUT7/10,0,SIOCHN/10,0,0,0,0
    
:--  INPUT CHANNEL COMMAND PROGRAM  --

         BND 10
SIOIN    HC  3,IBUFSZ/2
         HC  5,PKTSIZ/2+2
         HC  1,INBUF/10

:--  SIO STATUS AREA  --

         BND 10
SIOSTS   BS  STSSIZ

:--  SIO INPUT BUFFER  --

         BND 10
INBUF    BS  IBUFSZ

:--  SIO END  --

         BND 10
SIOEND   EQ  .

:--------------------  E N D   O F   S I O   A R E A  ---------------

         SEG 4
:""" THIS AREA IS USED TO PASS FRAMES FROM B.G. TO F.G. """:

Q        EQ 0
SQ       EQ 4                         :start with seg 4
         RE NUMPU
         SEG SQ
SIOBF|Q| HS IFSIZE*PUSTRG             :CAN STORE 20d FRAMES
Q        EQ Q+1
SQ       EQ SQ+1                      :one PU per SEG
         ER
         SEG 4                        :all this junk goes in SEG 4
Q        EQ 0
SIOBBF   RE NUMPU                     :SEG address array for each PU
         WC SIOBF|Q|
Q        EQ Q+1
         ER
SIOHL0   EQ 0
FOLDYT   EQ IFSIZE*2*PUSTRG           :END OF ONE PU`s BUFFER
LEADIX   HS NUMPU
TRAILX   HS NUMPU
FGIX     RE NUMPU
         HC FOLDYT-(IFSIZE*2)
         ER

         SEG A.DATA


:-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-
: THIS IS RESPONSE TIME TESTING DEFINITION 
: AREA
TESTFM  XC 000040F3                   :SDLC TEST FRAME
        XC 00000000                   :RESPONSE TIME STAMP
        RE $A84
        BC 0E8,0E4,0C2                :YUB
        ER
        IF \TESTFL
TESTFL  EQ TESTFL+4
        ELSE
TESTFL  EQ $A200+4
        EI

:---THESE ARE THE RESPONSE TIME TEST FRAMES---:

RTFR10   XC 00004000280000140000039020
         XC F5C21140401D60
         BC 01
         RE RTFR1L-0C
         BC 0C1
         ER
YUBBER   EQ .
:RTFR1L   EQ $A252
         ORG RTFR10
         HC RTFR1L
         ORG YUBBER
RTFR2L   EQ RTFR1L-2
         BND 2
RTFR20   XC 00004000200000140000
         RE 0A
         BC 0C2
         ER 
         BC 02
         RE RTFR2L-0A  
         BC 0C2
         ER
YUBBER   EQ .
:RTFR2L   EQ $A250
         ORG RTFR20
         HC RTFR2L
         ORG YUBBER
         BND 2
RTFR30   XC 00004000200000140000
         RE 0A
         BC 0C3
         ER
         BC 03
         RE RTFR2L-0A
         BC 0C3
         ER
YUBBER   EQ .
RTFR3L   EQ $A250
         ORG RTFR30
         HC RTFR2L
         ORG YUBBER
         BND 2
RTFR40   XC 00004000200000140000
         RE 0A
         BC 0C4
         ER
         BC 04
         RE RTFR2L-0A
         BC 0C4
         ER
YUBBER   EQ .
RTFR4L   EQ $A250
         ORG RTFR40
         HC RTFR2L
         ORG YUBBER
         BND 2
RTFR50   XC 00004000200000140000
         RE 0A
         BC 0C5
         ER
         BC 05
         RE RTFR2L-0A
         BC 0C5
         ER
YUBBER   EQ .
RTFR5L   EQ $A250
         ORG RTFR50
         HC RTFR2L
         ORG YUBBER
         BND 2
RTFR60   XC 00004000240000140000
         RE 0A
         BC 0C6
         ER
         BC 06
         RE RTFR2L-0A
         BC 0C6
         ER
YUBBER   EQ .
RTFR6L   EQ $A250
         ORG RTFR60
         HC RTFR2L
         ORG YUBBER
         BND 2
RTFLEN   EQ RTFR1L+0A



::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::   S C R E E N   D E F I N I T I O N                                :::
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:----- IF SCREEN 2 IS NOT DEFINED BY USER, USE THIS ONE -----:
        IF \SCRN20
        ELSE
SCRN20  XC 000040002C0000000000039020
        XC F1C311C27C1DE8E240C340D940C540C540D5404040E3  :22 CHARS
        XC 40E640D611C5D51D60E3C8C9E240E2C3D9C5C5D540C3  :22 CHARS
        XC D6D4C5E240C1C6E3C5D940C140F540E2C5C3D6D5C440  :22 CHARS
        XC C4C5D3C1E8114BF61D4013
SCRN2Z  EQ $A90
        EI
        BND 4
SCR120  XC 000040002C0000000000039020
        XC F5C311C5C81DE85C5C5C1D60D7D9C9D5E3C5D940   :20 CHARS
        XC C9E240D9C5C1C4E840C1D5C440E6C9D3D340D9C5   :20 CHARS
        XC C3C5C9E5C540C4C1E3C140C9D540F540E2C5C3D6   :20 CHARS
        XC D5C4E2401DE85C5C5C1D6013
SCRZ12  EQ $A85
        BND 4

:------  this is used to unlock the keyboard on the CRT after print  ------:
UNLKBD  XC 000040002C0000000000039020
        XC F1C3
UNLKBL  EQ $A15



:--------------  SCREEN 3  --------------:

SCRN30   XC 00000000280000000000029000                    :TH & RH
         XC F5C31140401D40404040404040404040404040404040404040  :25 CHARS
         XC 40404040404040404040404040404040404040404040404040  :25 CHARS
         XC 40404040404040404040404040404040404040404040404040  :25 CHARS
         XC 40404040404040404040404040404040404040404040404040  :25 CHARS
         XC 40E3C8C540D9C5E2E340D6C640E3C8C540E2C3D9C5C5D540E6  :25 CHARS
         XC C9D3D340E3C1D2C540C140C6CEE640E2C5C3D6D5C4E2404040  :25 CHARS
         XC 40404040404040404040404040404040404040404040404040  :25 CHARS
         XC 40F1F2F3F4F5F6F7F8F9F0F9F8F7F6F5F4F3F2F1F0C1C2C3C4  :25 CHARS
SCRZ30   EQ $A213
         IF \SCN3TM
         ELSE
SCN3TM   EQ  $A5000                   :WAIT 2 SECONDS TO SEND LAST PART SCN3
         EI
         BND 4
SCRN31   XC 00004000200000000000                                :TH ONLY
         XC 7E7E7E7E7E404040E9E9E9E9E9E9E9E9E9E9E9E9E9E9E9E9E9  :25 CHARS
         XC E8E8E8E8E8E8E8E8E8E8E8E8E8E8E8E8E8E8E8E8E8E8E8E8E8  :25 CHARS
         XC E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7  :25 CHARS
         XC E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7  :25 CHARS
         XC E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7  :25 CHARS
         XC E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7  :25 CHARS
         XC E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7  :25 CHARS
         XC E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7  :25 CHARS
SCRZ31   EQ $A210
         BND 4
SCRN32   XC 00004000240000000000                                :TH ONLY
         XC 7B7B7B7B7B7B7B7B7B7B404040404040404040404040404040  :25 CHARS
         XC C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8  :25 CHARS
         XC C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8  :25 CHARS
         XC C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8  :25 CHARS
         XC C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8  :25 CHARS
         XC C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8C8  :25 CHARS
SCRZ32   EQ $A160
         BND 4
SCRN33   XC 000040002C0000000000019020
         XC 40404040404040404040404040404040404040404040404040  :25
         XC D3C1E2E340D7C1D9E340D6C640E2C3D9C5C5D5404040404040  :25 CHARS
         XC 40404040404040404040404040404040404040404040404040  :25 CHARS
         XC 405C5C5C5C5C5C5C5C5C5C5C5C5C5C5C5C5C5C5C5C5C5C5C40  :25 CHARS
SCRZ33   EQ $A113
         BND 4


:ooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo
:ooo   SCREEN 04 - ACCESSED BY PA2                                   ooo
:ooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo

SCRN40   XC 00004000280000000000029100
         XC F1C31140401DE8
         BC T.,H.,I.,S.,40,I.,S.,40,S.,C.,R.,E.,E.,N.,40,N0.,N4.
         XC 11C150                    :R2, C1
         RE $A72
         BC 5B                        :$
         ER
SCRL40   EQ $A112

:--- THIS PART OF SCREEN 4 IS SENT AFTER RESPONSE TO PACING REQ
SCRN41   XC 00004000200000000000         :10 BYTES
         XC 11C3F0                    :row 4 column 1
         BC S.,E.,G.,M.,E.,N.,T.,40,N.,U.,M.,B.,E.,R.,40,N0.,N2.
         XC 11C540                    :row 5 coulum 1
         RE $A73
         BC 4E                        :+
         ER
SCRL41   EQ $A106

:------  THIS PART OF SCREEN 4 IS SENT WITH THE ONE ABOVE
SCRN42   XC 00004000200000000000         :10 bytes
         XC 11C760                    :row 7 column 1
         BC S.,E.,G.,M.,E.,N.,T.,40,N.,U.,M.,B.,E.,R.,40,N0.,N3.
         XC 11C8F0                    :row 8 column 1
         RE $A74
         BC 5C                        :*
         ER
SCRL42   EQ $A107

:------  THIS PART OF SCREEN 4 IS SENT WITH THE ONE ABOVE
SCRN43   XC 00004000240000000000      :10 bytes
         XC 114B50                    :row 10 column 1
         BC L.,A.,S.,T.,40,S.,E.,G.,M.,E.,N.,T.,40,O.,F.,40,N1.,S.,T.
         BC 40,C.,H.,A.,I.,N.
         XC 114C60                    :row 11 column 1
         RE $A75
         BC 4B                        :.
         ER
SCRL43   EQ $A116

:------  THIS PART OF SCREEN 4 IS SENT WITH THE ONE ABOVE (PACING REQ IN HERE)
SCRN44   XC 00004000280000000000019120   :1st seg., end chain, pacing req
         XC 114F40                    :row 13, column 1
         BC N1.,S.,T.,40,S.,E.,G.,M.,E.,N.,T.,40,L.,A.,S.,T.,40,C.,H.,A.,I.,N.
         BC 40,A.,N.,D.,40,P.,A.,C.,I.,N.,G.,40,R.,E.,Q.,U.,E.,S.,T.
         XC 115050                    :row 14, column 1
         RE $A76
         BC 60                        :-
         ER
SCRL44   EQ $A136

:------  THIS IS THE LAST PART OF SCREEN 4 SENT AFTER +RSP TO PACING REQ
SCRN45   XC 00004000240000000000      :10 bytes, last segment of last chain
         XC 11D2F0                    :row 16, column 1
         BC L.,A.,S.,T.,40,S.,E.,G.,M.,E.,N.,T.,40,O.,F.,40,L.,A.,S.,T.,40
         BC C.,H.,A.,I.,N.
         XC 11D440                    :row 17, column 1
         RE $A77
         BC 6F                        :?
         ER
         XC 11D7F41D4013              :row 20, column 5 insert cursor
SCRL45   EQ $A125

:+=+=+=+=+=+=+=+=+=+=+=+=+=+ END OF SCREEN 04 +=+=+=+=+=+=+=+=+=+=+=+=+=+



ERSC01  XC 000040002C0000000000039020
        XC F5C311C8C31DE8C5D9D9D6D95A11C9C81D60D9C5  :20 CHARS
        XC D8E4C5E2E3C5C440E2C3D9C5C5D540D5D6E340C4  :20 CHARS
        XC C5C6C9D5C5C4
ERSCZ1  EQ $A59
        BND 4
ERSC02  XC 000040002C0000000000039020
        XC F5C311C5E31DE8C5D9D9D6D95A11C77C1D60D5D6  :20 CHARS
        XC 40D7D9C9D5E3C5D940C3D6D5C6C9C7E4D9C5C413  :20 CHARS
ERSCZ2  EQ $A53
        BND 4
ERSC03  XC 000040002C0000000000039020       :PRINTER NOT LOGGED ON
        XC F5C311C5E31DE8C5D9D9D6D95A11C77C1D60D7D9  :20 CHARS
        XC C9D5E3C5D940D5D6E340D3D6C7C7C5C440C9D513  :20 CHARS
ERSCZ3  EQ $A53
        BND 4
PRINT1  XC 000040002C0000000000039080      :PRINT RECORD 1
        XC 1540404040C1C1C1C1C1C1C1C1C1C1C1C1C1C1C1  :20 CHARS
        XC 15C2C2C2C2C2C2C2C2C2C2C2C2C2C2C2C2C2C2C2
        XC 157B7B7B7B7B7B7B7B7B7B7B7B7B7B7B7B7B7B7B
        XC E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7E7
        XC E8E8E8E8E8E8E8E8E8E8E8E8E8E8E8E8E8E8E8E8
        XC 15E9E9E9E9E9E9E9E9E9E9E9E9E9E9E9E9E9E9E9
        XC 15D6D6D6D6D6D6D6D6D6D6D6D6D6D6D6D6D6D6D6
        XC D8D8D8D8D8D8D8D8D8D8D8D8D8D8D8D8D8D8D8D8
        XC 15F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0
        XC 15F8F8F8F8F8F8F8F8F8F8F8F8F8F8F8F8F8F8F8
        XC 15
        IF \PRNTZ1
        ELSE
PRNTZ1  EQ $A214
        EI
        BND 4
ENDPMG  XC 000040002C0000000000039020         :END OF PRINT MESSAGE
        XC F5C311C5D51DE85B5B5B1D60E3C8C540D7D9C9D5  :20 CHARS
        XC E340D1D6C240C8C1E240C6C9D5C9E2C8C5C41DE8  :20 CHARS
        XC 5B5B5B1D6013
ENDPMZ  EQ $A59

        BND 4
P3BC    XC 000040002C000000000002B000    :BEGIN CHAIN
P3BCLN  EQ $A13
        BND 4
PRNT30  XC 0000400028000000000000B000    :FIRST PRINT LINE
        RE $A77
        BC 0C1
        ER
        BC 0F0,0F0,0F1,15
        RE $A77
        BC 0C2
        ER
        BC 0F0,0F0,0F2,15
        RE $A77
        BC 0C3
        ER
        BC 0F0,0F0,0F3,15
        RE $A13
        BC 0C4
        ER
PRNT31  XC 00004000200000000000
        RE $A64
        BC 0C4
        ER
        BC 0F0,0F0,0F4,15
        RE $A77
        BC 0C5
        ER
        BC 0F0,0F0,0F5,15
        RE $A77
        BC 0C6
        ER 
        BC 0F0,0F0,0F6,15
        RE $A26
        BC 0C7
        ER
PRNT32  XC 00004000200000000000
        RE $A51
        BC 0C7
        ER
        BC 0F0,0F0,0F7,15
        RE $A77
        BC 0C8
        ER
        BC 0F0,0F0,0F8,15
        RE $A77
        BC 0C9
        ER
        BC 0F0,0F0,0F9,15
        RE $A39
        BC 0D1
        ER
PRNT33  XC 00004000240000000000
        RE $A38
        BC 0D1
        ER
        BC 0F0,0F1,0F0,15
        RE $A77
        BC 0D2
        ER
        BC 0F0,0F1,0F1,15
        RE $A77
        BC 0D3
        ER
        BC 0F0,0F1,0F2,15
        RE $A52
        BC 0D4
        ER
PRNT04  XC 0000400028000000000000B000
        RE $A25
        BC 0D4
        ER
        BC 0F0,0F1,0F3,15
        RE $A77
        BC 0D5
        ER
        BC 0F0,0F1,0F4,15
        RE $A77
        BC 0D6
        ER
        BC 0F0,0F1,0F5,15
        RE $A65
        BC 0D7
        ER
PRNT05  XC 00004000200000000000
        RE $A12
        BC 0D7
        ER
        BC 0F0,0F1,0F6,15
        RE $A77
        BC 0D8
        ER
        BC 0F0,0F1,0F7,15
        RE $A77
        BC 0D9
        ER
        BC 0F0,0F1,0F8,15
        RE $A77
        BC 0E2
        ER
        BC 0F0
PRNT06  XC 00004000200000000000
        BC 0F1,0F9,15
        RE $A77
        BC 0E3
        ER
        BC 0F0,0F2,0F0,15
        RE $A77
        BC 0E4
        ER
        BC 0F0,0F2,0F1,15
        RE $A77
        BC 0E5
        ER
        BC 0F0,0F2,0F2,15
        RE $A10
        BC 0E6
        ER
PRNT07  XC 00004000240000000000
        RE $A67
        BC 0E6
        ER
        BC 0F0,0F2,0F3,15
        RE $A77
        BC 0E7
        ER
        BC 0F0,0F2,0F4,15
        RE $A77
        BC 0E8
        ER
        BC 0F0,0F2,0F5,15
        RE $A23
        BC 0E9
        ER
PRNT08  XC 0000400028000000000000B000
        RE $A54
        BC 0E9
        ER
        BC 0F0,0F2,0F6,15
        RE $A77
        BC 7B
        ER
        BC 0F0,0F2,0F7,15
        RE $A77
        BC 7C
        ER
        BC 0F0,0F2,0F8,15
        RE $A36
        BC 7E
        ER
PRNT09  XC 00004000200000000000
        RE $A41
        BC 7E
        ER
        BC 0F0,0F2,0F9,15
        RE $A77
        BC 5B
        ER
        BC 0F0,0F3,0F0,15
        RE $A77
        BC 5C
        ER
        BC 0F0,0F3,0F1,15
        RE $A49
        BC 50
        ER
PRNT10  XC 00004000200000000000
        RE $A28
        BC 50
        ER
        BC 0F0,0F3,0F2,15
        RE $A77
        BC 6C
        ER
        BC 0F0,0F3,0F3,15
        RE $A77
        BC 5A
        ER
        BC 0F0,0F3,0F4,15
        RE $A62
        BC 4E
        ER
PRNT11  XC 00004000240000000000
        RE $A15
        BC 4E
        ER
        BC 0F0,0F3,0F5,15
        RE $A77
        BC 4B
        ER
        BC 0F0,0F3,0F6,15
        RE $A77
        BC 6F
        ER
        BC 0F0,0F3,0F7,15
        RE $A75
        BC 0C1
        ER
PRNT12  XC 0000400028000000000000B000
        BC 0C1,0C1,0F0,0F3,0F8,15
        RE $A77
        BC 0C2
        ER
        BC 0F0,0F3,0F9,15
        RE $A77
        BC 0C3
        ER
        BC 0F0,0F4,0F0,15
        RE $A77
        BC 0C4
        ER
        BC 0F0,0F4,0F1,15
        RE $A7
        BC 0C5
        ER
PRNT13  XC 00004000200000000000
        RE $A70
        BC 0C5
        ER
        BC 0F0,0F4,0F2,15
        RE $A77
        BC 0C6
        ER
        BC 0F0,0F4,0F3,15
        RE $A77
        BC 0C7
        ER
        BC 0F0,0F4,0F4,15
        RE $A20
        BC 0C8
        ER
PRNT14  XC 00004000200000000000
        RE $A57
        BC 0C8
        ER
        BC 0F0,0F4,0F5,15
        RE $A77
        BC 0C9
        ER
        BC 0F0,0F4,0F6,15
        RE $A77
        BC 0D1
        ER
        BC 0F0,0F4,0F7,15
        RE $A33
        BC 0D2
        ER
PRNT15  XC 00004000240000000000
        RE $A44
        BC 0D2
        ER
        BC 0F0,0F4,0F8,15
        RE $A77
        BC 0D3
        ER
        BC 0F0,0F4,0F9,15
        RE $A77
        BC 0D4
        ER
        BC 0F0,0F5,0F0,15
        RE $A46
        BC 0D5
        ER
PRNT16  XC 0000400028000000000000B000
        RE $A31
        BC 0D5
        ER
        BC 0F0,0F5,0F1,15
        RE $A34
        BC 0D6
        ER
PRNT6A  XC 00004000200000000000
        BC 0D
PRNT6B  XC 00004000200000000000
        RE $A34
        BC 40
        ER
        RE $A43
        BC 0D6
        ER
        BC 0F0,0F5,0F2,15
        RE $A77
        BC 0D7
        ER
        BC 0F0,0F5,0F3,15
        RE $A24
        BC 0D8
        ER
PRNT17  XC 00004000240000000000
        RE $A53
        BC 0D8
        ER
        BC 0F0,0F5,0F4,15
        RE $A77
        BC 0D9
        ER
        BC 0F0,0F5,0F5,15
        RE $A77
        BC 0E2
        ER
        BC 0F0,0F5,0F6,15
        RE $A37
        BC 0E3
        ER
PRNT18  XC 0000400028000000000001A000
        RE $A40
        BC 0E4
        ER
        BC 0F0,0F5,0F7,15
        RE $A77
        BC 0E4
        ER
        BC 0F0,0F5,0F8,15
        RE $A77
        BC 0E5
        ER
        BC 0F0,0F5,0F9,15
        RE $A50
        BC 0E6
        ER
PRNT19  XC 00004000240000000000
        RE $A27
        BC 0E6
        ER
        BC 0F0,0F6,0F0,15
        RE $A77
        BC 0E7
        ER
        BC 0F0,0F6,0F1,0C,0D,0D
        BND 4



:----- this is Screen 7 for CMT stress testing -----:

SCRN70   XC 000040002C0000000000029000                :13
         XC F5C31140401DE8                            :7
         RE 8
         BC L.,I.,N.,E.,40,N0.,N1.,40                 :64
         ER
         BC 3C,0C1,0D4,40                             :4 (RTA 02,05 SPACE)
         BC 11,0C1,0D5,1D,60                          :5 (SBA 02,06)
         RE 8
         BC L.,I.,N.,E.,40,N0.,N2.,40                 :64
         ER
         BC 3C,0C2,0E6,4C                             :4 (RTA 03,07 <)
         BC 11,0C2,0E7,1D,0E8                         :5 (SBA 03,08)
         RE 8
         BC L.,I.,N.,E.,40,N0.,N3.,40                 :64
         ER
         BC 3C,0C3,0F7,6C                             :4 (RTA 04,08 %)
         BC 11,0C3,0F8,1D,60                          :5 (SBA 04,09)
         RE $A13
         BC 40                                        :13
         ER                                           :---
SCRL70   EQ $A252                                     :252

SCRN71   XC 000040002C0000000000009000                :13
         RE 6
         BC L.,I.,N.,E.,40,N0.,N4.,40                 :48
         ER
         BC 3C,0C5,0C3,4B                             :4 (RTA 05,04 .)
         BC 11,0C5,0C4,1D,0E8                         :5 (SBA 05,05)
         RE 8
         BC L.,I.,N.,E.,40,N0.,N5.,40                 :64
         ER
         BC 3C,0C6,0D5,7B                             :4 (RTA 06,06 #)
         BC 11,0C6,0D6,1D,60                          :5 (SBA 06,07)
         RE 8
         BC L.,I.,N.,E.,40,N0.,N6.,40                 :64
         ER
         BC 3C,0C8,0C6,6F                             :4 (RTA 07,39 ?)
         RE $A41
         BC 5B                                        :41 ($)
         ER                                           :---
SCRL71   EQ $A252                                     :252

SCRN72   XC 000040002C0000000000009000                :13
         RE 8
         BC 40                                        :8
         ER
         RE 8
         BC L.,I.,N.,E.,40,N0.,N8.,40                 :64 
         ER
         BC 3C,4A,0C9,5A,1D,0E8                       :6 (RTA 09,10 !)
         RE 8
         BC L.,I.,N.,E.,40,N0.,N9.,40                 :64
         ER
         BC 3C,4B,0D2,40,1D,60                        :6 (RTA 10,03)
         RE 8
         BC L.,I.,N.,E.,40,N1.,N0.,40                 :64
         ER
         RE $A12
         BC 40                                        :12
         ER
         RE $A15
         BC 4E                                        :15 (+)
         ER                                           :---
SCRL72   EQ $A252                                     :252

SCRN73   XC 000040002C000000000001A020                :13
         BC 40,40,L.,I.,N.,E.,40,N1.,N1.,40,40        :11
         RE $A54
         BC 60                                        :54 (-)
         ER
         BC 3C,50,50,5C,1D,0E8                        :6 (RTA 14,01 *)
         RE 8
         BC L.,I.,N.,E.,40,N1.,N4.,40                 :64
         ER
         RE $A17
         BC 40                                        :17
         ER
         RE 8
         BC L.,I.,N.,E.,40,N1.,N5.,40                 :64
         ER
         RE $A16
         BC 7A                                :16 (:)
         ER                                   
         BC D.,O.,N.,E.,1D,40,13              :7            
                                                :---
SCRL73   EQ $A252                                     :252


:-------   SCREEN 8 FOR CMT STRESS TESTING  -------:

SCRN80   XC 000040002C0000000000029000          :13
         XC F5C3115C6D1DE8114040                :10
         RE $A40
         BC 4D,5D
         ER                                   :80
         BC 4D,5D,4D,5D                       :4
         BC 3C,0C2,5C,40
         RE 4
         BC 4D,5D         
         ER
         BC 3C,0C3,6C,40
         RE $A42
         BC 4D,5D
         ER
         BC 3C,0C6,6D,40,1D,60
         BC E.,R.,A.,S.,E.,40,W.,R.,I.,T.,E.,40
         BC S.,C.,R.,E.,E.,N.
         RE $A21
         BC 40
         ER
SCRL80   EQ $A252

SCRN81   XC 000040002C0000000000009000     :13
         BC 3C,0C8,6F,40,1D,0E8            :6
         RE $A42
         BC 4C,6E                          :84
         ER
         BC 3C,4B,4C,40                    :4
         RE 4
         BC 4C,6E                          :8
         ER
         BC 3C,4C,5C,40                    :4
         RE $A42
         BC 4C,6E                          :84
         ER
         BC 3C,4F,5E,40,1D,60              :6
         BC C.,M.,T.,40,W.,O.,N.,7D,T.,40  :10
         BC C.,H.,O.,K.,E.,5A              :6
         RE $A27
         BC 40
         ER
SCRL81   EQ $A252

SCRN82   XC 000040002C0000000000009000
         BC 3C,0D1,5F,40,1D,0E8
         RE $A20
         XC F1F2F3F4F5F6F7F8 
         ER
         BC 3C,0D5,4E,40,1D,60
         RE $A34
         BC 40
         ER
         BC F.,R.,A.,M.,E.,40,N3.,40
         BC O.,F.,40,N4.
         RE $A21
         BC 40
         ER
SCRL82   EQ $A252

SCRN83   XC 000040002C000000000001A020
         BC 3C,0D7,6E,40,1D,0E8
         RE $A20
         BC A.,B.,C.,D.,E.,F.,G.,H.
         ER
         BC 3C,5B,5E,40,1D,60
         RE $A31
         BC 40
         ER
         BC E.,N.,D.,40,O.,F.,40,T.,H.,I.,S.
         BC 40,S.,C.,R.,E.,E.,N.,1D,40,13
         RE $A15
         BC 40
         ER
SCRL83   EQ $A252




:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::  this is the PACING request screen (PF5)                           :::
PSCR50   XC 00004000280000000000038120
         XC F5C31140401D60
         RE 4
         BC 5C,1D,60,P.,A.,C.,I.,N.,G.,40,S.,T.,U.,F.,F.,1D,0E8
         ER
         BC 11,0C5,0E8,T.,H.,I.,S.,40,S.,E.,G.,M.,E.,N.,T.,40,R.,E.,Q.
         BC U.,E.,S.,T.,E.,D.,40,P.,A.,C.,I.,N.,G.,11,0C8,6F,1D,60
         RE 50
         BC P.
         ER
PSC50L   EQ $A205

PSCR51   XC 00004000200000000000
         RE $A240
         BC 96       :o
         ER
PSC51L   EQ $A250

PSCR52   XC 00004000200000000000
         RE $A240
         BC 98       :q
         ER
         XC F5F4F3
PSC52L   EQ $A253

PSCR53   XC 00004000240000000000
         RE $A48
         BC 40,S.,T.,I.,G.
         ER
         XC 1D4013
PSC53L   EQ $A253
         BND 2
         if PKTSIZ-$A512
:---  THIS RU IS 500 BYTES LONG ---:
BIGRU    XC 000040002C0000000000039020        :13 BYTES
         XC F5C31140401D60       
         RE $A48
         BC N5.,N0.,N0.,40,B.,Y.,T.,E.,S.,40
         ER
         ei


:qpqpqpqpqpqpqpqpqpqpqpqpqpqpqpqpqpqpqpqpqpqpqpqp
:qp Foreground trace buffer
         IF FGTRCE
FGTIX    HC 0
FGTIX2   HC 0
FGSTML   WC 0,0
FGBUFT   WS 100
LGQQ     EQ 0
FGLOCT   WS 2*MXENT
         EI


:=========================================================================
:=  THIS IS WHERE THE BACKGROUND HANDLES SOME OF THE PU STATES          =:

         REMARK %   genning BACKGROUND STATE area
         SEG A.CODE

BGFGST   ST  R0,BGSRET
         LIS R2,0
         L   R1,BGRTAR                :RESPONSE TIME TESTING?
         JN  CXLU                     :YES
BGFGS1   LB  R5,PUACT,R2
         CHI R5,1
         JE  SETACP
         LB  R5,PUSTAT,R2
         JL  BGFGS2
         CHI R5,15
         JG  BGFGS2
         LHL R7,BGTABL,R5,R5          :GET ROUTINE
         J   FSEG,R7
BGFGS2   AIS R2,1                     :GET NEXT PU
         CHI R2,NUMPU                 :SEE IF ALL HAVE BEEN PROCESSED
         JL  BGFGS1
         L   R0,BGSRET
         JR  R0

BGTABL   HC  BGFGS2-FSEG              :STATE 0 = BG DOES NOTHING
         HC  CKSNTM-FSEG              :STATE 1 = SEE IF SNRM TIMER EXPIRED
         HC  CKRRNR-FSEG              :STATE 2 = SEE IF RR WAS RECEIVED
         HC  CKRR-FSEG                :STATE 3 = SEE IF RR TIMER EXPIRED
         HC  CKRR-FSEG                :STATE 4 = SEE IF RR WAS RECEIVED
         IF SPCSEQ                    
         HC  BLDSSQ-FSEG              :STATE 5 = BUILD SPECIAL FRAME SEQ
         ELSE
         HC  BGFGS2-FSEG              :STATE 5 = BG DOES NOTHING
         EI
         HC  BGFGS2-FSEG              :STATE 6 = BG DOES NOTHING
         HC  BGFGS2-FSEG              :STATE 7 = BG DOES NOTHING
         IF SPCSEQ
         HC  CHKSSQ-FSEG              :STATE 8 = SEE IF SEQ SENT YET
         ELSE
         HC  BGFGS2-FSEG              :STATE 8 = BG DOES NOTHING
         EI
         HC  BGFGS2-FSEG              :STATE 9 = BG DOES NOTHING
         HC  CKIF-FSEG                :STATE A = WAITING FOR LAST INFO FRAME
         HC  BGFGS2-FSEG              :STATE B = BG DOES NOTHING
         HC  BGFGS2-FSEG              :STATE C = BG DOES NOTHING
         HC  BGFGS2-FSEG              :STATE D = BG DOES NOTHING
         HC  CKXIDT-FSEG              :STATE E = CHECK XID TIMER
         HC  BGFGS2-FSEG              :STATE F = BG DOES NOTHING
         HC  BGFGS2-FSEG              :STATE 10= BG DOES NOTHING
         HC  BGFGS2-FSEG              :STATE 11= BG DOES NOTHING
         HC  BGFGS2-FSEG              :STATE 12= BG DOES NOTHING
         HC  CKSNTM-FSEG              :STATE 13= DISC TIMER RUNNING
         HC  BGFGS2-FSEG              :STATE 14= SEND TEST FRAMES
         HC  BGFGS2-FSEG              :STATE 15= SENDING RESPONSE TIME DATA
:=                                                                        =:
:==========================================================================:



SETACP   SBT R2,PUACTR                :SET "ACTIVATE THIS PU" BIT
         LIS R5,2
         STB R5,PUACT,R2
         J   BGFGS2

CKSNTM   LIS R3,0
         TBT R3,DONTHG
         JN  BGFGS2
         LR  R3,R2
         SLLS R3,2
         L   R1,PUTIM,R3
         L   R4,FASTC,,
         SR  R4,R1
         CHI R4,SNMRTY                :SEND SNRM EVERY 6 SECONDS TILL UA
         JL  BGFGS2
         CHI R5,13                    :IN DISC STATE?
         JE  CKSNT4
         LIS R4,0
         STB R4,PUSTAT,R2             :CHANGE STATE TO "SEND SNRM"
         J   BGFGS2
CKSNT4   LHI R4,12                    :CHANGE STATE TO "SEND DISC"
         STB R4,PUSTAT,R2
         J   BGFGS2

CKXIDT   L   R1,PUTIM,,
         L   R4,FASTC,,
         SR  R4,R1
         CHI R4,SNMRTY
         JL  BGFGS2
         LIS R4,0D                    :TELL F.G. TO SEND ANOTHER XID
         STB R4,PUSTAT
         J   BGFGS2




:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::   CALL THE ROUTINE TO SEE IF IT'S TIME TO SEND AN RR FOR THE NEXT   ::: 
:::   PU                                                                :::
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

CKRR     JAL  R12,CKRRTM
         J    BGFGS2

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: COME HERE TO CHECK THE RECEIVE READY TIMER TO SEE IF IT'S EXPIRED
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

CKRRTM   LR  R3,R2
         SLLS R3,2
         TBT R2,TSTFRM                :SEE IF SENDING TEST FRAMES
         JN  CKRR50                   :1=YES
:KRR10   L   R1,PUTIM,R3
CKRR10   L   R1,LINTIM                :TRYING 1 LINE TIMER FOR ENTIRE LINE
         S   R1,FASTC,,
         JGR R12     
         ST  R2,HOLDB2
         IF NUMPU-1                   :THIS IS FOR MULTI-DROP LINES
         LH  R5,LASTRR                :SEE WHO SENT LAST RR
         JLR R12                      :FFFF=HASN'T BEEN SENT YET
CKRR12   AIS R5,1                     :SERVICE NEXT PU
         CHI R5,NUMPU                 :MAKE SURE IT'S IN RANGE
         JLFS CKRR15
         LIS R5,0
CKRR15   LB  R6,PUSTAT,R5,            :MAKE SURE THIS GUY WANTS TO SEND RR
         CHI R6,3
         JEFS CKRR17
         CHI R6,4
         JN  CKRR12
CKRR17   LR  R2,R5
         EI
         LB  R4,RRTMOC,R2,            :# CONSECUTIVE TIMES RR TIMER EXPIRED
         AIS R4,1
         CHI R4,N2C                   :RESET-THRESHHOLD
         JGE CKRR80                   :EXCEEDED, RESET PU AND SNRM
         STB R4,RRTMOC,R2,            :INCREMENT COUNTER
         TBT R2,DATSNT                :1=NO DATA SENT, NOTHING TO CHECK
         JN  CKRR20
         LB  R4,PURRNS,R2,            :GET LAST ACK'd FRAME
         LR  R5,R2    
         SLLS R5,1  
         L   R5,SIOBBF,R5,R5          :FIND WHICH SIOHL# IS BEING USED
         LHL R3,FGIX,R2,R2
         LB  R6,SIOHL0+3,R5,R3        :GET CONTROL FIELD
         AIS R6,2                     :SEE IF MATCHES WHAT HIF EXPECTS NEXT
         NHI R6,0F
         CR  R6,R4
         JN  CKRR20                   :NO MATCH, MAY BE UNACK'd DATA
         JAL R11,CALCIX
         LB  R11,SIOHL0+6,R5,R3       :GET DAF
         SIS R11,2                    :CONVERT TO RELATIVE LU NUMBER
         AR  R11,R6                   :NOW HAVE INDEX TO LUSTAT
         LB  R6,LUSTAT,R11,           :RESET HIG ORDER BIT
         NHI R6,7F                    :SINCE HIF ACK'd DATA
         STB R6,LUSTAT,R11            :ALLOW NEXT ACTION
         SBT R2,DATSNT                :DON'T DO THIS AGAIN UNTIL F.G. SENDS
CKRR20   LIS R4,7
         STB R4,PUSTAT,R2,            :TELL F.G. TO SEND RR
         IF NUMPU-1                   :MULTIDROP LINE
         LCS R5,1
         STH R5,LASTRR
         L   R2,HOLDB2
         EI
         JR  R12    
CKRR50   L   R1,TFRMTM,R3,            :GET TEST FRAME TIMER
         L   R4,FASTC,,
         SR  R4,R1
         CHI R4,TSTIME                :SEE IF TIMER EXPIRED
         JL  CKRR10                   :NO, SEND RR
         LHI R4,14                    :YES, SEND TEST FRAME
         STB R4,PUSTAT,R2
         JR  R12     
CKRR80   LIS R4,0
         STB R4,RRTMOC,R2,            :RESET RR TIMEOUT COUNTER
         STB R4,PUSTAT,R2,            :SET PUSTAT TO "SEND SNRM"
         LCS R4,1
         STB R4,PUACT,R2,             :SO ^U DISPLAYS "POLLING"
         JAL R15,INTBPU               :RESET LU STATES AND N(R) & N(S)
         JR  R12   

:----------------------------------------------------------------
: COME HERE AFTER A UA IS RECIEVED TO A SNRM
CKRRNR   LIS  R7,7                    :TELL F.G. TO SEND RR
         STB  R7,PUSTAT,R2,
         J    BGFGST




::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: COME HERE IF PUSTAT=0A TO SEE IF THE INFORMATION-FRAME-WITH-FINAL-BIT
::: TIMER EXPIRED YET, IF NOT THEN DO NOTHING
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

CKIF     JAL  R12,CKIFTM
         J    BGFGS2

CKIFTM   LR   R3,R2
         SLLS R3,2
         L    R1,PUTIM,R3             :GET TIMER
         S    R1,FASTC,,
         JGR  R12                     :NOT EXPIRED
         LIS  R3,7
         STB  R3,PUSTAT,R2            :CHANGE TO "SEND RR" STATE
         JR   R12     



:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::    THIS ROUTINE DETERMINES HOW MANY LUs ARE GENNED FOR A PU AND THEN  :::
::: IF THE BIT ARRAY LUTXMT IS 0 IT WILL SET THE BIT FOR THE NEXT LU ON   :::
::: THIS PU TO SEND RESPONSE TIME DATA                                    :::
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

CXLU     LH   R5,PUTXMT
         JNFS CXLU05
         ST   R5,BGRTAR
         J    BGFGS2
CXLU05   JFFO R1,CXLU10
CXLUE1   HC   0                       :SHOULD NEVER HAPPEN
CXLU10   LR   R6,R2                   :SAVE OLD PU
CXLU11   AIS  R2,1                    :PROCESS NEXT PU
         SBT  R2,CANDXM
         LHL  R5,CANDXM
         NH   R5,PUTXMT               :SEE IF RESP TIME TESTING
         JN   CXLU20
         RBT  R2,CANDXM
         CHI  R2,NUMPU-1
         JL   CXLU11
         LCS  R2,1
         J    CXLU11
CXLU20   RBT  R2,CANDXM
         LIS  R10,0
         TBT  R10,XMTRCV              :OUT OF RECEIVE STATE YET?
         JE   CXLU30
         TBT  R2,RRARAY               :CAN SEND TO HIM YET?
:        JN   CXLU30                  :YES
:        LR   R5,R2
:        SLLS R5,2
 :       L    R5,PUTIM,R5,
         L    R5,LINTIM,,             :JUST USE 1 LINE TIMER
         C    R5,FASTC,,
         JG   BGFGS2                  :NOT YET
         LIS  R5,1
         AHM  R5,RCVTMO               :COUNT THE EVENT
         RBT  R10,XMTRCV              :ENTER XMTSTATE
CXLU30   RBT  R6,BGRTAR               :TRANSFER CONTROL TO F.G.
         SBT  R2,FGRTAR
         J    BGFGS2


:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: SEE IF THE SIO HAS SENT THE SPECIAL FRAME SEQNC YET

         IF SPCSEQ
CHKSSQ   LHI  R5,NUMSPC+1
         SLLS R5,4                    :*10
         LH   R6,SIOCHN,R5,
         CHI  R6,200                  :HAS RR TRAILER BEEN SENT YET?
         JN   BGFGS2
         LIS  R5,3
         STB  R5,PUSTAT,R2
         J    BGFGS2
         EI (SPCSEQ)

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  COME HERE TO MOVE THE SPECIAL FRAME SEQUENCE INTO THE SIO OUT BUF

        IF SPCSEQ
BLDSSQ  LA    R9,BLDSSQ
        LH    R13,SIOCHN,,
        CHI   R13,1
        JE    BAKWAT
        LH    R13,SIOOUT,,
        CHI   R13,1
        JE    BAKWAT
        LIS   R13,0
        TBT   R13,WAITBT,,
        JN    BAKWAT
Q       EQ    0
        RE    NUMSPC
        LIS   R1,2                    :START WITH SECOND BYTE
        LHI   R4,SPCL0|Q|             :GET LENGTH OF THIS FRAME
        STH   R4,IOUT|Q|,,
BLDSS|Q|  LB  R3,SPC00|Q|,R1
        STB   R3,IOUT|Q|,R1,
        AIS   R1,1
        SIS   R4,1
        JG    BLDSS|Q|
        LIS   R7,2
        LB    R5,SPC00|Q|+2           :GET PU ADDRESS
        JAL   R13,GETPUN              :WILL RETURN WITH PU NUMBER IN R4
        JAL   R13,MAKCNT   
        OHI   R5,00
        STB   R5,IOUT|Q|+3,,          :PUT IN CONTROL FIELD
Q       EQ    Q+1
        ER
        LB    R5,PURRNR               :BUILD THE TRAILING RR
        AHI   R5,11
        STB   R5,IOUT|Q|+3,,
        LB    R5,SPC000+2             :GET THE PU ADDRESS
        STB   R5,IOUT|Q|+2,,
        LIS   R5,2
        STH   R5,IOUT|Q|,,
Q       EQ    0
        RE    NUMSPC
        LA    R5,IOUT|Q|,,
        SRLS  R5,4
        STH   R5,SIOCHN+2+Q*10,,
        LIS   R5,2                    :CHAIN COMMAND
        STH   R5,SIOCHN+4+Q*10,,
        LA    R5,SIOCHN+10+Q*10,,
        SRLS  R5,4
        STH   R5,SIOCHN+6+Q*10,,
Q       EQ    Q+1
        ER
        LA    R5,IOUT|Q|,,
        SRLS  R5,4
        STH   R5,SIOCHN+2+Q*10,,
        LIS   R5,0
        STH   R5,SIOCHN+4+Q*10-10,,
        SBT   R5,WAITBT,,
        LIS   R5,6
        STB   R5,PUSTAT               :TELL F.G. TO SEND THE SPECIAL FRAMES
        J     BGFGS2
MAKCNT  LB    R5,PURRNR,R4,
        LB    R6,PURRNS,R4,
        AR    R5,R6
        AR    R6,R7
        NHI   R6,0F
:       STB   R6,PURRNS,R4,
        JR    R13
        EI (SPCSEQ)



:-------------------------------------------------------------------------
:    THIS ROUTINE CHECKS TO SEE IF THERE ARE ANY PACKETS FOR THE PU'S.
:IF THERE ARE, IT CALLS CHKPCM WHICH RETURNS WITH THE PU COMMAND IN
:REGISTER R6.  CHKPCM ALSO DECREMENTS BUFPPW.  

PROPBP   L   R4,PUSTUF                :F.G. RECEIVED SOME PU STUFF?
         JER R5                       :NO, SAVE TIME AND SKIP THIS 
         LIS R2,0
PROPB1   LA  R15,BUFPPW,,
         LB  R8,BUFPPW,R2,            :GET NUMBER OF PU PKTS TO BE PROCESSED
         JLEFS PROPB3
         JAL R4,CHKPCM                :GO GET PU COMMAND CODE IN R6
         JAL R4,CHPCMB                :GO PROCESS THE PU COMMAND
         LCS R4,1
         AM  R4,PUSTUF                :DECREMENT F.G. - TO - B.G. COUNTER
         JER R5
         J   PROPB1
PROPB3   AIS R2,1
         CHI R2,NUMPU
         JL  PROPB1
         JR  R5

:------------------------------------------------------------------------
:    THIS ROUTINE GETS THE PU COMMAND FROM THE PU PACKET JUST RECEIVED
:FROM THE SNIF.  IT RETURNS WITH IT IN R6.  THE FORMAT FOR CALCULATING
:THE BEGINNING OF BUFPU IS  R2*LUBSIZ*WINDSZ + LUBSIZ*(BUFPIX-1)

CHKPCM   CHI R8,1
         JEFS .+4
         HC  0                        :NOT EXPECTING MORE THAN 1 YET
         LB  R6,BUFPIX,R2,            :NUMBER OF BUFFER WHERE PKT STORED
         CR  R6,R8 
         JGEFS CHKPC2
         AIS R6,WINDSZ
CHKPC2   SR  R6,R8                    :INDEX TO LAST UNPROCESSED FRAME
         LR  R8,R2
         LHI R7,WINDSZ                :GET NUMBER OF BUFFERS RESERVED/PU
         MHR R8,R7
         LHI R7,LUBSIZ
         MHR R8,R7
         MHR R6,R7
         AR  R8,R6                    :NOW HAVE BUFPU STARTING POINT
         LH  R7,BUFPU,R8,             :GET LENGTH OF PACKET
         LA  R14,BUFPU,,
         LB  R13,BUFPU+8,R8,          :FIRST BYTE OF RH
         STB R13,RUH1                 :SAVE FIRST BYTE OF RU HEADER
         NHI R13,60
         JE  FMD                      :DATA IS FMD
         CHI R13,60
         JE  SESCON
         CHI R13,40
         JE  DFC
         HC  0




::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  COME HERE TO PROCESS THE COMMAND BYTE FROM CHKPCM
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

CHPCMB   CHI  R6,6011                 :RESPONSE TO ACTPU?
         JE   ACPURP
         CHI  R6,6012                 :RESPONSE TO DE-ACTPU?
         JE   DACPRP
         JR   R4

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS HANDLES THE RESPONSE TO THE ACT PU                             :::
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

ACPURP   LB   R6,PUACT,R2
         AIS  R6,1                    :WAS PROBABLY STATE 3
         STB  R6,PUACT,R2
         JR   R4

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  This handles the RSP to DE-ACTPU                                    :::
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

DACPRP   LIS  R6,0                    :STATUS DISPLAY WILL SHOW INACTIVE
         STB  R6,PUACT,R2
         JR   R4





:-----------------------------------------------------------------------------
:    THIS ROUTINE CHECKS TO SEE WHICH LU'S HAVE UNPROCESSED PACKETS RECEIVED
:FROM THE SNA HIF.  IT CALLS CHKLCM WHICH RETURNS WITH THE LU COMMAND IN R6.

PROLBP   L   R4,LUSTUF                :DID F.G. QUEUE ANYTHING?
         JER R5                       :NO, SAVE TIME AND BEAT IT
         LIS R2,0
PROLB1   LA  R15,BUFLPW,,
         LB  R8,BUFLPW,R2,            :GET NUMBER OF UNPROCESSED PKTS FOR LU
         JEFS PROLB4
         JAL R4,CHKLCM                :GO GET LU COMMAND BYTE IN R6
         JAL R4,CHLCMB                :SEE WHAT LU COMMAND BYTE MEANS
         LCS R4,1
         AM  R4,LUSTUF
         JER R5                       :NOTHING LEFT
         J   PROLB1
PROLB4   AIS R2,1
         CHI R2,NUMLU
         JL  PROLB1
         JR  R5

:-----------------------------------------------------------------------
: THERE ARE VARIOUS LUSTAT STATES INWHICH A TIMER MUST EXPIRE BEFORE THE
: NEXT EVENT TAKES PLACE.  THIS ROUTINE CHECKS FOR THOSE STATES AND CHECKS
: TO SEE IF THE TIMER HAS EXPIRED YET.

CKLUTM   L   R7,TMSTUF                :ANY TIMERS RUNNING?
         JER R5
         LB  R7,LUSTAT,R2,
         LB  R7,CHKTBL,R7,            :CONVERT LUSTAT INTO INDEX TO CHKXXX
         LH  R7,CHKXXX,R7,R7          :GET ADDRESS OF ROUTINE TO PROCESS
         J   FSEG,R7                  :GO PROCESS IT

CKLUT1   LR  R3,R2
         SLLS R3,1
         L   R11,FASTC,,
         C   R11,LUTIME,R3,R3
         JL  CKLUT4
         JAL R4,BLDSC8                :TIMER EXPD, SEND SCREEN 8 NOW
         LCS R4,1
         AM  R4,TMSTUF                :REMOVE FROM TIMER LIST
         J   CKLUT4
CKLUT2   LR  R3,R2
         SLLS R3,1
         L   R11,FASTC,,
         C   R11,LUTIME,R3,R3         :TIME TO SEND SCREEN 7 YET?
         JL  CKLUT4
         JAL R4,BLDSC7
         LCS R4,1
         AM  R4,TMSTUF
         J   CKLUT4

CKLUT4   AIS R2,1
         CHI R2,NUMLU
         JL  CKLUTM
         JR  R5

         IF \TM2X1
CKLUT5   JAL  R4,RICHJ2
         LCS  R4,1
         AM   R4,TMSTUF
         J    CKLUT4
         EI

CKLUT8   LR   R3,R2                   :"CLEAR" TIMER RUNNING?
         SLLS R3,2
         L    R11,FASTC,,
         L    R12,LUTIME,R3,
         SR   R11,R12
         CHI  R11,CLRTIM
         JL   CKLUT4
         JAL  R4,BLDSC2
         LCS  R4,1
         AM   R4,TMSTUF               :DECREMENT "TIMER ACTIVE" INDICATOR
         J    CKLUT4
CKLUT9   LR   R3,R2
         SLLS R3,2
         L    R11,FASTC,,
         L    R12,LUTIME,R3,
         SR   R11,R12
         CI   R11,SCN3TM
         JL   CKLUT4
         JAL  R4,BLDLS3               :GO SEND LAST PART OF SCREEN 3
         LCS  R4,1
         AM   R4,TMSTUF               :REMOVE FROM TIMER LIST
         J    CKLUT4
CKLUTA   LR   R3,R2
         SLLS R3,2
         L    R11,FASTC,,
         L    R12,LUTIME,R3,
         SR   R11,R12
         CI   R11,CLEANT              :CLEANUP TIMER EXPIRED?
         JL   CKLUT4
:        JAL  R4,BLDDAL
         JAL  R4,RSETLU               :SET LUSTAT TO 04 FOR NEW USER
         LCS  R4,1
         AM   R4,TMSTUF               :REMOVE FROM TIMER LIST
         J    CKLUT4

CHKXXX   HC   CKLUT4-FSEG             :UNDEFINED
         HC   CKLUT8-FSEG             :01 (45) "CLEAR KEY" TIMER RUNNING
         HC   STRPRT-FSEG             :02 (42,50,64,66) START PRINT DATA
         HC   STRPRT-FSEG             :03 (52) START PRINT DATA
         HC   INFRCT-FSEG             :04 (60) "END OF PRINT" TIMER RUNNING
         HC   CKLUT9-FSEG             :05 (79) TIMER RUNNING FOR LAST SC3
         HC   CKLUTA-FSEG             :06 (37) TIMER FOR DACTLU (NOTIF/UNBIND)
         HC   BLDP32-FSEG             :07 (68) SEND SECOND BLOCK OF PRINT3
         HC   BLDP33-FSEG             :08 (6A) SEND THIRD BLOCK OF PRINT3
         HC   BLDP34-FSEG             :09 (6C) SEND FOURTH BLK OF PR3
         HC   BLDP35-FSEG             :0A (6E) SEND 5TH BLK OF PRT3
         HC   BLDP36-FSEG             :0B (70) SEND 6th BLOCK PR3
         HC   BLDALU-FSEG             :0C (80) CONTROL-L SAYS ACTLU 
         HC   CKLUT1-FSEG             :0D (3A) TIMER RUNNING AFTER SC7 SENT
         HC   CKLUT2-FSEG             :0E (3D) TIMER RUNNING AFTER SC8 SENT
         IF \TM2X1
         HC   CKLUT5-FSEG             :0F (2F) SEND 2nd SCREEN FOR JEFF
         ELSE
         HC   CKLUT4-FSEG             :0F DO NOTHING IF NOT DEFINED
         HC   CMTNXL-FSEG             :10 (49) END OF SINGLE LU1 PRT W/PACING
         EI




:---------------------------------------------------------------------------
:    THIS ROUTINE GETS THE COMMAND BYTE FROM THIS LU'S PACKET THEN
:DECREMENTS THE "UNPROCESSED PACKETS" COUNTER IN BUFLPW.  THE FORMULA
:FOR CALCULATING THE BEGINNING OF CURRENT PACKET IN BUFLU IS:
:  R2*WINDSZ*LUBSIZ + LUBSIZ*(BUFLIX-1)

CHKLCM   LB  R6,BUFLIX,R2,            :GET INDEX TO NEXT FREE BUFFER
         CR  R6,R8                                                     
         JGEFS CHKLC1
         AIS R6,WINDSZ                :AVOID NEGATIVE INDEX
CHKLC1   SR  R6,R8                    :GET INDEX TO LAST UNPROCESSED FRAME
         LR  R8,R2
         LHI R7,WINDSZ
         MHR R8,R7
         LHI R7,LUBSIZ
         MHR R8,R7
         MHR R6,R7
         AR  R8,R6                    :BEGINNING OF THIS LU'S PACKET IN BUFLU
         LH  R7,BUFLU,R8,             :GET LENGTH OF PACKET
         LA  R14,BUFLU,,              :SO CAN BE USED BY PU ROUTINE TOO
         LB  R13,BUFLU+2,R8,          :GET FIRST BYTE OF TH
         NHI R13,08                   :SEE IF FIRST SEGMENT
         JE  NOTBCI                   :THROW AWAY IF NOT
         LB  R13,BUFLU+8,R8,          :GET FIRST BYTE RH
         STB R13,RUH1                 :SAVE FIRST BYTE OF RU HEADER
         IF  VTAMRF                   :IF INTERFACE IS FOR CMH
         JAL R12,CKPROC               :SEE IF AUTO PROCESSING FMD DATA
         EI                           :MAY RETURN TO FMD999 AND NOT VIA R12
         NHI R13,02                   :SEE IF BEGINNING OF CHAIN
         JE  NOTBCI                   :THROW AWAY IF NOT
         LB  R13,RUH1
         NHI R13,60                   :ISOLATE RU CATAGORY
         JE  FMD
         CHI R13,60
         JE  SESCON
         CHI R13,40
         JE  DFC
         HC  0
         JR  R4


:========================================================================
: FMD STUFF

FMD      LB  R6,RH1,R14,R8            :GET FIRST BYTE OF RH
         NHI R6,80                    :REQ/RSP?
         JN  FMDRP                    :RSP
:---  NOW PROCESSING REQs
         LHL R6,THSNF,R14,R8          :GET REQs SNF
         STH R6,SNFLU,R2,R2           :SAVE FOR RESPONSE
         LB  R6,RH1,R14,R8            :GET FIRST BYTE OF RH AGAIN
         NHI R6,08                    :FIELD FORMATTED RU?
         JN  FMDFOR                   :YES
:--- NOW PROCESSING CHARACTER CODED RUs
         LB  R13,TH3,R14,R8           :SEE IF FOR SSCP OR LU
         JE  FMDSCP                   :FOR SSCP
:--- NOW PROCESSING LU-LU SESSIONS
         LB  R13,RH2,R14,R8           :GET 2nd BYTE OF RH
         NHI R13,10                   :SEE IF DEFINITE RESPONSE REQUESTED
         JNFS FMD4                    :NO
         SBT R2,DRPLUL                :SET DEF-RSP-LU-LU-SESSION
FMD4     LB  R6,RU1,R14,R8            :GET FIRST BYTE OF RU FOR CHLCMB
FMD999   LB  R8,0,R15,R2              :GET NUMBER OF UNPROCESSED FRAMES
         SIS R8,1                     :DECREASE
         STB R8,0,R15,R2
         JR  R4
:--- NOW PROCESSING SSCP CHARACTER CODED REQUESTS
FMDSCP   LHI R6,77                    :USE THIS FOR "VTAM LOGON"
         LB  R13,RH2,R14,R8           :GET 2nd BYTE OF RH
         NHI R13,10                   :SEE IF DEFINITE RESPONSE REQUESTED
         JN  FMD999                   :NO
         SBT R2,DRPSCP                :FLAG DEFINITE RESPONSE REQUIRED
         J   FMD999
:--- NOW PROCESSING FMD RESPONSES OF ALL TYPES
FMDRP    LHI R6,99                    :PREVENT CHLCMB FROM ACTING
         LB  R13,RH2,R14,R8           :GET 2nd BYTE OF RH
         NHI R13,10                   :CHECK RESPONSE-TYPE-INDICATOR
         JE  FMDRP2                   :+RSP
         LIS R13,1
         AHM R6,NEGCTR,R2,R2          :INCREMENT LU'S ERROR COUNTER
         LHI R13,44                   :STOP ACTIVITY ON NEG RSP
         STB R13,LUSTAT,R2,
         J   FMD999
FMDRP2   LB  R13,LUSTAT,R2,           :GET LU STATE
         NHI R13,7F                   :REMOVE "PENDING" BIT
         LB  R6,LUSFMD,R13,           :CONVERT TO FMD CODE
         IF  BGDEBG
         LB  R13,LUSTAT,R2,
         NHI R13,80                   :IF THIS IS SET, PROBABLY AN ERROR
         JE  FMD999
         HC  0
         EI  (BGDEBG)  
         J   FMD999
:--- NOW PROCESSING FIELD FORMATED REQUESTS
FMDFOR   LHI R6,99                    :SO CHLCMB WON`T REACT IF NOT DESIRED
         LB  R13,RH2,R14,R8           :GET 2nd BYTE OF RH
         NHI R13,10                   :DEF RSP REQUIRED?
         JNFS FMDFR1                  :NO
         LA  R13,DRPLUL               :LU-LU SESSION 
         LB  R9,TH3,R14,R8            :SEE IF FOR LU OR SSCP
         JNFS FMDFR0
         LA  R13,DRPSCP               :SSCP-LU SESSION
FMDFR0   SBT R2,0,R13                 :DEFINITE RESPONSE REQUIRED
FMDFR1   LB  R13,RU1,R14,R8           :GET FIRST BYTE OF FORMATED RU
         STB R13,FMDFRU+1             :SAVE IT
         LHL R13,RU2,R14,R8           :GET NEXT 2 BYTES
         STH R13,FMDFRU+2
         LB  R13,RU6,R14,R8           :GET POSSIBLE CONTROL VECTOR
         STB R13,CONVEC               :SAVE INCASE NOTIFY
         L   R9,FMDFRU                :GET THE WHOLE THING
         LHL R13,FMDFRL               :LENGTH OF TABLE/2
FMDFR2   SIS R13,2
         JL  FMD999                   :NO MATCH FOUND, IGNORE THIS RU
         C   R9,FMDFTB,R13,R13        :MATCH?
         JNBS FMDFR2                  :NO, TRY NEXT ONE
         LHL R6,FMDFCV,R13            :CONVERT IT FOR CHLCMB
         J   FMD999



:===========================================================================
: SESSION CONTROL

SESCON   LB  R6,0B,R14,R8             :GET SESSION CONTROL INDENTIFYING BYTE
         LB  R7,RH2,R14,R8
         LB  R8,0,R15,R2              :DECREMENT FRAME COUNTER
         SIS R8,1
         STB R8,0,R15,R2
         LB  R13,RUH1                 :GET FIRST BYTE OF RH HEADER
         NHI R13,80                   :SEE IF REQ/RSP
         JNFS .+4
         HC  0                        :NOT EXPECTING ANY REQ'S YET
         NHI R7,10                    :NEG RSP?
         JN  SESNCN
         LHI R7,60                    :SESSION CONTROL
         SLLS R7,8
         AR  R6,R7                    :TWO BYTE COMMAND FOR CHLCMB
         JR  R4
:--- COME HERE WITH NEG SESCON RSP ---:
SESNCN   LHI  R6,6066
         JR   R4

:============================================================================
: DFC LAYER

DFC      LB  R13,RH1,R14,R8           :GET FIRST BYTE OF RH
         NHI R13,80                   :SEE REQ/RSP
         JN  DFCRSP                   :RSP
:--- NOW PROCESSING DFC REQs ---:
         LHL R13,THSNF,R14,R8         :GET REQ SNF
         STH  R13,SNFLU,R2,R2         :SAVE FOR RSP
         LB  R13,RH2,R14,R8           :GET 2nd BYTE OF RH
         LA  R6,DRPDLU                :ARRAY FOR DEF-RSP-DFC-LU-LU
         NHI R13,10                   :DEFINITE RESPONSE REQUIRED?
         JNFS DFC1                    :N0
         LB  R13,TH3,R14,R8           :SSCP OR LU
         JNFS DFC0                    :LU
         LA  R6,DRPDSC                :ARRAY FOR SSCP-LU
DFC0     SBT R2,0,R6
DFC1     LB  R6,RU1,R14,R8            :GET RU CODE
         CHI R6,04                    :LU STAT?
         JN  DFC999
         LHL R13,RU2,R14,R8           :GET LU STATUS
         STH R13,HLDSNS
DFC999   LB  R8,0,R15,R2              :DECREMENT FRAME COUNTER
         SIS R8,1
         STB R8,0,R15,R2
         LB  R13,RUH1
         NHI R13,80                   :SEE IF REQ/RSP
         LHI R7,40                    :LOAD RU CATEGORY
         AR  R7,R13
         SLLS R7,8
         AR  R6,R7                    :TWO BYTE COMMAND
         JR  R4
:--- NOW PROCESSING DFC RSPs ---:
DFCRSP   LB  R6,RH2,R14,R8 
         NHI R6,10                    :NEG RSP?
         JN  DFCNRP                   :YES
         LB  R6,RU1,R14,R8,           :GET RU CODE
         J   DFC999
DFCNRP   LHI R6,400D                  :NEG RSP FOR CHLCMB
         LB  R8,0,R15,R2
         SIS R8,1
         STB R8,0,R15,R2
         JR  R4



:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: THIS ROUTINE DISCARDS FRAMES WHICH ARE NOT EITHER BEGINNING OF
::: SEGMENT OR BEGINNING OF CHAIN
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

NOTBCI   LB   R8,0,R15,R2
         SIS  R8,1                    :DECREMENT THE FRAME COUNTER
         STB  R8,0,R15,R2
         J    4,R4                    :SKIP CHLCMB SINCE FRAME WAS TRASHED




:-------------------------------------------------------------------------
:    CHeck Lu CoMmand Byte TO SEE WHERE TO BRANCH TO

CHLCMB   JAL R13,FNDLPU               :FIND RELATIVE PU NUMBER
         CHI R6,00FF                  :FMD REQ?
         JLE FIGFMD                   :GO DETERMINE FMD REQUEST
         CHI R6,40C2                  :REQUEST SHUTDOWN?
         JE  BLDUBN                   :SEND UNBIND & +RSP TO RSHUTD
         CHI R6,600D                  :RSP TO ACTLU? (SESSION CONTROL+ACTLU)
         JE  RCVACL
         CHI R6,600E                  :+RSP TO DE-ACTLU?
         JE  RSTLUS                   :IF SO, GO RESET LUSTAT FOR THIS LU
         CHI R6,40C1                  :RECEIVED SHUTC
         JE  RSHUTC
         CHI R6,4004                  :LU STATUS REQ?
         JE  RCVSTS
         CHI R6,6031                  :BIND RSP? (SESSION CONTROL+BIND)
         JE  BLDSDT
         CHI R6,6032                  :UNBIND RESP?
         JE  WATNTF                   :WAIT FOR NOTIFY
         IF  BRBID                    :USING BRACKET BID?
         CHI R6,60A0                  :SDT RSP?
         JE  RSETSNF
         CI  R6,0C0C8                 :+RSP TO BID?
         JE  BLDSC1
         ELSE
         CHI R6,60A0                  :SDT RSP?
         JE  RSETSNF
         EI  (BRBID)
         CI  R6,0C008                 :-RSP TO BID?
         JE  DECODF                   :GO DECODE SENSE DATA
         CHI R6,400D                  :BAD DFC RESPONSE
         JE  BADDFC
         CHI R6,6066                  :NEG RSP TO SESCON
         JE  BADSES
         JR  R4



:--------------------------------------------------------------------------
:    COME HERE WHEN +RSP TO ACTLU RCV'D.  IF GENNED FOR "NOTIFY" CHANGE   
: STATE TO 04 AND RETURN.  IF NOTIFY NOT SELECTED THEN SEND VTAM BANNER.

RCVACL   HS  0
         IF NOTIFY
         LIS R7,4
         STB R7,LUSTAT,R2,
         JR  R4
         ELSE
         TBT R2,MANUAL
         JNR R4
         LA  R15,VTAMBN
         LHI R14,VTAMSZ
         LIS R13,0
         STH R13,APPLIC
         JAL R7,BLDFRM
         LIS R7,3                     :TELL F.G. TO SEND VTAM BANNER
         STB R7,LUSTAT,R2,
         JR  R4
         EI

:--- come here when a NEG RSP is received for a DFC REQ ---:
BADDFC   LIS  R7,0D
         STB  R7,LUSTAT,R2,
         JR   R4

:--- come here when a NEG RSP is received for a SESCON REQ ---:
BADSES   LHI  R7,33
         STB  R7,LUSTAT,R2,
         JR   R4

:--------------------------------------------------------------
: this routine resets the SNF incase a manual SDT was sent

RSETSNF  LIS  R13,1
         TBT  R2,MANUAL               :IF NOT MANUAL, SEND SCREEN 1
         IF BRBID
         JER  R4
         ELSE
         JE   BLDSC1
         EI
         STH  R13,LUSNF,R2,R2
         JR   R4



::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: THIS ROUTINE DECODES THE SENSE DATA IN THE DFC LAYER

DECODF   LH   R13,HLDSNS
         CHI  R13,0813                :BRACKET BID REJECT?
         JE   DECOD2
         JR   R4
DECOD2   LB   R13,BIDRJC,R2           :GET CURRENT BID REJECT COUNT
         AIS  R13,1
         STB  R13,BIDRJC,R2
         J    BLDBID

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: THIS ROUTINE STARTS THE CKLUTA TIMER WHEN AN UNBIND RSP COMES IN.   :::

WATNTF   LR   R7,R2
         SLLS R7,1
         L    R3,FASTC,,              :GET CURRENT TIME TO START CKLUTA
         ST   R3,LUTIME,R7,R7
         LHI  R7,37                   :TELL CKLUTM TO WAIT CLEANT SECS AND SET
         STB  R7,LUSTAT,R2,           :LUSTAT TO 04 in RSETLU below
         LIS  R7,1
         AM   R7,TMSTUF               :LET CKLUTM KNOW TIMER IS RUNNING
         JR   R4

:!.!.!.!.!.!.!.!.!.!.!.!.!.!.!.!.!.!.!.!.!.!.!.!.!.!
: THIS ROUTINE JUST SETS LUSTAT TO 04 SO NEXT USER
: CAN LOG IN

RSETLU   LIS  R7,04                   :SET TO "READY FOR LOGON" STATE
         STB  R7,LUSTAT,R2,
         JR   R4

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: THIS ROUTINE IS CALLED CHKLC1 IF GENNED AS VTAM REFLECT (CMH) TO SEE
::: IF THE FMD DATA SHOULD BE PROCESSED AUTOMATICALLY

         IF VTAMRF
CKPROC   TBT  R2,VTAUTO               :RESPOND TO FMD DATA AUTOMATICALLY?
         JER  R12                     :NO
         LB   R11,RUH1                :GET FIRST BYTE OF RH
         NHI  R11,0E8                 :NON-FORMATTED FMD?
         JNR  R12                     :NO
         LB   R11,RUH1
         NHI  R11,01                  :LAST ELEMENT OF CHAIN?
         JER  R12                     :NO, DISCARD
         LHI  R6,9A                   :SET UP TYPE AS "9A" FOR FIGFMD
         J    FMD999                  :DON'T RETURN VIA R12
         EI (VTAMRF)



::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE LOOKS UP THE FMD COMMAND IN THE TABLE "FMDTBL" AND   :::
:::  CONVERTS IT TO AN INDEX INTO FMDXXX.

FIGFMD   STB  R6,HLFMCM               :SAVE COMMAND JUST INCASE
         IF VTAMRF                    :IF GENNED FOR CMH
         TBT  R2,VTAUTO               :RESPOND AUTOMATICALLY TO FMD DATA?
         JN   FIGFM2
         EI (VTAMRF)
         TBT  R2,MANUAL               :DO NOTHING IF MANUAL OVERRIDE IS ON
         JNR  R4
FIGFM2   LB   R6,FMDTBL,R6            :GET INDEX TO FMDXXX
         LH   R7,FMDXXX,R6,R6         :GET ADDRESS OF ROUTINE TO EXECUTE
         J    FSEG,R7                 :GO EXECUTE IT

FMDUND   JR   R4                      :UNDEFINED, JUST RETURN

FMDXXX   HC   FMDUND-FSEG             :UNDEFINED, JUST RETURN VIA R4
         HC   BLDUBN-FSEG             :GOT TERMSELF, GO SEND UNBIND
         HC   STS2TM-FSEG             :RECEIVED "CLEAR" KEY
         HC   BLDERS-FSEG             :RECEIVED ENTER KEY
         HC   BLDS06-FSEG             :RECEIVED PF1
         HC   BLDSC7-FSEG             :RECEIVED PF2 (cmt stress testing)
         IF PF3DEF                    :IF PF3 SCREEN DEFINED IN T01 FILE
         HC   BLDPF3-FSEG             :THEN GO SEND IT
         ELSE
         HC   BLDERS-FSEG             :RECEIVED PF3
         EI (PF3DEF)
         HC   CMTEST-FSEG             :RECEIVED PF4 (ALT CRT/PRT DATA)
         HC   BLDPSC-FSEG             :RECEIVED PF5 (SEND PACING REQ)
         HC   BLDSC6-FSEG             :RECEIVED PF6 (CMT test send SC7 or 8)
         HC   CHKPRT-FSEG             :RECEIVED PF7
         HC   CHKPRT-FSEG             :RECEIVED PF8 (SEND 61 LINE PRINT FILES)
         HC   BLDERS-FSEG             :RECEIVED PF9
         HC   CMTPRT-FSEG             :RECEIVED PF10 (Send 1 LU.T1 file)
         HC   CMTPRT-FSEG             :RECEIVED PF11 (1 LU.T1 file w/pacing)
         IF \TM1X1                     :SPECIAL STUFF FOR RICHARD & JEFF
         HC   RICHJF-FSEG
         ELSE 
         HC   BLDERS-FSEG             :RECEIVED PF12
         EI
         HC   BLDS30-FSEG             :RECEIVED PA1
         HC   BLDSC4-FSEG             :RECEIVED PA2, SEND SCREEN 04
         HC   BLDLGF-FSEG             :RECEIVED PA3 (LOGOFF)
         HC   RCVSNS-FSEG             :RECEIVED SENSE STATUS
         HC   RCVNTF-FSEG             :RECEIVED NOTIFY
         HC   BLDLGN-FSEG             :RECEIVED VTAM LOGON
         HC   BLDSC1-FSEG             :RECEIVED PF13
         HC   BLDP31-FSEG             :(23d) GOT +RSP TO PACING LUSTAT=44
         HC   BLDWSR-FSEG             :RECEIVED WSFQRP  (88, THIS IS 18x)
         HC   BLDUBN-FSEG             :25  RCV'd +RSP TO LOGOFF, SEND UNBIND
         HC   BLDUMY-FSEG             :RECEIVED ECI IN FMD SO SEND DUMMY RSP
         HC   P3PRSP-FSEG             :GOT THE PRINT 3 +RSP (DISP=27d)
         HC   BLDS41-FSEG             :(28d) GOT +RSP TO PACING LUSTAT=25
         HC   CMTTMR-FSEG             :(29d) GOT +RSP, START TIMER FOR 2nd 
         HC   P3PCMT-FSEG             :(30d) GOT +RSP TO SC7or 8 SEND LU1
         HC   RSTSPC-FSEG             :(31d) GOT +RSP TO PACING SCREEN LS=5F
         HC   BLDS42-FSEG             :(32d) GOT +RSP TO PACING LUSTAT=27



:======================================================================
: CONTROL-L PUTS AN 80 IN THE LUSTAT.  CKLUTM SEES THE 80 AND ROUTES
: IT HERE TO CHANGE THE STATE TO 1 AND SEND ACTLU
BLDALU   JAL  R13,FNDLPU
         LA   R15,LUACT
         LHI  R14,LUACTL
         LIS  R13,0
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LIS  R7,01
         STB  R7,LUSTAT,R2,
         LCS  R7,1
         AM   R7,TMSTUF               :REMOVE THIS GUY FROM TIMER LIST
         J    CKLUT4

:--------------------------------------------------------------------------
: THIS ROUTINE EXAMINES THE SENSE DATA RECEIVED AND TAKES THE APPROPRIATE
: ACTION.

RCVSNS   LB  R7,HLDSNS
         CHI R7,31                    :DEVICE TURNED OFF?
         JN  RCVSN4
         LIS R7,4
         STB R7,LUSTAT,R2,
RCVSN4   JR  R4

:--------------------------------------------------------------------------
: THIS ROUTINE EXAMINES THE LU STATUS CODE AND TAKES THE APPROPRIATE
: ACTION.

RCVSTS   TBT R2,MANUAL
         JNR R4
         LH  R7,HLDSNS                :GET THE LU STATUS CODE
         CHI R7,082B                  :SPACE INTEGRITY LOST?
         JNR R4
         LA  R15,VTAMBN
         LHI R14,VTAMSZ
         LIS R13,0
         STH R13,APPLIC
         JAL R7,BLDFRM
         RBT R2,DRPDSC                :DOES LU STAT NEED +RSP?
         JE  RCVST4                   :NO
         LA  R15,STATRP
         LHI R14,$A14
         JAL R13,SWBSNF
         JAL R7,BLDFRM
         LHL R7,HLBSNF
         STH R7,LUSNF,R2,R2
RCVST4   LHI R7,46
         STB R7,LUSTAT,R2,
         JR  R4





:==========================================================================
: THIS ROUTINE SETS UP THE +RSP TO NOTIFY

RCVNTF   LB  R7,LUSTAT,R2,
         TBT R2,MANUAL
         JNR R4
         CHI R7,37                    :FOLLOWING UNBIND RSP?
         JE  RCVNT4
         LB  R13,CONVEC               :GET NOTIFY CONTROL VECTOR CODE
         CHI R13,01                   :SLU DISABLED?
         JE  RCVNT5                   :SEND +RSP AND LUSTAT WILL = 04
         IF VBANER                    :SEND VTAM BANNER WHEN NOTIFY RCV'D?
         LA  R15,VTAMBN
         LHI R14,VTAMSZ
         LIS R13,0
         STH R13,APPLIC
         JAL R7,BLDFRM                :SETUP VTAM BANNER
         ELSE
         J   BLDBND                   :NO BANNER, GO SEND BIND
         EI (VBANER)
         RBT R2,DRPSCP                :NEED TO SEND RSP TO NOTIFY?
         JE  RCVNT2                   :NO
         LA  R15,NTFBUF
         LHI R14,NTFBFL
         JAL R13,SWBSNF               :GET REQ SNF
         JAL R7,BLDFRM
         LHL R7,HLBSNF
         STH R7,LUSNF,R2,R2
RCVNT2   LHI R7,46                    :TELL F.G. TO SEND THIS STUFF
         STB R7,LUSTAT,R2
         JR  R4
RCVNT4   LCS  R13,1
         AM   R13,TMSTUF              :TURN OFF CKLUTM TIMER
RCVNT5   RBT  R2,DRPSCP               :NEED TO SEND RSP TO NOTIFY?
         JER  R4                      :NO
         LA   R15,NTFBUF
         LHI  R14,NTFBFL
         LIS  R13,0
         STH  R13,APPLIC
         JAL  R13,SWBSNF              :GET THE REQ SNF
         JAL  R7,BLDFRM
         LHL  R7,HLBSNF
         STH  R7,LUSNF,R2,R2          :RESTORE SNF
         LHI  R7,3 
         STB  R7,LUSTAT,R2,
         JR   R4








:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:
:+:  COME HERE TO SEND SPECIAL SCREEN DEFINED BY RICHARD OR JEFF  :+:
:+:  THE LABELS  SHOULD BE TM1X1-TM1X6 AND IF A SECOND SCREEN     :+:
:+:  THEN TM2X1-TM2X6.                                            :+:
:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:+:  
        IF \TM1X1
RICHJF  LA   R15,TM1X1,,
        LHI  R14,TM1X1L
        LHI  R13,14
        STH  R13,APPLIC
        JAL  R7,BLDFRM
JQJ     EQ   2
        IF   TM1XN-1
        RE   TM1XN-1
        LA   R15,TM1X|JQJ|,,
        LHI  R14,TM1X|JQJ|L
        JAL  R7,BLDFRM
JQJ     EQ   JQJ+1
        ER
        EI
        LHI  R7,2E                    :WHEN "PENDING" BIT IS CLEARED AT 2F
        STB  R7,LUSTAT,R2,            :CKLUTM WILL SEND IT TO RICHJ2
        IF \TM2X1
        LIS  R7,1
        AM   R7,TMSTUF
        EI
        JR   R4

        IF \TM2X1                     :SECOND SPECIAL SCREEN TO SEND
RICHJ2  LA   R15,TM2X1,,
        LHI  R14,TM2X1L
        LHI  R13,14
        STH  R13,APPLIC
        JAL  R13,FNDLPU
        JAL  R7,BLDFRM
JQJ     EQ   2
        IF TM2XN-1
        RE TM2XN-1
        LA   R15,TM2X|JQJ|,,
        LHI  R14,TM2X|JQJ|L
        JAL  R7,BLDFRM
JQJ     EQ   JQJ+1
        ER
        EI
        LHI  R7,46                    :GENERIC "SEND" COMMAND
        STB  R7,LUSTAT,R2
        JR   R4
        EI
        EI



:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE IS CALLED WHEN PF7 IS ENTERED.  IT CHECKS THE STATUS ::
:::  OF THE ASSOCIATED PRINTER AND SENDS IT SOME DATA IF IT'S READY   :::

CHKPRT   LB   R11,LUSTAT+1,R2,        :SEE IF PRINTER IS LOGGED IN
         CHI  R11,17
         JL   BLDER3                  :NOT LOGGED IN
         LHI  R11,50                  :USE 50'S FOR PRINT STUFF
         CHI  R6,07                   :07=USE PRINT3 (CMT STRESS TEST PF4)
         JE   CHKPR5
         CHI  R6,0B                   :0B=USE PRINT3
         JE   CHKPR5
         LR   R13,R2
         AIS  R13,1                   :PRINTER IS CRT+1
CHKPR4   STB  R11,LUSTAT,R13,       :LET CKLUTM START PRINT IN 5 SECONDS
         SLLS R13,1
         L    R7,FASTC,,
         ST   R7,LUTIME,R13,R13
         LHI  R7,PRTDL1               :SAVE INITIAL PRINT DELAY VALUE
         STH  R7,PTDELY,R13,
         LIS  R7,0
         STH  R7,PRNTCT,R13,          :INIT PRINT COUNTER
         STH  R2,REQCRT,R13,          :SAVE REQUESTING CRT REL LU#
         LIS  R7,1
         AM   R7,TMSTUF               :INDICATE A TIMER IS RUNNING
         J    BLDSCC                  :GO SEND MESSAGE TO CRT NOW
CHKPR5   LHI  R11,64                  :64=PRINT3
         LR   R13,R2
         AIS  R13,1                   :PRINTER IS NEXT TO CRT
         J    CHKPR4

:---------------------------------------------------------------------------
: come here when PF4 is entered to start LU1 print and then SCREEN 7,
: then LU1 print then SCREEN 8 then LU1 print, then SCREEN 7 etc.

CMTEST   SBT  R2,CMTARY,,            :SHOW THAT CMT STRESS TESTING IS RUNNING
         J    CHKPRT

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: THIS ROUTINE SENDS A NOTICE TO USER THAT PRINT WILL START SOON       :::

BLDSCC   JAL  R13,FNDLPU
         LA   R15,SCR120,,
         LHI  R14,SCRZ12
BLDSCX   LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LHI  R7,46                   :46 FIRST MEANT SEND SCRN 2 BUT CAN BE
         STB  R7,LUSTAT,R2,           :USED HERE TOO
         JR   R4


:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  come here when a PF10 is entered to send 1 LU.T1 print file      :::
:::  without notifying the CRT.  When the file is done the CRT will   :::
:::  NOT receive any message.                                         :::
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

CMTPRT   LR   R12,R2
         AIS  R12,1                   :CONVERT TO PRINTER LU NUMBER
         LB   R11,LUSTAT,R12,         :SEE IF ITS LOGGED ON
         CHI  R11,17
         JL   BLDER3
         LHI  R11,64                  :CKLUTM WILL LOOK FOR 64 TO START PRINT
         CHI  R6,0D                   :PF10? (NON-PACING)
         JEFS CMTPR0
         LHI  R11,42                  :PF11 (USE PACING)
CMTPR0   STB  R11,LUSTAT,R12,
         LIS  R11,0
         STH  R11,PTDELY,R12,R12
         STH  R11,PRNTCT,R12,R12
         SLLS R12,1
         L    R11,FASTC,,
         ST   R7,LUTIME,R12,R12
         SRLS R12,1
         SBT  R12,ONEPRT              :MARK FACT THAT ONLY 1 PRINT FILE TO SND
         LIS  R12,1
         AM   R12,TMSTUF              :INDICATE THAT TIMER IS RUNNING
         JR   R4

:----  COME HERE WHEN +RSP RECEIVED FOR LAST CHAIN ELEMENT IN PRINT FILE ---:
CMTNXT   LHI  R11,17                  :RESET PRINTER LUSTATE TO IDLE
         STB  R11,LUSTAT,R2,
         SIS  R2,1
         LHI  R13,14
         STH  R13,APPLIC
         LA   R15,UNLKBD,,           :SEND MESSAGE TO UNLOCK KEYBOARD
         LHI  R14,UNLKBL
         JAL  R7,BLDFRM
         LHI  R7,46
         STB  R7,LUSTAT,R2,
         AIS  R2,1                   :CONVERT BACK TO PRINTER LU#
         JR   R4

:--- come here after single page LU.T1 w/pacing finishes ---:
CMTNXL   JAL  R13,FNDLPU
         JAL  R4,CMTNXT
         J    CKLUT4





:[?][?][?][?][?][?][?][?][?][?][?][?][?][?][?][?][?][?][?][?]
: COME HERE TO SEND 1st PART OF SCREEN 04
BLDSC4   TBT  R2,MANUAL,,             
         JNR  R4
         LA   R15,SCRN40,,
         LHI  R14,SCRL40
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LHI  R7,24                   :WILL BECOME 25 WHEN SENT
         STB  R7,LUSTAT,R2,
         JR   R4

:(#)(#)(#)(#)(#)(#)(#)(#)(#)(#)(#)(#)(#)(#)(#)(#)(#)(#)(#)(#)(#)(#)
: COME HERE TO SEND SECOND PART OF SCREEN 04

BLDS41   TBT  R2,MANUAL,,
         JNR  R4
         LA   R15,SCRN41,,
         LHI  R14,SCRL41
         LHI  R13,14
         STH  R13,APPLIC
         LCS  R13,1
         AHM  R13,LUSNF,R2,R2         :MULTI-SEGS HAVE SAME SNF
         JAL  R7,BLDFRM
         LA   R15,SCRN42,,
         LHI  R14,SCRL42
         LCS  R13,1
         AHM  R13,LUSNF,R2,R2
         JAL  R7,BLDFRM
         LA   R15,SCRN43,,
         LHI  R14,SCRL43
         LCS  R13,1
         AHM  R13,LUSNF,R2,R2
         JAL  R7,BLDFRM
         LA   R15,SCRN44,,            :1st SEG, LAST CHAIN, PACING REQ
         LHI  R14,SCRL44
         JAL  R7,BLDFRM               :SEND AND WAIT FOR +RSP TO PACING
         LHI  R7,26                   :WILL BECOME 26 WHEN SENT
         STB  R7,LUSTAT,R2,
         JR   R4

:.$.$.$.$.$.$.$.$.$.$.$.$.$.$.$.$.$.$.$.$.$.$
: COME HERE TO SEND THE LAST PART OF SCREEN 4

BLDS42   LCS R13,1
         AHM R13,LUSNF,R2,R2          :NEED SNF USED LAST TIME
         LA  R15,SCRN45,,
         LHI R14,SCRL45
         JAL R7,BLDFRM
         LHI R7,28
         STB R7,LUSTAT,R2,
         JR  R4



:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:
:=:  COME HERE WHEN PF6 IS ENTERED AND DETERMINE WHETHER TO SEND    :=:
:=:  SCREEN 7 OR SCREEN 8.                                          :=:
:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:

BLDSC6   TBT  R2,MANUAL
         JNR  R4
         LHI  R13,14
         STH  R13,APPLIC
         CBT  R2,SC78ARY,,           :DECIDE WHICH SCREEN TO SEND
         JN   BLDS65                 :GO SEND SCREEN 8
JQJ      EQ   70
         RE 4
         LA   R15,SCRN|JQJ|,,
         LHI  R14,SCRL|JQJ|
         JAL  R7,BLDFRM
JQJ      EQ   JQJ+1
         ER
         LHI  R7,46                  :GENERIC "SEND" COMMAND
         STB  R7,LUSTAT,R2,
         JR   R4

BLDS65   EQ   .
JQJ      EQ   80
         RE 4
         LA   R15,SCRN|JQJ|,,
         LHI  R14,SCRL|JQJ|
         JAL  R7,BLDFRM
JQJ      EQ   JQJ+1
         ER
         LHI  R7,46
         STB  R7,LUSTAT,R2,
         JR   R4



::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::   come here to send SCREEN 7 for CMT stress testing              :::
::: (one of two screens, the other is screen 8)                      :::
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

BLDSC7   TBT  R2,MANUAL
         JNR  R4
         JAL  R13,FNDLPU            :NEEDED CUZ CALLED BY CKLUT2 SOMETIMES
         LA   R15,SCRN70,,
         LHI  R14,SCRL70
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LA   R15,SCRN71,,
         LHI  R14,SCRL71
         JAL  R7,BLDFRM
         LA   R15,SCRN72,,
         LHI  R14,SCRL72
         JAL  R7,BLDFRM
         LA   R15,SCRN73,,
         LHI  R14,SCRL73
         JAL  R7,BLDFRM
         LHI  R7,38                   :LOOK FOR +RSP & STATE 39, START TIMER
         STB  R7,LUSTAT,R2,
         JR   R4

:=========================================================================
: COME HERE FROM CKLUT1 TO SEND SECOND SCREEN IN CMT STRESS TESTING
BLDSC8  TBT  R2,MANUAL
        JNR  R4
        JAL  R13,FNDLPU              :NEED CUZ CALLED FROM CHKLTM
        LA   R15,SCRN80,,
        LHI  R14,SCRL80
        LHI  R13,14
        STH  R13,APPLIC
        JAL  R7,BLDFRM
        LA   R15,SCRN81,,
        LHI  R14,SCRL81
        JAL  R7,BLDFRM
        LA   R15,SCRN82,,
        LHI  R14,SCRL82
        JAL  R7,BLDFRM
        LA   R15,SCRN83,,
        LHI  R14,SCRL83
        JAL  R7,BLDFRM
        LHI  R7,3B
        STB  R7,LUSTAT,R2,
        JR   R4

:==========================================================================
: come here when +RSP is received for screen 7 or 8.  Change to "timer"
: state and arm timer.

CMTTMR   LHI  R7,CMTDLY                :DELAY BETWEEN SCREENS TO CMT
         LR   R11,R2
         SLLS R11,1
         L    R12,FASTC,,
         AR   R12,R7
         ST   R12,LUTIME,R11,R11
         LB   R12,LUSTAT,R2,           :GET LU STATE
         NHI  R12,7F
         AIS  R12,1                    :START TIMER FOR CKLUTM
         STB  R12,LUSTAT,R2,
         LIS  R12,1
         AM   R12,TMSTUF               :START TIMER
         JR   R4




:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::   COME HERE WHEN A PF5 IS ENTERED AND SEND A SCREEN WITH A 
:::   PACING REQUEST (LIKE FORD DOES)
BLDPSC   TBT  R2,MANUAL
         JNR  R4
         LHI  R14,PSC50L
         LA   R15,PSCR50,,
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LCS  R7,1
         AHM  R7,LUSNF,R2,R2
         LHI  R7,5E
         STB  R7,LUSTAT,R2,
         JR   R4

:--- COME HERE WHEN +RSP TO PACING FOR THIS SCREEN ARRIVES ---:
RSTSPC   TBT  R2,MANUAL
         JNR  R4
         LHI  R14,PSC51L
         LA   R15,PSCR51,,
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LCS  R7,1
         AHM  R7,LUSNF,R2,R2
         LHI  R14,PSC52L
         LA   R15,PSCR52,,
         JAL  R7,BLDFRM 
         LCS  R7,1
         AHM  R7,LUSNF,R2,R2
         LHI  R14,PSC53L
         LA   R15,PSCR53,,
         JAL  R7,BLDFRM
         LHI  R7,46
         STB  R7,LUSTAT,R2,
         JR   R4


:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE SENDS PRINT RECORDS TO THE PRINTER

BLDPRT   LB   R13,LUSTAT,R2,          :SEE IF PRINT1 OR PRINT2 REQUESTED
         CHI  R13,64
         JGE  BLDP03                  :PRINT03 IS >=64
         CHI  R13,42                  :42=1 PAGE LU1 WITH PACING
         JE   BLDP03
         JAL  R13,FNDLPU
         LA   R15,PRINT1,,
         LHI  R14,PRNTZ1
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LIS  R7,1
         AHM  R7,PRNTCT,R2,R2         :INCREMENT NUMBER OF RECORDS SENT
         LHI  R7,PRTDL2               :DELAY BETWEEN PRINT RECORDS
         STH  R7,PTDELY,R2,R2
         SLLS R2,2
         L    R7,FASTC,,
         ST   R7,LUTIME,R2,
         SRLS R2,2
         LHI  R7,51                   :TELL FOREGROUND TO SEND THIS
         STB  R7,LUSTAT,R2,
         LIS  R7,1
         AM   R7,TMSTUF               :INDICATE TIMER RUNNING
         J    CKLUT4




::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: THIS SENDS THE BEGIN CHAIN FOR PRINT3

BLDP03   CHI  R13,66                  :TIME TO SEND REST OF PRINT3?
         JE   BLDP31
         LHI  R14,80                  :BEGIN BRACK IND
         SBT  R2,FRSTPJ               :1st PRNT JOB SINCE LOGON?
         JEFS .+4
         LIS  R14,0
         STB  R14,P3BC+$A12,,         :SET IND
         LHI  R14,0B0
         RBT  R2,PACIND               :NO PACING
         CHI  R13,42                  :PACING REQUESTED?
         JNFS BLDP13
         LHI  R14,0B1                 :SET PACING IND.
         SBT  R2,PACIND               :SHOW PACING WAS REQUESTED
BLDP13   STB  R14,P3BC+0B,,           :set pacing ind. accordingly
         JAL  R13,FNDLPU
         LA   R15,P3BC,,
         LHI  R14,P3BCLN
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LB   R7,LUSTAT,R2,
         AIS  R7,1                    :F.G. WILL SEND THIS (WILL BE 43 OR 65)
         STB  R7,LUSTAT,R2,
         LHI  R7,$A1200               :WAIT 2 SECS
         STH  R7,PTDELY,R2,R2
         SLLS R2,2
         L    R7,FASTC,,
         ST   R7,LUTIME,R2,
         SRLS R2,2
         LIS  R7,1
         AM   R7,TMSTUF               :INDICATE A TIMER IS RUNNING
         J    CKLUT4

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: COME HERE TO SEND THE FIRST GROUP OF 4 FRAMES FOR PRINT 3

BLDP31   LA   R15,PRNT30,,
         ST   R15,ADDP30
         LHI  R15,$A256+13
         STH  R15,FIRSTZ
         LA   R15,PRNT31,,
         ST   R15,ADDP31
         LHI  R15,$A256+10
         STH  R15,SCNDSZ
         LA   R15,PRNT32,,
         ST   R15,ADDP32
         LHI  R15,$A256+10
         STH  R15,THRDSZ
         LA   R15,PRNT33,,
         ST   R15,ADDP33
         LHI  R15,$A256+10
         STH  R15,LASTSZ
         JAL  R7,SNDP30
         LHI  R7,67
         STB  R7,LUSTAT,R2,
         LIS  R7,1
         AM   R7,TMSTUF               :INDICATE TIMER RUNNING
         J    CKLUT4

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: COME HERE FROM CHKLU ROUTINE TO SEND SECOND GROUP OF PRINT3

BLDP32   LA   R15,PRNT04,,
         ST   R15,ADDP30
         LA   R15,PRNT05,,
         ST    R15,ADDP31
         LA    R15,PRNT06,,
         ST    R15,ADDP32
         LA    R15,PRNT07,,
         ST    R15,ADDP33
         LCS   R7,1
         AM    R7,TMSTUF              :INDICATE TIMER EXPIRED
         JAL   R7,SNDP30
         LHI   R7,69
         STB   R7,LUSTAT,R2,
         LIS   R7,1
         AM    R7,TMSTUF              :INDICATE TIMER ARMED
         J     CKLUT4

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: COME HERE FROM CHKLU ROUTINE TO SEND THIRD GROUP OF 4 PRINT3 FRAMES

BLDP33   LA   R15,PRNT08,,
         ST   R15,ADDP30
         LA   R15,PRNT09,,
         ST   R15,ADDP31
         LA   R15,PRNT10,,
         ST   R15,ADDP32
         LA   R15,PRNT11,,
         ST   R15,ADDP33
         LCS  R7,1
         AM   R7,TMSTUF
         JAL  R7,SNDP30
         LHI  R7,6B
         STB  R7,LUSTAT,R2,
         LIS  R7,1
         AM   R7,TMSTUF
         J    CKLUT4

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  COME HERE FROM CKLUT TO SEND LAST OF GROUP4 PRINT3 FRAMES

BLDP34   LA  R15,PRNT12,,
         ST  R15,ADDP30
         LA  R15,PRNT13,,
         ST  R15,ADDP31
         LA  R15,PRNT14,,
         ST  R15,ADDP32
         LA  R15,PRNT15,,
         ST  R15,ADDP33
         LHI R15,$A256+10
         STH R15,LASTSZ               :SIZE OF LAST SEGMENT
         LCS R7,1
         AM  R7,TMSTUF
         JAL R7,SNDP30
         LHI R7,6D
         STB R7,LUSTAT,R2,
         LIS R7,1
         AM  R7,TMSTUF
         J   CKLUT4

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: THIS IS REALLY THE LAST GROUP OF 4 FRAMES FOR PRINT3

BLDP35   LA  R15,PRNT16,,
         ST  R15,ADDP30
         LHI R15,$A69+13
         STH R15,FIRSTZ               :SIZE OF FIRST SEGMENT
         LA  R15,PRNT6A,,
         ST  R15,ADDP31
         LHI R15,$A1+10
         STH R15,SCNDSZ
         LA  R15,PRNT6B,,
         ST  R15,ADDP32
         LHI R15,$A186+10
         STH R15,THRDSZ
         LA  R15,PRNT17,,
         ST  R15,ADDP33
         LHI R15,$A256+10
         STH R15,LASTSZ
         LCS R7,1
         AM  R7,TMSTUF
         JAL R7,SNDP30
         LHI R7,6F
         STB R7,LUSTAT,R2,
         LIS R7,1
         AM  R7,TMSTUF
         J   CKLUT4

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: COME HERE TO SEND THE LAST 2 FRAMES OF PRINT 3

BLDP36   JAL  R13,FNDLPU
         LHI  R14,0A0                 :REQUEST DEF RSP
         TBT  R2,PACIND               :USING PACING?
         JEFS BLP36X                  :NO
         LHI  R14,0B0                 :USING PACING, DON'T NEED DEF RSP
BLP36X   STB  R14,PRNT18+0B,,
         LA   R15,PRNT18,,
         LHI  R14,$A256+13
         JAL  R7,BLDFRM
         LCS  R7,1
         AHM  R7,LUSNF,R2,R2
         LA   R15,PRNT19,,
         LHI  R14,$A114+10
         JAL  R7,BLDFRM
         LHI  R7,71                   :TELL F.G. THIS IS LAST OF GROUP
         TBT  R2,PACIND               :USING PACING?
         JE   BLP36Y
         LHI  R7,48                   :CKLUTM will send to CMTNXT when 49
         RBT  R2,ONEPRT               :ONLY ONE PRINT FILE?
         JN   BLP36Y
         LHI  R7,41                   :CKLUTM will send to STRPRT when 42
BLP36Y   STB  R7,LUSTAT,R2,
         LCS  R7,1
         AM   R7,TMSTUF
         J    CKLUT4

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::: BEGIN CHAIN WAS SENT FROM BLDP03 AND NOW SEND CHAINS

SNDP30   ST   R7,SAVP7
         JAL  R13,FNDLPU
         L    R15,ADDP30
         LH   R14,FIRSTZ
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LCS  R7,1
         AHM  R7,LUSNF,R2,R2
         L    R15,ADDP31
         LH   R14,SCNDSZ
         JAL  R7,BLDFRM
         LCS  R7,1
         AHM  R7,LUSNF,R2,R2
         L    R15,ADDP32
         LH   R14,THRDSZ
         JAL  R7,BLDFRM
         LCS  R7,1
         AHM  R7,LUSNF,R2,R2
         L    R15,ADDP33
         LH   R14,LASTSZ              :SIZE OF LAST SEGMENT
         JAL  R7,BLDFRM
         LIS  R7,1
         AHM  R7,PRNTCT,R2,R2
         L    R7,SAVP7
         JR   R7

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: COME HERE TO CHANGE STATE TO START PRINT 3 AGAIN

P3PRSP   RBT  R2,ONEPRT               :ONLY ONE PRINT FILE REQUESTED (PF10)
         JN   CMTNXT
         LR   R7,R2
         SIS  R7,1                    :FIND CRT LU #
         TBT  R7,CMTARY               :ALTERNATING LU1 PRINT & CRT SCREENS?
         JN   CM3RSP
         LHI  R7,64
         STB  R7,LUSTAT,R2,
         LIS  R7,1
         AM   R7,TMSTUF               :INDICATE TIMER IS RUNNING
         JR   R4

CM3RSP   ST   R2,HOLDB2
         LR   R2,R7
         CBT  R2,SC78ARY,,            :SEE WHICH SCREEN (7 or 8) TO SEND
         JN   CM3S80
         LA   R15,SCRN70,,
         LHI  R14,SCRL70
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LA   R15,SCRN71,,
         LHI  R14,SCRL71
         JAL  R7,BLDFRM
         LA   R15,SCRN72,,
         LHI  R14,SCRL72
         JAL  R7,BLDFRM
         LA   R15,SCRN73,,
         LHI  R14,SCRL73
         JAL  R7,BLDFRM
         LHI  R7,2A                   :SEND SC7. WHEN RSP COMES AND STATE IS
         STB  R7,LUSTAT,R2,           :2B GO TO P3PCMT TO SEND MORE LU 1 DATA
         L    R2,HOLDB2,,
         JR   R4
CM3S80   LA   R15,SCRN80,,
         LHI  R14,SCRL80
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LA   R15,SCRN81,,
         LHI  R14,SCRL81
         JAL  R7,BLDFRM
         LA   R15,SCRN82,,
         LHI  R14,SCRL82
         JAL  R7,BLDFRM
         LA   R15,SCRN83,,
         LHI  R14,SCRL83
         JAL  R7,BLDFRM
         LHI  R7,2C                   :SEND SC8.  WHEN RSP COMES AND STATE IS
         STB  R7,LUSTAT,R2,           :2D GO TO P3PCMT TO SEND MORE LU1 DATA
         L    R2,HOLDB2,,
         JR   R4

:-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-
:COME HERE WHEN +RSP IS RECEIVED FOR SC7 OR SC8
:AND LUSTATE IS 2B OR 2D.  SEND LU1 PRINT AGAIN
P3PCMT   LR   R7,R2
         AIS  R7,1                    :CONVER TO PRINTER LU
         LHI  R11,64                  :THIS IS CHECKED IN CKLUTM
         STB  R11,LUSTAT,R7,
         JR   R4

:=========================================================================
: THIS ERROR ROUTINE IS CALLED IF THE PRINTER IS NOT CONFIGURED

BLDER2   JAL  R13,FNDLPU
         LA   R15,ERSC02,,
         LHI  R14,ERSCZ2
         J    BLDSCX

:==========================================================================
: THIS ERROR ROUTINE IS CALLED IF THE PRINTER IS NOT LOGGED IN

BLDER3   JAL  R13,FNDLPU
         LA   R15,ERSC03,,
         LHI  R14,ERSCZ3
         J    BLDSCX




:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE IS CALLED WHEN THE PRINTER HAS BEEN REQUESTED.  IT  :::
:::  CHECKS TO SEE IF THE INITIAL DELAY "PTDELY" IS EXPIRED AND CHECKS ::
:::  TO SEE HOW MANY MORE PRINT RECORDS NEED TO BE SENT               :::

STRPRT   LR   R3,R2
         SLLS R3,2
         L    R11,FASTC,,
         L    R12,LUTIME,R3,
         SR   R11,R12
         LH   R12,PTDELY,R2,R2        :WAIT TIME
         CR   R11,R12                 :INITIAL DELAY UP?
         JL   CKLUT4                  :NO
         LCS  R11,1
         AM   R11,TMSTUF              :REMOVE THIS FROM ACTIVE TIMER LIST
         LHL  R11,PRNTCT,R2,R2        :GET NUMBER OF PRINT RECORDS LEFT
         CHI  R11,PRTREC              :ALL SENT
         JL   BLDPRT                  :NOT YET
         LHI  R7,17                   :IF YES, RETURN PRINTER TO IDLE STATE
         STB  R7,LUSTAT,R2,
         LHI  R7,60                   :SET REQUESTING CRT TO "TIMER RUNNING"
         LH   R11,REQCRT,R2,R2        :FOR "FINISHED" MESSAGE
         STB  R7,LUSTAT,R11,
         SLLS R11,2
         L    R7,FASTC,,
         ST   R7,LUTIME,R11,          :START TIMER FOR REQUESTING CRT
         LIS  R7,1
         AM   R7,TMSTUF               :INDICATE TIMER RUNNING
         J    CKLUT4

:==========================================================================
: THIS ROUTINE CHECKS TO SEE IF IT'S TIME TO INFORM THE REQUESTING CRT IF
: THE PRINT JOB IS FINISHED

INFRCT   LR   R3,R2
         SLLS R3,2
         L    R11,FASTC,,
         L    R12,LUTIME,R3,
         SR   R11,R12
         CHI  R11,PRTDL1              :TIME UP?
         JL   CKLUT4
         JAL  R13,FNDLPU
         LA   R15,ENDPMG,,
         LHI  R14,ENDPMZ
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LHI  R7,62                   :TELL FOREGROUND TO SEND MESSAGE
         STB  R7,LUSTAT,R2,
         LIS  R7,0
         STH  R7,PRNTCT,R2,R2         :INITIALIZE PRINT COUNT
         LCS  R7,1
         AM   R7,TMSTUF               :REMOVE THIS FROM TIMER LIST
         J    CKLUT4


:---------------------------------------------------------------------------





:=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
: THIS ROUTINE BUILDS A BIND AND A +RSP TO
: VTAM LOGON IF REQUIRED.
BLDLGN   LIS  R13,3
         LIS  R7,1
         TBT  R2,MANUAL,,
         JNR  R4
         TBT  R2,LU3ARY               :LU.T3?
         JN   BLDLG3                  :YES
         LIS  R13,2
         TBT  R2,LU1ARY               :LU.T1?
         JE   BLDLG2                  :NO
         LIS  R13,1
BLDLG3   LHI  R15,01E8                :PACING & SEC MAX SEND RU SIZE
         LI   R14,0C601               :PRI MAX SEND RU SIZE & PACING STUFF
         J    BLDLG6
BLDLG2   LHI  R15,0185                :NO PACING & 256 MAX RU
         LI   R14,8501                :MAX RU 256 & MORE NO PACING STUFF
BLDLG6   STB  R13,BINDBF+$A27         :SAVE LU TYPE
         STH  R15,BINDBF+$A22         :BIND BYTES 9&10
         STH  R14,BINDBF+$A24         :BIND BYTES 11 & 12
         STB  R7,BINDBF+$A26
         LA   R15,BINDBF
         LHI  R14,28
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         RBT  R2,DRPSCP               :DOES VTAM LOGON NEED +RSP?
         JE   BLDLG9                  :NO
         LIS  R13,0
         STH  R13,APPLIC
         LA   R15,VTMRSP
         LHI  R14,VTMRSL
         JAL  R13,SWBSNF
         JAL  R7,BLDFRM
         LHL  R7,HLBSNF
         STH  R7,LUSNF,R2,R2
BLDLG9   LHI  R7,46                   :TELL F.G. TO SEND THIS STUFF 
         STB  R7,LUSTAT,R2,
         JR   R4

:=======================================================================
:=== THIS ROUTINE BUILDS A BIND REQUEST 

BLDBND   LIS  R13,3                   :LU TYPE 3
         LIS  R7,1                    :PACING STUFF
         TBT  R2,LU3ARY               :IS IT LU TYPE 3?
         JN   BLBNL3                  :YES
         LIS  R13,2                   :LU TYPE 2
         TBT  R2,LU1ARY               :SEE IF LU TYPE 1
         JE   BLBNL2                  :GO CONSTRUCT LU TYPE 2 BIND
         LIS  R13,01                  :LU TYPE
BLBNL3   LHI  R15,01E8                :PACING & SEC MAX SEND RU SIZE
         LI   R14,0C601               :PRI MAX SEND RU SIZE & PACING STUFF
         RBT  R2,FRSTPJ               :CLEAR "1st PRINT JOB SINCE LOGON" FLAG
         J    BLDBN6
BLBNL2   LHI  R15,0185                :PACING FOR SEC. AND MAX RU 256
         LI   R14,8501                :MAX RU 256 FOR PRIMARY AND PACING
         IF PKTSIZ-$A512
         LHI  R15,0186                :PACING & MAX RU=512
         LI   R14,8601                :MORE OF THE SAME
         EI 
BLDBN6   STB  R13,BINDBF+$A27         :SAVE LU TYPE
         STH  R15,BINDBF+$A22         :BIND BYTES 9 & 10
         STH  R14,BINDBF+$A24         :BIND BYTES 11 & 12
         STB  R7,BINDBF+$A26          :BIND BYTE 13 (PACING STUFF FROM PRI.)
         LA   R15,BINDBF              :ADDRESS OF TEMPLATE BUFFER
         LHI  R14,28                  :LENGTH OF BIND+2
         LHI  R13,14
         STH  R13,APPLIC              :ADDRESS OF APPLIC (FAIRLY ARBITRARY)
         JAL  R7,BLDFRM               :GO BUILD BIND FRAME
         RBT  R2,DRPSCP               :SEE IF NOTIFY NEEDS RESPONSE
         JE   BLDBN9                  :NO
         LIS  R13,0
         STH  R13,APPLIC              :SSCP
         LA   R15,NTFBUF
         LHI  R14,NTFBFL
         JAL  R13,SWBSNF
         JAL  R7,BLDFRM
         LHL  R7,HLBSNF
         STH  R7,LUSNF,R2,R2
BLDBN9   LHI  R7,46                   :TELL F.G. TO SEND THIS STUFF
         STB  R7,LUSTAT,R2,
         JR   R4


:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:
:-:  THIS ROUTINE BUILDS AN UNBIND WITH A "01" - NORMAL END OF SESSION

BLDUBN   TBT R2,MANUAL,,
         JNR R4
         LA  R15,UNBNBF
         LHI R14,UNBNLN
         LHI R13,14
         STH R13,APPLIC
         JAL R7,BLDFRM
         IF RSHUTD
         RBT R2,DRPDLU                :SEE IF REQSHUTD NEEDS +RSP
         ELSE
         RBT R2,DRPSCP                :SEE IF TERMSELF NEEDS +RSP
         EI (RSHUTD)
         JE  BLDUB4                   :NO
         IF RSHUTD
         LA  R15,SHDRSP
         LHI R14,SHDLEN
         LHI R13,14
         ELSE
         LA  R15,TRMSRP
         LHI R14,TRMLEN
         LIS R13,0                    :SSCP-LU
         EI
         STH R13,APPLIC
         JAL R13,SWBSNF
         JAL R7,BLDFRM
         LHL R13,HLBSNF
         STH R13,LUSNF,R2,R2
BLDUB4   LHI R7,24                    :TELL F.G. TO SEND THIS JUNK
         STB R7,LUSTAT,R2,
         JR  R4

:======================================================================
:  COME HERE BECAUSE UNDECIDED WHAT TO DO WITH THIS RSP/REQ

BLDXXX   JR   R4


:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::   SEND OUT THE NOTIFICATION-OF-LOGOFF SCREEN AND REQUEST DEFINITE   :::
:::   RESPONSE.  CHANGE STATE TO 0E2, WHEN +RSP COMES BACK, SEND UNBIND :::

BLDLGF   JAL  R13,FNDLPU
         LA   R15,OFFSCN
         LHI  R14,OFFSCZ
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LHI  R7,1B 
         STB  R7,LUSTAT,R2,
         JR   R4


:========================================================================
: THSI ROUTINE SENDS OUT A BRACKET BID

BLDBID   TBT  R2,MANUAL               :SEE IF MANUAL OVERRIDE (CONTROL-O)
         JNR  R4
         TBT  R2,LU1ARY               :SEE IF THIS IS LU TYP 1
         JNR  R4                      :IF YES, DON'T SEND BID
         TBT  R2,LU3ARY               :SEE IF THIS IS LU TYPE 3
         JNR  R4                      :IF YES, DON'T SEND BID
         LA   R15,DFCBID
         LIS  R14,0E
         LHI  R13,14
         STH  R13,APPLIC
         LB   R13,BIDRJC,R2
         CHI  R13,1
         JGR  R4
         JAL  R7,BLDFRM
         LHI  R7,30
         STB  R7,LUSTAT,R2,           :30=TELL F.G. TO SEND BID
         JR   R4

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: THIS SENDS A DUMMY RU WITH CDI SET SO HIF CAN SEND MORE CMH DATA

         IF VTAMRF
BLDUMY   JAL  R13,FNDLPU
         LA   R15,FMDUMY
         LHI  R14,DUMLEN
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LHI  R7,1E                   :SEND MANUAL DATA
         STB  R7,LUSTAT,R2,
         LIS  R7,1
         AHM  R7,FMDCTR,R2,R2         :COUNT DUMMY RESPONSES SENT
         JR   R4
         ELSE
BLDUMY   JR    R4
         EI (VTAMRF)



:@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
:@ THIS ROUTINE SENDS A +RSP TO A SHUTC

RSHUTC   TBT   R2,MANUAL
         JNR   R4
         JAL   R13,FNDLPU
         LA    R15,SHUTCR
         LHI   R14,SHCLEN
         LHI   R13,14
         STH   R13,APPLIC
         LH    R7,LUSNF,R2,R2
         STH   R7,TMPSNF
         LH    R7,SNFLU,R2,R2
         STH   R7,LUSNF,R2,R2
         JAL   R7,BLDFRM
         LH    R7,TMPSNF
         STH   R7,LUSNF,R2,R2
         LHI   R7,4C                  :USE "ERROR SCREEN 1" CODE
         STH   R7,LUSTAT,R2,
         JR    R4

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  COME HERE IF PF3 SCREEN DEFINED IN THE T01 FILE

         IF PF3DEF
BLDPF3   JAL  R13,FNDLPU
         ST   R8,HOLD8
Q        EQ   0
         RE PF3SCN
         LA   R15,PF300|Q|
         LHI  R14,PF3L0|Q|
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
Q        EQ   Q+1
         ER
         L    R8,HOLD8
         LHI  R7,46                   :TELL F.G. TO SEND THIS JUNK
         STB  R7,LUSTAT,R2,
         JR   R4
         EI (PF3DEF)



::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE SENDS BACK A POSITIVE RESPONSE TO A TERMSELF         :::
:::  OR A REQUEST SHUTDOWN, DEPENDING ON THE GEN OPTION RSHUTD         :::

         IF RSHUTD
BLDRRP   HS   0
         ELSE
BLDTRP   HS   0
         EI (RSHUTD)
         TBT  R2,MANUAL               :MANUAL OVERRIDE IN EFFECT?
         JNR  R4                      :YES, DO NOTHING
         LIS  R13,1                   :SECOND BIT OF "WAITBT" IS FOR NOT
         TBT  R13,WAITBT,,            :SENDING RSP TO TERMSELF/RSHUTD
         JNR  R4
         JAL  R13,FNDLPU
         IF RSHUTD
         LA   R15,SHDRSP
         LHI  R14,SHDLEN
         LHI  R13,14
         ELSE
         LA   R15,TRMSRP
         LHI  R14,TRMLEN
         LIS  R13,0
         EI (RHSUTD)
         STH  R13,APPLIC
         LH   R7,LUSNF,R2,R2          :SAVE SNF AND USE THE SNF THAT THE
         STH  R7,TMPSNF               :SNA HIF USED IN ITS TERMSELF OR
         LH   R7,SNFLU,R2,R2          :REQUEST SHUTDOWN
         STH  R7,LUSNF,R2,R2
         JAL  R7,BLDFRM
         LH   R7,TMPSNF
         STH  R7,LUSNF,R2,R2
         LHI  R7,36                   :SET STATE TO "SEND RSP" & ARM THE
         STB  R7,LUSTAT,R2,           :"UNBIND-REQUEST" TIMER
         SLLS R2,2
         L    R7,FASTC,,
         ST   R7,LUTIME,R2,
         SRLS R2,2
         LIS  R7,1
         AM   R7,TMSTUF               :INDICATE TIMER RUNNING
         JR   R4

:=========================================================================
:= THIS ROUTINE BUILDS THE DE-ACTIVATE LU REQUEST

BLDDAL   TBT  R2,MANUAL               :SEE IF MANUAL OVERRIDE IS IN EFFECT
         JNR  R4                      :YES, DON'T SEND AUTO RESPONSE
         JAL  R13,FNDLPU
         LA   R15,DALBUF
         LHI  R14,DALLEN
         LIS  R13,0
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LB   R7,LUSTAT,R2,
         AIS  R7,3
         STB  R7,LUSTAT,R2,           :FOLLOWING UBND RSP, THIS WILL BE 0D8
         JR   R4



:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE BUILDS THE SDT REQ

BLDSDT   TBT  R2,MANUAL               :SEE IF MANUAL OVERRIDE IS IN EFFECT
         JNR  R4                      :YES, DON'T SEND AUTOMATIC RESPONSE
         LA   R15,SDTBUF              :ADDRESS OF TEMPLATE (FOR BLDFRM)
         LIS  R14,0E                  :LENGTH OF SDT+2
         LHI  R13,14                  :ARBITRARY APPLIC OAF
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LIS  R7,1                    :START SEQ NUM'S AT 1 AFTER SDT
         STH  R7,LUSNF,R2,R2
         IF BRBID
         LHI  R7,46                   :TELL F.G. TO SEND THIS JUNK
         TBT  R2,LU1ARY               :DON'T SEND BID FOR PRINTER
         JN   BLDSD2
         TBT  R2,LU3ARY
         JN   BLDSD2
         LA   R15,DFCBID
         LIS  R14,0E
         JAL  R7,BLDFRM
         LHI  R7,30
         ELSE
         LHI  R7,30
         EI
BLDSD2   STB  R7,LUSTAT,R2,
         JR   R4

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: THIS ROUTINE SENDS A NOTICE TO THE USER THAT THE WSRQ CANNED RESPONSE :::
::: WAS RECEIVED FROM THE HIF, IT ALSO UNLOCKS THE USER'S KEYBOARD        :::
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

BLDWSR   JAL  R13,FNDLPU
         LA   R15,BUFWSR
         LHI  R14,BUFWSZ
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LHI  R7,46                   :THIS STATE WILL WORK
         STB  R7,LUSTAT,R2,
         JR   R4




::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS IS A FRAME BUILDING ROUTINE.  NEED ADDRESS OF TEMPLATE IN R15  :::
:::  LENGTH OF FRAME+2 IN R14 AND OAF IN APPLIC                          :::
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

BLDFRM  JAL  R10,STRMCK               :SEE IF ENOUGH ROOM IN SILHL#
        LHL  R9,LEADIX,R1,R1          :GET LEAD INDEX FOR THIS PU
        LR   R11,R1                   :COPY PU#
        SLLS R11,1                                  
        L    R11,SIOBBF,R11,R11       :FIND STARTING POINT OF BUFFER
        STH  R14,SIOHL0,R11,R9        :SAVE LENGTH
        LB   R13,PUADLU,R2,           :GET PU ADDRESS
        STB  R13,SIOHL0+2,R11,R9      :SAVE PU ADDRESS
        STH  R9,HLDIDX                :SAVE INDEX TO STORE SPECIFICS
        AIS  R9,4                     :START AFTER CONTROL FIELD
        SIS  R14,4                    :DECREMENT TOTAL LENGTH
        LIS  R12,4                    :START AFTER CONTROL FIELD
BLDFR2  LB   R13,0,R15,R12            :MOVE EACH BYTE TO OUTPUT SECTOR
        STB  R13,SIOHL0,R11,R9
        AIS  R12,1
        AIS  R9,1
        SIS  R14,1
        JG   BLDFR2
        LHL  R9,HLDIDX                :GET LOCAL INDEX
        IF   SYS38
        LIS  R13,0                    :SNF MUST BE 0 FOR SYS 38
        CI   R15,BINDBF               :SNF=0 FOR BIND
        JE   BLDFR4
        CI   R15,NTFBUF
        JE   BLDFR4
        CI   R15,CLERBF
        JE   BLDFR4
        LHL  R13,LUSNF,R2,R2
        ELSE
        LHL  R13,LUSNF,R2,R2
        EI
        STH  R13,SIOHL0+8,R11,R9      :SAVE SNF IN SIOHL0
        AIS  R13,1
BLDFR4  STH  R13,LUSNF,R2,R2          :UPDATE SNF FOR NON- SYS 38
        LB   R13,DAF,R2,              :GET DAF
        STB  R13,SIOHL0+6,R11,R9
        LHL  R13,APPLIC               :GET OAF
        STB  R13,SIOHL0+7,R11,R9
        LCS  R14,2                    :MAKE LENGTH MORE ACCURATE
        AHM  R14,SIOHL0,R11,R9
        LHL  R9,LEADIX,R1,R1          :GET LEADING INDEX
        AHI  R9,IFSIZE*2              :ADVANCE IT
        CI   R9,FOLDYT                :END OF BUFFER?
        JLFS .+4
        LIS  R9,0
        STH  R9,LEADIX,R1,R1
        JR   R7





:=======================================================================
: THIS ROUTINE SENDS OUT THE MULTIPLE FRAME FIRST APPLICATION SCREEN

BLDSC1   TBT  R2,MANUAL
         JNR  R4
         JAL  R13,FNDLPU
         LB   R13,PUTABA,R1,R1
         NHI  R13,7F
         LB   R13,EBCONT,R13
         STB  R13,APLPUX+4,,
         LB   R13,PUTABA+1,R1,R1
         NHI  R13,7F
         LB   R13,EBCONT,R13
         STB  R13,APLPUX+5,,
         LB   R13,LUTABA,R2,R2
         NHI  R13,7F
         LB   R13,EBCONT,R13
         STB  R13,APLPUX+0C,,
         LB   R13,LUTABA+1,R2,R2
         NHI  R13,7F
         LB   R13,EBCONT,R13
         STB  R13,APLPUX+0D,,
         LA   R15,APLSC1
         LHI  R14,APL1SZ
         LHI  R13,14
         STH  R13,APPLIC
         LIS  R6,0
         ST   R8,HOLD8
         IF   BRBID
         LHI  R13,80
         ELSE
         LHI  R13,0C0                 :BEGIN BRACKET
         EI
         JAL  R8,USEBRK               :ONLY USE BRACKETING FIRST TIME
         JAL  R7,BLDFRM
         LA   R15,APLS02
         LHI  R14,APL1Z2
         JAL  R7,BLDFRM
         LA   R15,APLS03              :LAST PART OF SCREEN
         LHI  R14,APL1Z3
         JAL  R7,BLDFRM
         LB   R7,LUSTAT,R2,
         CHI  R7,31                   :USING BRACKETS?
         JN   BLDS12                  :NO
         LA   R15,CHDIRE              :END-BRACKET INDICATOR
         LIS  R14,0D                  :SIZE
         JAL  R7,BLDFRM
BLDS12   L    R8,HOLD8
         LHI  R7,46                   :SET STATE=READY TO SEND SCREEN 1
         STB  R7,LUSTAT,R2,
         JR   R4

:------------------------------------------------------------------------

USEBRK   LB   R7,LUSTAT,R2,
         NHI  R7,7F                   :turn off "pending" bit
         CHI  R7,31                   :31=USING BRACKETS
         IF   BRBID
         JEFS .+4
         LIS  R13,0
         ELSE
         JEFS .+6
         LHI  R13,0A0
         EI   (BRBID)
         STB  R13,0C,R15              :SET BRACKET INDICATOR APPROPRIATELY
         JR   R8



::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE BUILDS MULTI-SEGMENT, NON PACING, NO BRACKET CRT     :::
:::  SCREEN 3, WITH A FINAL SINGLE SEGMENT FRAME COMING AFTER A SHORT  :::
:::  DELAY                                                             :::
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

BLDS30   JAL   R13,FNDLPU
         LA    R15,SCRN30,,
         LHI   R14,SCRZ30
         LHI   R13,14
         JAL   R7,BLDFRM
         LCS   R7,1
         AHM   R7,LUSNF,R2,R2         :USE SAME SNF FOR ALL SEGMENTS
         LA    R15,SCRN31,,
         LHI   R14,SCRZ31
         JAL   R7,BLDFRM
         LCS   R7,1
         AHM   R7,LUSNF,R2,R2         :SAME SNF
         LA    R15,SCRN31,,
         LHI   R14,SCRZ31
         JAL   R7,BLDFRM
         LCS   R7,1
         AHM   R7,LUSNF,R2,R2
         LA    R15,SCRN32,,
         LHI   R14,SCRZ32
         LIS   R7,0
         SBT   R7,LASTFM              :MARK AS LAST FRAME
         JAL   R7,BLDFRM
         LIS   R6,4
         LHI   R7,78                  :TELL F.G. TO SEND THESE GUYS
         STB   R7,LUSTAT,R2,
         LIS   R7,1
         AM    R7,TMSTUF              :PUT ON TIMER LIST
         JR    R4

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE SENDS THE LAST SINGLE SEGMENT OF SCREEN 3 AFTER SCN3TM :::
:::  TIMER EXPIRES (LUSTAT=69)

BLDLS3   JAL   R13,FNDLPU
         LA    R15,SCRN33,,
         LHI   R14,SCRZ33
         LHI   R13,14
         STH   R13,APPLIC
         JAL   R7,BLDFRM
         LHI   R7,46                  :CAN RE-USE THIS STATE
         STB   R7,LUSTAT,R2,
         JR    R4




:========================================================================
:--------------------------------------------------------------------------
: THIS ROUTINE BUILDS THE VTAM BANNER, ADDING IN THE PU ADDRESS, DAF & SNF

BLDVTM   JAL R13,FNDLPU               :GO GET REL PU # IN R1
         LA  R15,VTAMBN
         LHI R14,VTAMSZ               :SIZE OF VTAM BANNER
         LIS R13,0                    :SSCP
         STH R13,APPLIC
         JAL R7,BLDFRM
         LB  R7,LUSTAT,R2,
         AIS R7,1                     :WILL CHANGE TO 3 WHEN FIRST ACTIVE
         STB R7,LUSTAT,R2,
         JR  R4

:-------------------------------------------------------------------------
: THIS ROUTINE BUILDS A +RSP TO THE FMD LAYER

BLDFRP  JAL  R13,FNDLPU
        LA   R15,FMDRSP
        LIS  R14,0D
        LIS  R13,0
        STH  R13,APPLIC
        LH   R7,LUSNF,R2,R2
        STH  R7,TMPSNF
        LH   R7,SNFLU,R2,R2
        STH  R7,LUSNF,R2,R2
        JAL  R7,BLDFRM
        LH   R7,TMPSNF
        STH  R7,LUSNF,R2,R2
        LB   R7,LUSTAT,R2,
        AIS  R7,1
        STB  R7,LUSTAT,R2,
        JR   R4

:=========================================================================
: THIS ROUTINE BUILDS THE +RSP TO LUSTAT 082B

BLDLUR   JAL  R13,FNDLPU
         LA   R15,STATRP
         LIS  R14,0E                  :LENGTH
         LIS  R13,0
         STH  R13,APPLIC              :SSCP-LU SESSION
         LH   R7,LUSNF,R2,R2          :GET SNF
         STH  R7,TMPSNF               :SAVE IT FOR NOW
         LH   R7,SNFLU,R2,R2          :GET SNF TO USE FOR A RESPONSE
         STH  R7,LUSNF,R2,R2
         JAL  R7,BLDFRM
         LH   R7,TMPSNF               :GET REAL SNF (FOR REQ'S)
         STH  R7,LUSNF,R2,R2          :RESTORE IT
         LB   R7,LUSTAT,R2,
         AIS  R7,1
         STB  R7,LUSTAT,R2,           :CHANGES TO 5 FIRST TIME THROUGH
         JR   R4


:------------------------------------------------------------------------
: THIS ROUTINE BUILDS THE CHANGE DIRECTION FRAME

BLDCDI   JAL  R13,FNDLPU
         LA   R15,CHDIRE
         LHI  R14,0D
         LHI  R13,0
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LB   R7,LUSTAT,R2,
         AIS  R7,1
         STB  R7,LUSTAT,R2,
         JR   R4

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  RECEIVED +RSP TO DE-ACTIVATE LU REQUEST, SET LUSTAT = 0 FOR THIS :::
:::  LU.                                                              :::
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

RSTLUS   LIS  R7,0
         STB  R7,LUSTAT,R2,           :SET STATE TO LU NOT ACTIVE
         JR   R4

:=========================================================================
: THIS ROUTINE IS CALLED WHEN A "CLEAR" WAS RECEIVED.  IT STARTS THE
: CLRTIM TIMER WHICH MUST EXPIRE BEFORE SCREEN 2 IS SENT.

STS2TM   TBT  R2,MANUAL
         JNR  R4
         LR   R7,R2
         SLLS R7,2
         L    R13,FASTC,,
         ST   R13,LUTIME,R7,          :ARM LU TIMER
         LHI  R13,45                  :THIS STATE MEANS "CLEAR TIMER RUNNING"
         STB  R13,LUSTAT,R2,
         LIS  R13,1
         AM   R13,TMSTUF              :INDICATE SOMETHING WITH A TIMER IS ON
         JR   R4

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE BUILDS THE SECOND SCREEN TO SEND                     :::

BLDSC2   JAL  R13,FNDLPU
         LA   R15,SCRN20
         LHI  R14,SCRN2Z
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LB   R7,LUSTAT,R2,
         AIS  R7,1                    :CHANGE STATE TO 46 (SEND SCREEN 2)
         STB  R7,LUSTAT,R2,
         JR   R4



::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE BUILDS SCREEN 6

BLDS06   IF 1%VTAMRF                  :IF NOT GENNED FOR CMH
         LIS  R13,1
         AHM  R13,FMDCTR,R2,R2        :KEEP TRACK OF FMD FRAMES
         EI
         TBT  R2,MANUAL               :MANUAL OVERRIDE IN EFFECT?
         JNR  R4                      :1=YES
         JAL  R13,FNDLPU              :GET RELATIVE PU NUMBER IN R1
         LA   R15,SCRN60
         LHI  R14,SCRZ60              :SIZE OF SCREEN 6
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LHI  R7,46
         STB  R7,LUSTAT,R2,
         JR   R4

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: THIS ROUTINE BUILDS ERROR SCREEN 1

BLDERS   LIS  R13,1
         IF 1%VTAMRF                  :IF NOT GENNED FOR CMH
         AHM  R13,FMDCTR,R2,R2        :COUNT FMD REQ'S RECEIVED
         EI (1%VTAMRF)
         LB   R13,LUSTAT,R2,
         LB   R13,CHKTBL,R13,         :IF TIMER WAS RUNNING, TURN IT OFF
         JEFS BLDER4
         LCS  R13,1
         AM   R13,TMSTUF
BLDER4   TBT  R2,MANUAL
         JNR  R4
         JAL  R13,FNDLPU
         LA   R15,ERSC01,,
         LHI  R14,ERSCZ1
         LHI  R13,14
         STH  R13,APPLIC
         JAL  R7,BLDFRM
         LHI  R7,4C                   :CHANGE STATE TO SEND ERROR SCREEN 1
         STB  R7,LUSTAT,R2,
         JR   R4







:[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]
:[*][*]   B A C K G R O U N D   U T I L I T Y   R O U T I N E S      [*][*]
:[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]

:<!><!><!><!><!><!><!><!><!><!><!><!><!><!><!><!><!><!><!><!><!><!><!>
:<!>  THIS ROUTINE RESETS THE N(R) AND N(S) COUNTERS FOR PU IN R2  <!>
:<!>  AND ALSO SETS ALL LUs TO STATE 0                             <!>
:<!><!><!><!><!><!><!><!><!><!><!><!><!><!><!><!><!><!><!><!><!><!><!>
INTBPU   LIS  R9,0
         STB  R9,PURRNS,R2,
         STB  R9,PURRNR,R2,
INTBP1   JAL  R11,CALCIX
         LB   R8,LUPRPU,R2,
INTBP2   STB  R9,LUSTAT,R6,
         AIS  R6,1
         SIS  R8,1
         JG   INTBP2
         JR   R15

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE CHECKS TO SEE IF ALL OF THE LAST BATCH OF STUFF HAS
:::  BEEN SENT YET

CKLAST   LHI  R8,70
         LH   R9,SIOCHN,R8,            :GET COMMAND
         CHI  R9,1                     :1=NOT SENT YET
         JE   CKLDIS                  :GO TO SLEEP
         SHI  R8,10
         JGE  CKLAST+4
         JR   R11    
CKLDIS   SVC  DISMIS
         J    CKLAST



:------------------------------------------------------------------------
: THIS ROUTINE CHECKS THE STATES OF THE LU'S FOR THE PU INDEXED BY R2.
: IF IT FINDS AN LU WHICH NEEDS TO BE ACTIVATED, IT HAS A NORMAL RETURN.
: IF ALL LU'S ARE ACTIVATED, IT SETS THE PUACT STATE = 4 AND JUMPS TO
: CKRRN3.

CHKLUS   LB  R8,LUPRPU,R2,            :GET NUMBER OF LU'S PER PU
         LIS R4,0
CHKLU1   LB  R5,LUSTAT,R6,            :GET LU STATE
         CHI R5,80                    :SET TO 80 BY CONT-L
         JE  4,R11                    :FOUND ONE TO ACTIVATE
         AIS R4,1
         AIS R6,1
         CR  R4,R8
         JL  CHKLU1
         LIS R4,6
         STB R4,PUACT,R2              :SET PU STATE TO "ALL LU'S ACTIVATED"
         JR  R11


:========================================================================
: THIS ROUTINE IS CALLED IF A CHARACTER NEEDS TO BE ECHOED.
 
CHKECH   ST  R0,JAIL0                 :SAVE R0
         ST  R2,JAIL2
         LH  R5,DOECHO
         JER R10
         LIS R2,1
         STB R2,ECHST                 :PUT IN LENGTH TO BE ECHOED
         STB R0,ECHST,R2              :PUT IN CHARACTER TO ECHO
         LH  R2,RPORT
         LA  R3,ECHST
         JAL R5,OCS
         L   R0,JAIL0
         L   R2,JAIL2
         JR  R10

:--------------------------------------------------------------------------
: THIS ROUTINE FINDS THE RELATIVE PU NUMBER CORRESPONDING TO THIS LU.
: IT RETURNS WITH THE VALUE IN REGISTER R1.

FNDLPU   LB  R7,PUADLU,R2,
         LIS R1,0
FNDLP2   LB  R11,PUTAB,R1
         CR  R11,R7
         JER R13
         AIS R1,1
         CHI R1,NUMPU
         JL  FNDLP2
         HC  0,0
:-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-__--
: THIS ROUTINE PUTS THE REQ SNF IN LUSNF
: SO A RSP CAN BE SENT.
SWBSNF   LHL  R7,LUSNF,R2,R2
         STH  R7,HLBSNF
         LHL  R7,SNFLU,R2,R2
         STH  R7,LUSNF,R2,R2
         JR   R13
:~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
:!  THIS ROUTINE CHECKS TO SEE IF THERE IS ENOUGH ROOM IN SIOHL# TO
:!  PASS SOME FRAMES TO F.G.
:~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
STRMCK   LHL  R13,LEADIX,R1,R1        :GET LEADING INDEX
         AHI  R13,IFSIZE*2            :BUMP TO NEXT ENTRY
         CI   R13,FOLDYT              :END OF BUFFER?
         JLFS .+4
         LIS  R13,0
         LHL  R9,TRAILX,R1,R1         :IF POINTERS NOW EQUAL, NO ROOM LEFT
         CR   R13,R9
         JNR  R10
         STM  R0,SAVMCK
         LIS  R2,NUMPU-1
STRMC2   LB   R3,PUSTAT,R2,
         CHI  R2,0A                   :WAITING FOR FINAL BIT? 
         JNFS STRMC4
         JAL  R12,CKIFTM
STRMC4   SIS  R2,1
         JGE  STRMC2
         L    R2,SAVMCK+8
         LR   R2,R1
         JAL  R12,CKRRTM              :WILL NEVER GET THIS STUFF OUT IF RR
         LM   R0,SAVMCK               :TIMER NEVER CHECKED
         SVC  DISMIS
         J    STRMCK

:-----------------------------------------------------------------------
: THIS ROUTINE FINDS THE INDEX FOR CHKLUS BY ADDING UP THE NUMBER OF
: LU'S OF THE PREVIOUS PU'S.

CALCIX   LIS R10,0
         LIS R6,0
CALCI2   LB  R8,LUPRPU,R10,
         AR  R6,R8
         AIS R10,1
         CR  R10,R2                   :SEE IF UP TO CURRENT PU
         JLE CALCI2
         SR  R6,R8                    :DON'T ADD IN CURRENT PU COUNT
         JR  R11

:-----------------------------------------------------------------------
: THIS ROUTINE UPDATES THE N(S) COUNTER
UPBNS    LB  R8,PURRNS,R2
         AIS R8,2
         NHI R8,0F
         STB R8,PURRNS,R2
         JR  R5

:-----------------------------------------------------------------------
: THIS ROUTINE UPDATES THE SEQUENCE NUMBER FIELD (SNF) FOR THE PU
: INDEXED BY R2.

UPDSNF   LR  R6,R2                    :GET CURRENT PU #
         LIS R7,2
         MHR R6,R7
         LH  R7,SNF,R6,
         AIS R7,1                     :INCREMENT SNF
         STH R7,SNF,R6,
         JR  R5

:--------------------------------------------------------------------------
: THIS ROUTINE UPDATES THE SNF BY DECREMENTING IT

DECSNF   LR  R6,R2
         LIS R7,2
         MHR R6,R7
         LH  R7,SNF,R6,
         SIS R7,1
         STH R7,SNF,R6,
         JR  R5


:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: ESCAPE ENCOUNTERED WHEN INPUTING THE PU ADDRESS

ABRTCM   AIS  R9,1
         LH   R0,BITSIZ
         SR   R0,R9                   :REMAINING BYTES
         JAL  R4,FLUSH
         LH   R2,RPORT
         LA   R3,LEFT08
         JAL  R5,OCS
         LH   R2,RPORT
         LA   R3,PROMPT
         JAL  R5,OCS
         LIS  R5,0
         STH  R5,INPTSW
         STH  R5,CHARIX
         J    REST

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::   this routine finds the relative PU number given the PU address
GETPUN   LHI  R4,NUMPU-1
         CLB  R5,PUTAB,R4,
         JER  R13
         SIS  R4,1
         JGEBS GETPUN+4
         HC   0                         :ADDRESS WASN'T IN PUTAB


:--------------------------------------------------------------------------
BADIPT    LR  R0,R9
          JAL R4,FLUSH
BADIP2    LH  R2,RPORT
          LA  R3,LEFT03
          JAL R5,OCS
          LH  R2,RPORT
          LA  R3,PROMPT
          JAL R5,OCS
          LIS R5,0
          STH R5,INPTSW
          J   REST

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: RESET THE USER BACK TO THE COMMAND LINE

RETCM0   LR   R0,R9
         JAL  R4,FLUSH,,
RETCOM   HLPLIN(LEFT08)
         LIS  R5,0
         STH  R5,CHARIX
         STH  R5,INPTSW
         STH  R5,MODESW
         STH  R5,RUCNT
         STH  R5,MANIX
         HLPLIN(PROMPT)
         J    REST



         REMARK %   genning OPERATOR area
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  COME HERE VIA CONTROL-A TO ASK IF CONTINUOUS XIDs ARE REQUESTED

CONT1    HLPLIN(LEFT1E)
         LHI  R5,29                   :TELL IMORG TO GO TO CONTA0
         STH  R5,INPTSW
         J    REST

:---- COME HERE WITH ANSWER TO CONTINUOUS XIDs ----
CONTA0   JAL  R4,GETCH                :GET LENGTH
         LR   R9,R0
         JAL  R4,GETCH                :GET ANSWER
         LR   R4,R0
         NHI  R4,7F
         CHI  R4,1B                   :ESCAPE?
         JE   CONTAX
         CHI  R4,59
         JE   CONTAY                  :ANSWER IS YES
         CHI  R4,4E                   :ANSWER IS NO
         JE   CONTAN
         SIS  R9,1
         LR   R0,R9
         JAL  R4,FLUSH
         HLPLIN(BKSPC)
         J    REST
CONTAN   SIS  R9,1
         LR   R0,R9
         JAL  R4,FLUSH
         LIS  R4,0
         STH  R4,INPTSW
         HLPLIN(PROMPT)
         LIS  R4,0C
         STB  R4,PUSTAT               :TELL F.G. TO SEND 1 XID
         J    REST
CONTAY   SIS  R9,1
         LR   R0,R9
         JAL  R4,FLUSH
         HLPLIN(PROMPT)
         LIS  R4,0
         STH  R4,INPTSW
         LIS  R4,0D                   :TELL FOREGROUND TO SEND CONTINUOUS XID
         STB  R4,PUSTAT
         J    REST
CONTAX   SIS  R9,1
         LR   R0,R9
         JAL  R4,FLUSH
         J    RETEXC,,

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: COME HERE VIA CONTROL-B TO ASK FOR PU TO SEND TEST FRAME

CONT2    HLPLIN(LEFT02)
         LHI  R5,2B                   :TEL IMORG TO GO TO CONT20
         STH  R5,INPTSW
         J    REST

:---- COME HERE WITH ANSWER TO PU QUESTION
CONT20   JAL  R4,GETCH                :GET LENGTH
         LR   R9,R0
         JAL  R4,GETCH                :GET ANSWER
         SIS  R9,1
         NHI  R0,7F
         JAL  R10,CHKECH
         CHI  R0,1B                   :ESCAPE?
         JE   RETCM0
         CHI  R0,30
         JL   BADIPT
         CHI  R0,39
         JLE  CONT22
         CHI  R0,41
         JL   BADIPT
         CHI  R0,46
         JG   BADIPT
         NHI  R0,0F
         AIS  R0,9                    :CONVERT TO HEX
CONT22   NHI  R0,0F
         LA   R3,LEFT21               :"SENDING TEST FRAME"
         L    R5,FASTC,,
         LR   R4,R0
         SLLS R4,2
         ST   R5,TFRMTM,R4            :START TIMER
         CBT  R0,TSTFRM               :CHANGE BIT
         JEFS .+6
         LA   R3,LEFT22               :"NO LONGER SENDING"
         LH   R2,RPORT
         JAL  R5,OCS
         HLPLIN(PROMPT)
         LR   R0,R9
         JAL  R4,FLUSH
         LIS  R4,0
         STH  R4,INPTSW
         J    REST

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE STARTS OR STOPS THE RESPONSE-TIME-DATA-FRAME TRANSMISSION

CONT3    LIS  R5,0
         CBT  R5,RESPBT               :SEE IF STARTING OR STOPPING TEST
         JN   CONT39                  :STOPPING
         SBT  R5,DONTHG               :PREVENT LUSTLP PROCESSING IN F.G.
         SBT  R5,SKPLUP               :PREVENT LU PROCESSING IN B.G.
         HLPLIN(LEFT24)
         HLPLIN(PROMPT)
         LIS  R9,0
         LHI  R10,NUMPU*(1F*2)        :32LUs/PU
CONT30   STH  R9,LUSNFR,R10,
         SIS  R10,2
         JGEBS CONT30
         LIS  R10,0
         LIS  R8,2
         LIS  R7,0
CONT3Q   LHL  R11,RTFR10,R7,
         STH  R11,IOUT0,R9,
CONT31   LB   R4,RTFR10,R8,R7
         STB  R4,IOUT0,R9,R8
         AIS  R8,1
         SIS  R11,1
         JG   CONT31
         LIS  R8,2
         AHI  R9,IFSIZE*2
         AI   R7,RTFLEN
         AIS  R10,1
         CHI  R10,6
         JL   CONT3Q
         LHI  R6,NUMPU-1
         LHI  R7,15                   :STATE 15=START TEST
CONT32   LB   R8,PUSTAT,R6            :GET CURRENT STATE
         CHI  R8,0F                   :PU IN NRM?
         JEFS CONT33                  :NO, SKIP THIS GUY
         STB  R7,PUSTAT,R6
         SBT  R6,PUTXMT               :ARRAY OF NRM PUs
         SBT  R6,RRARAY,,
         LB   R8,PURRNS,R6
         STB  R8,EXPNS,R6             :INITIALIZE RSP-TIM-TST N(S)
CONT33   SIS  R6,1
         JGE  CONT32
         LIS  R6,0
CONT35   LB   R7,PUSTAT,R6
         CHI  R7,15
         JNFS CONT37
         SBT  R6,FGRTAR
         J    REST,,
CONT37   AIS  R6,1
         CHI  R6,NUMPU
         JL   CONT35
         J    REST,,
CONT39   LHI  R5,07
         LHI  R6,NUMPU-1
CONT3A   LB   R9,PUSTAT,R6
         RBT  R6,PUTXMT
         CHI  R9,15
         JNFS CONT3B
         STB  R5,PUSTAT,R6
CONT3B   SIS  R6,1
         JGEBS CONT3A
         LIS  R5,0
         RBT  R5,DONTHG
         STH  R5,PUTXMT
         HLPLIN(LEFT25)
         HLPLIN(PROMPT)
         J    REST,,

         
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

CONT4     HLPLIN(LEFT02)
          LHI R5,15
          STH R5,INPTSW
          LIS R5,0
          J   REST,,

CONT42    JAL R4,GETCH,,
          STH R0,BITSIZ
          LR  R9,R0
          JAL R4,GETCH,,
          SIS R9,1
          NHI R0,7F
          LH  R7,DOECHO
          JEFS .+6
          JAL R10,CHKECH
          CHI R0,1B                   :ESCAPE?
          JE  RETCM0
          CHI R0,58                   :X?
          JE  CONT44
          CHI R0,78
          JE  CONT44
          JAL R10,CONATH
          J   BADIPT
          CHI R0,NUMPU-1
          JG  BADIPT
CONT43    STH R0,HOLDPU               :SAVE SELECTED PU
          LHI R5,2A                   :TELL IMORG TO GO TO CONT46
          STH R5,INPTSW     
          LR  R0,R9
          JAL R4,FLUSH,,
          HLPLIN(LEFT1F)
          HLPLIN(LEFT20)
          HLPLIN(LEFT23)
          HLPLIN(LEFT2D)
          HLPLIN(LEFT2E)
          HLPLIN(LEFT36)              :DISPLAY ERROR COUNTERS
          HLPLIN(LEFT3C)              :ALTER T1 TIMER
          HLPLIN(LEFT45)              :SEND FRAME OUTSIDE WINDOW
          HLPLIN(LEFT4C)
          HLPLIN(LEFT1A)
          J   REST
CONT44    LHI R0,99                   :ALL PUs SELECTED
          J   CONT43

:---- COME WITH ANSWER TO DISC OR DACTPU QUESTION ----
CONT46    JAL  R4,GETCH,,             :GET LENGTH
          LR   R9,R0
          JAL  R4,GETCH,,
          SIS  R9,1
          JAL  R10,CHKECH
          NHI  R0,7F
          CHI  R0,1B
          JE   RETCM0
          JAL  R10,CONATH
          J    BADIPT
          CHI  R0,9                   :9=DISPLAY F.G. TRACE
          JE   C4FGDS
          CHI  R0,8                   :8=outside the window
          JE   C4OUTW
          CHI  R0,7                   :7=CHANGE T1
          JE   CNT462
          CHI  R0,6                   :6=DISPLAY ERROR COUNTERS
          JE   CNT460
          CHI  R0,5                   :5=QUERY & CHANGE DTR 
          JE   CONT4P
          CHI  R0,4                   :4=SEND NMVT
          JE   CONT4K
          CHI  R0,3                   :3=GO IDLE
          JE   CONT4A
          CHI  R0,2                   :2=DACTPU
          JE   CONT49
          LHI  R0,12                  :12=SEND DISC
          LHI  R3,07                  :7=STATUS DISPLAY DISC
          JAL  R10,CONT4F             :GO SET THE STATE
CONT47    LR   R0,R9
          JAL  R4,FLUSH,,
          LIS  R4,0
          STH  R4,INPTSW
          HLPLIN(PROMPT)
          J    REST,,

:--- come here to DE-ACTIVATE the PU ---:
CONT49    LHL  R5,HOLDPU              :GET REQUESTED PU
          LIS  R6,0
          CHI  R5,99                  :FOR ALL PUs?
          JNFS CNT492
          LHI  R6,NUMPU-1
          LR   R5,R6
CNT492    SBT  R5,PUDACR              :THIS IS CHECKED IN FNDRR 
          LIS  R3,3 
          STB  R3,PUACT,R5            :SO STATUS WILL SHOW PENDING  
          STM  R0,SAVALL
          LR   R2,R5
          JAL  R15,INTBP1             :RESET THE PU
          LM   R0,SAVALL
          SIS  R5,1
          SIS  R6,1
          JGE  CNT492
          J    CONT47

CONT4A    LHI  R3,0FE                 :0FE=STATUS DISPLAY "IDLE"
          LIS  R0,0F                  :ENTER IDLE STATE
          JAL  R10,CONT4F
          J    CONT47

:--- COME HERE TO SEND NMVT ---:
CONT4K    LHL R5,HOLDPU
          CHI R5,99                   :ALL PUs?
          JE  CONT4L
          SBT R5,NMVTAR               :CHECKED IN FNDRR
          J   CONT47
CONT4L    LIS R4,NUMPU-1
          SBT R4,NMVTAR
          SIS R4,1
          JGEBS CONT4L+2
          J   CONT47

:--- COME HERE TO QUERY/CHANGE DTR ---:
CONT4P    LIS R5,8                    :TELL IMORG TO GO TO DTRQNC
          STH R5,INPTSW
          LR  R0,R9
          JAL R4,FLUSH
          HLPLIN(LEFT2F)
          HLPLIN(LEFT30)
          HLPLIN(LEFT31)
          J   REST,,

CONT4F    LH  R2,HOLDPU
          CHI R2,99                   :ALL PUs?
          JE  CONT4X
          STB R0,PUSTAT,R2            :SET STATE
          STB R3,PUACT,R2             :SET STATUS DISPLAY STATE
          STM R0,SAVALL
          JAL R15,INTBPU              :RESET THE PU
          LM  R0,SAVALL
          JR  R10
CONT4X    LHI R2,NUMPU-1
          STB R0,PUSTAT,R2
          STB R3,PUACT,R2
          STM R0,SAVALL
          JAL R15,INTBPU              :RESET THE PU
          LM  R0,SAVALL
          SIS R2,1
          JGE CONT4X+4
          JR  R10

:---  COME HERE WITH ANSWER TO DTR CHOICES  ---:
DTRQNC    JAL  R4,GETCH,,             :GET LENGTH
          LR   R9,R0
          JAL  R4,GETCH,,             :GET ANSWER
          SIS  R9,1
          JAL  R10,CHKECH
          NHI  R0,7F
          CHI  R0,1B
          JE   RETCM0
          CHI  R0,31                  :QUERY DTR STATE?   
          JE   DTRQRY
          CHI  R0,32
          JN   BADIPT
          LIS  R8,1
          LA   R3,LEFT32              :DTR IS NOW UP
          CBT  R8,DTRARY
          JNFS DTRQN2
          LA   R3,LEFT33              :DTR IS NOW DOWN
DTRQN2    LHL  R2,RPORT
          JAL  R5,OCS,,
          SBT  R8,DONTHG              :TELL F.G. TO CHANGE DTR STATE
DTRQXX    LR   R0,R9
          JAL  R4,FLUSH,,
          LIS  R4,0
          STH  R4,INPTSW
          HLPLIN(PROMPT)
          J    REST,,
:--- COME HERE TO TELL USER STATE OF DTR ---:
DTRQRY    LIS  R8,1
          LA   R3,LEFT32
          TBT  R8,DTRARY
          JEFS DTRQR2
          LA   R3,LEFT33
DTRQR2    LHL  R2,RPORT
          JAL  R5,OCS,,
          J    DTRQXX

:---   come here to display error counters   ---:
CNT460    LR   R0,R9
          JAL  R4,FLUSH,,
          LIS  R4,0
          STH  R4,INPTSW
          STH  R4,HOLDPU
          LHI  R6,NUMPU-1
          HLPLIN(ERMG00)
          HLPLIN(ERMG01)
          HLPLIN(ERMG02)
          HLPLIN(ERMG03)
CNT461    LR   R9,R6
          LIS  R10,1
          LA   R11,ERMG04+6
          JAL  R4,BINDEC,,
          LA   R10,FRMCTR,R6,R6
          LIS  R9,2
          LA   R8,ERMG04+0A
          JAL  R4,BINHEX,,
          SLLS R6,1
          LA   R10,FRMTIM,R6,R6
          LIS  R9,4
          LA   R8,ERMG04+11
          JAL  R4,BINHEX,,
          LA   R10,REJTIM,R6,R6
          LIS  R9,4
          LA   R8,ERMG04+23
          JAL  R4,BINHEX,,
          SRLS R6,1
          LA   R10,REJCTR,R6,R6
          LIS  R9,2
          LA   R8,ERMG04+1C
          JAL  R4,BINHEX,,
          LA   R10,UNKNCT,R6,R6
          LIS  R9,2
          LA   R8,ERMG04+2E
          JAL  R4,BINHEX,,
          LA   R10,REXMCT,R6,R6
          LIS  R9,2
          LA   R8,ERMG05+2
          JAL  R4,BINHEX
          LA   R10,TOOFST,R6,R6
          LIS  R9,2
          LA   R8,ERMG05+9
          JAL  R4,BINHEX,,
          LA   R10,RNRCTR,R6,R6
          LIS  R9,2
          LA   R8,ERMG05+10
          JAL  R4,BINHEX,,
          HLPLIN(ERMG04)
          HLPLIN(ERMG05)
          HLPLIN(CRALF)
          SIS  R6,1
          JGE  CNT461                    :DO NEXT PU
          LA   R10,SIORCT
          LIS  R9,2
          LA   R8,ERMG06+26
          JAL  R4,BINHEX,,
          HLPLIN(ERMG06)
          LA   R10,RSNTIM
          LIS  R9,4
          LA   R8,ERMG07+25
          JAL  R4,BINHEX,,
          HLPLIN(ERMG07)
          LA   R10,ADERCT
          LIS  R9,2
          LA   R8,ERMG08+25
          JAL  R4,BINHEX,,
          LA   R10,FASTC,,
          LIS  R9,4
          LA   R8,ERMG09+25
          JAL  R4,BINHEX,,
          HLPLIN(ERMG08)
          HLPLIN(ERMG09)
          HLPLIN(PROMPT)
          J    REST,,

:--- come here to change T1 timer ---:
CNT462    LR   R0,R9
          JAL  R4,FLUSH,,
          LIS  R4,0F  
          STH  R4,INPTSW                  :TELL IMORG TO GO TO CNT463
          HLPLIN(LEFT3D)
          HLPLIN(LEFT3E)
          HLPLIN(LEFT3F)
          HLPLIN(LEFT40)
          J    REST,,
:--- come here with answer to T1 question ---:
CNT463    JAL  R4,GETCH,,                 :GET LENGTH
          LR   R9,R0
          JAL  R4,GETCH,,                 :GET ANSWER
          SIS  R9,1
          NHI  R0,7F
          JAL  R10,CHKECH
          CHI  R0,1B
          JE   RETCM0
          CHI  R0,31
          JL   BADIPT
          CHI  R0,33
          JG   BADIPT
          CHI  R0,31                      :SUSPEND
          JE   CNT465
          CHI  R0,32                      :CHANGE
          JE   CNT466
          LHI  R8,T1VAL                   :RESTORE ORIGINAL VALUE
          HLPLIN(LEFT41)
CNT464    STH  R8,T1TIME
          LIS  R5,0
          STH  R5,INPTSW
          LR   R0,R9
          JAL  R4,FLUSH,,
          HLPLIN(PROMPT)
          J    REST,,
CNT465    LHI  R8,7FFF                    :SUSPEND T1
          HLPLIN(LEFT42)
          J    CNT464
CNT466    LR   R0,R9
          JAL  R4,FLUSH,,
          HLPLIN(LEFT43)
          LIS  R4,0E                      :TELL IMORG TO GO TO CNT467
          STH  R4,INPTSW
          LIS  R4,0
          ST   R4,HLDHEX
          J    REST,,

:--- COME HERE WITH ANSWER TO NEW T1 VALUE QUESTION ---:
CNT467    JAL  R4,GETCH,,
          LR   R9,R0
CNT468    JAL  R4,GETCH,,
          SIS  R9,1
          JAL  R10,CHKECH
          LR   R10,R0
          NHI  R10,7F
          CHI  R10,0D                      :END OF INPUT?
          JE   CNT469
          LB   R0,AXAXAX,R10               :CONVERT TO HEX CHAR
          CHI  R0,0FF
          JE   BADIPT
          L    R6,HLDHEX
          SLLS R6,4
          AR   R6,R0
          ST   R6,HLDHEX
          CI   R6,7FFF
          JG   CNT46F
          LR   R9,R9
          JG   CNT468
          JAL  R4,ELIR,,
          J    REST,,
CNT469    L    R8,HLDHEX
          J    CNT464
CNT46F    HLPLIN(LEFT44)
          LHI  R8,T1VAL
          J    CNT464

:---- come here to send frame outside window -----:
C4OUTW    CHI  R9,0                  :ANYTHING LEFT IN RING?
          JN   C4OUT1                :YES
          JAL  R4,ELIR,,
          LIS  R4,0D                 :TELL IMORG TO GO TO C4OUT0 WITH ANSWER
          STH  R4,INPTSW             :TO BAD RR,N(S),N(R) QUESTION
          HLPLIN(LEFT46)             :BAD RR
          HLPLIN(LEFT47)             :BAD N(S)
          HLPLIN(LEFT48)             :BAD N(R)
          HLPLIN(LEFT49)             :BAD N(S) N(R)
          HLPLIN(LEFT4A)             :BAD FRAME
          HLPLIN(LEFT4B)             :SKIP 1 N(S) FRAME (RREEF)
          HLPLIN(LEFT1A)
          J    REST,,

:--- COME HERE WITH ANSWER TO BAD RR ETC. ----
C4OUT0    JAL  R4,GETCH,,            :GET LENGTH
          LR   R9,R0

C4OUT1    JAL  R4,GETCH,,            :IF TYPING AHEAD DON'T SEND PROMPT
          SIS  R9,1
          JAL  R10,CHKECH
          NHI  R0,7F
          CHI  R0,1B
          JE   RETCM0
          CHI  R0,31
          JL   BADIPT
          CHI  R0,36
          JG   BADIPT
          LR   R10,R0     
          LB   R6,AXAXAX,R10,
          SLLS R6,2
          L    R6,WNDARY,R6
          JE   C4DEAD
          LHL  R7,HOLDPU
          CHI  R7,99                  :ALL PUs?
          JE   C4OUT9
          SBT  R7,0,R6
          CHI  R0,36                  :RREEF (SKIP N(S))
          JEFS C4OUT3
          SBT  R7,OUTWSW              :SET "OUTSIDE WINDOW" SWITCH
C4OUT3    LR   R0,R9
          JAL  R4,FLUSH,,
          LIS  R4,0
          STH  R4,INPTSW
          STH  R4,HOLDPU
          HLPLIN(PROMPT)
          J    REST,,

c4out9    LHI  R7,NUMPU-1
C4OUTA    SBT  R7,0,R6
          SBT  R7,OUTWSW
          SIS  R7,1
          JGEBS C4OUTA
          J    C4OUT3

C4DEAD    HC   0
 
:bdbdbdbdbdbdbdbdbdbdbdbdbdbdbdbdbdbdbdbd
:bd  come here to display F.G. trace   bd
:bdbdbdbdbdbdbdbdbdbdbdbdbdbdbdbdbdbdbdbd
          if FGTRCE
C4FGDS    LIS  R4,0C                  :TELL IMORG TO GO TO C4FGD2 
          STH  R4,INPTSW
          LR   R0,R9
          JAL  R4,FLUSH,,
          LIS  R6,0
          STH  R6,FGTIX2,,            :INIT TRAILING INDEX
          CLH  R6,FGTIX,,
          JNFS C4FGD1                 :ALL CAUGHT UP
          HLPLIN(LEFT4E)
C4FGD1    HLPLIN(CRALF)
          SHOTRC
          AIS  R6,8
          NHI  R6,3FF
          STH  R6,FGTIX2,,
          J    REST4,,
          else
C4FGDS    HLPLIN(LEFT4D)
          J    CONT47
          ei

:--- come here to step through F.G. trace ---
          if FGTRCE
C4FGD2    JAL  R4,GETCH,,
          LR   R9,R0
C4FGD4    JAL  R4,GETCH,,
          NHI  R0,7F
          JAL  R10,CHKECH
          CHI  R0,1B                  :ESCAPE (LEAVE TRACE)
          JE   C4FGDX
          CHI  R0,0D                  :SHOW NEXT ENTRY?
          JN   C4FGD8
          LHL  R6,FGTIX2,,
          CLH  R6,FGTIX,,
          JNFS C4FGD6
          HLPLIN(LEFT4E)
C4FGD6    SHOTRC
          AIS  R6,8
          NHI  R6,3FF
          STH  R6,FGTIX2,,
C4FGD8    SIS  R9,1
          JG   C4FGD4
          JAL  R4,ELIR,,
          J    REST4,,
C4FGDX    SIS  R9,1
          HLPLIN(LEFT08)
          J    CONT47
          else
C4FGD2    HC   0
          ei
          





::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  come here via control-e to stop specified print job
CONT5     LIS R5,0
          STH R5,HOLDPU
          IF NUMPU-1
          HLPLIN(LEFT02)
          LIS R5,4                   :TELL IMORG TO GO TO CONT50
          STH R5,INPTSW
          J   REST,,

:--- COME HERE WITH ANSWER TO PU QUESTION ---:
CONT50    JAL R4,GETCH               :GET LENGTH
          STH R0,BITSIZ
          LR  R9,R0
          JAL R4,GETCH               :GET PU ANSWER
          SIS R9,1
          JAL R10,CHKECH             :ECHO JUNK
          NHI R0,7F
          CHI R0,1B                  :ABORT?
          JE  RETCM0
          LR  R7,R0
          OHI R7,20                  :ALLOW LOWER CASE
          CHI R7,78                  :X?
          JE  STPAPJ                 :SToP All Print Jobs
          LR  R7,R0
          LB  R0,AXAXAX,R7
          CHI R0,0FF
          JE  BADIPT
          STH R0,HOLDPU              :REMEMBER THE SELECTED PU
          LR  R0,R9
          JAL R4,FLUSH,,
          HLPLIN(LEFT07)
          ELSE
          HLPLIN(LEFT2B)             :ASK FOR LU NUMBER
          EI (NUMPU-1)
          LIS R5,6                   :TELL IMORG TO GO TO CONT51
          STH R5,INPTSW
          LIS R5,0
          STH R5,CHARIX
          STH R5,HOLDLU
          J   REST,,
:--- COME HERE WITH ANSWER TO LU QUESTION ---:
CONT51    JAL R4,GETCH,,
          LR  R9,R0
CONT52    JAL R4,GETCH,,
          SIS R9,1
          JAL R10,CHKECH
          NHI R0,7F
          CHI R0,1B
          JE  RETCM0
          CHI R0,58                   :ALL LUs?
          JE  STLAPJ
          CHI R0,78
          JE  STLAPJ
          CHI R0,0D
          JE  CONT5D
          LR  R10,R0
          LB  R0,AXAXAX,R10
          CHI R0,0FF
          JE  BADIPT
          LHL R8,HOLDLU
          SLLS R8,4
          AR  R8,R0                   :CREATE 2 DIGIT HEX NUMBER
          STH R8,HOLDLU
          LHL R6,CHARIX               :SEE IF 1 OR 2 DIGITS NOW
          JN  CONT5D                  :2 DIGITS, GO TO CONT5DONE
          AIS R6,1
          STH R6,CHARIX               :NEXT TIME WILL BE TWO DIGITS
          LR  R9,R9
          JG  CONT52
          JAL R4,ELIR,,
          J   REST,,
:--- COME HERE WHEN CR RECEIVED OR 2 DIGITS RECEIVED ---:
CONT5Done LR  R0,R9
          JAL R4,FLUSH,,
          LHL R2,HOLDPU
          JAL R11,CALCIX
          LHL R8,HOLDLU
          AR  R8,R6                   :R8 NOW HAS ABSOLUTE LU NUMBER
          LHI R4,PRTREC+1
          STH R4,PRNTCT,R8,R8
          LIS R4,0
          STH R4,INPTSW
          STH R4,HOLDPU
          STH R4,CHARIX
          STH R4,HOLDLU
          HLPLIN(PROMPT)
          J   REST,,
:--- COME HERE TO STOP ALL PRINT JOBS ---:
STPAPJ    LR  R0,R9
          JAL R4,FLUSH,,
          LIS R1,1
          LHI R4,PRTREC+1
STPAP2    STH R4,PRNTCT,R1,R1
          AIS R1,2
          CHI R1,NUMLU
          JL  STPAP2
          LIS R5,0
          STH R5,INPTSW
          HLPLIN(LEFT2C)
          HLPLIN(PROMPT)
          J   REST,,
:--- COME HERE TO STOP ALL PRINT JOBS ON A SPECFIED PU ---:
STLAPJ    LR  R0,R9
          JAL R4,FLUSH,,
          LHL R2,HOLDPU
          JAL R11,CALCIX
          LHI R4,PRTREC+1
STLAP2    STH R4,PRNTCT,R6,R6
          AIS R6,1
          SIS R8,1                    :NUMBER OF LUs ON THIS PU (FROM CALCIX)
          JGBS STLAP2
          LIS R4,0
          STH R4,INPTSW
          STH R4,HOLDPU
          HLPLIN(PROMPT)
          J   REST,,



:=========================================================================

CONT6     LIS R5,1
          TBT R5,DTRARY              :DON'T SEND SNRM IF DTR IS LOW
          JN  CONT60
          HLPLIN(LEFT02)
          LHI R5,14
          STH R5,INPTSW
          J   REST,,

:---  dtr is low so don't send SNRM  ---:
CONT60    HLPLIN(LEFT33)
          HLPLIN(PROMPT)
          J   REST,,

CONT62    JAL R4,GETCH,,
          STH R0,BITSIZ
          LR  R9,R0
          JAL R4,GETCH,,
          NHI R0,7F
          SIS R9,1
          JAL R10,CHKECH
          CHI R0,58
          JE  CONT67
          CHI R0,78
          JE  CONT67
          NHI R0,0F
          CHI R0,NUMPU-1
          JG  BADIPT
          LIS R4,0
          LR  R7,R0
          STB R4,PUSTAT,R7
CONT64    STH R4,INPTSW
          LR  R0,R9
          JAL R4,FLUSH,,
          HLPLIN(PROMPT)
          J   REST,,
CONT67    LIS R4,0
          LIS R5,0
CONT68    STB R4,PUSTAT,R5
          AIS R5,1
          CHI R5,NUMPU
          JL  CONT68
          J   CONT64



:--------------------------------------------------------------------------
:  THIS ROUTINE SENDS OUT THE SNOSTS HELP LIST WHEN CONTROL-H IS 
:  ENTERED AT THE COMMAND MODE PROMPT ([>)

CONT8    JAL R8,HLPLST
         J   REST,,

:===========================================================================
: THIS ROUTINE SETS FLAGS TO IGNORE UA FOR SPECIFIED PU

CONT9    HLPLIN(LEFT02)
         LHI R5,13
         STH R5,INPTSW
         J   REST,,

CONT92   JAL R4,GETCH,,
         STH R0,BITSIZ
         LR  R9,R0
         JAL R4,GETCH,,
         SIS R9,1
         NHI R0,7F
         CHI R0,1B
         JE  RETCM0
         CHI R0,78
         JE  CONT97
         CHI R0,58
         JE  CONT97
         NHI R0,0F
         CBT R0,UAIGNR                :SET FLAG TO IGNORE UA
         JEFS .+8
         LA  R3,LEFT05
         JFS .+6
         LA  R3,LEFT04
         LH  R2,RPORT
         JAL R5,OCS,,
CONT94   LR  R0,R9
         JAL R4,FLUSH,,
         LIS R4,0
         STH R4,INPTSW
         HLPLIN(PROMPT)
         J   REST,,
CONT97   LIS R5,0
         SBT R5,UAIGNR
         AIS R5,1
         CHI R5,NUMPU
         JL  CONT97+2
         J   CONT94



:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: CONTROL-K  DE-ACTIVATE LU                                           :::

CONTB    IF NUMPU-1
         HLPLIN(LEFT06)
         LHI  R5,18
         STH  R5,INPTSW
         ELSE
         HLPLIN(LEFT07)
         LHI  R5,19
         STH  R5,INPTSW
         EI
         J    REST,,

:-:-:-:- AT THIS POINT, ASKING FOR PU

CONTB2   JAL  R4,GETCH,,              :GET LENGTH
         STH  R0,BITSIZ
         LR   R9,R0
         JAL  R4,GETCH,,              :SHOULD BE PU NUMBER
         JAL  R10,CHKECH
         SIS  R9,1
         NHI  R0,7F
         CHI  R0,1B
         JE   RETCM0
         OHI  R0,20
         LR   R10,R0
         LR   R0,R9
         JAL  R4,FLUSH,,
         CHI  R10,78                  :DEACTIVATE ALL?
         JE   CONTB9
         NHI  R10,0F
         CHI  R10,NUMPU-1
         JG   BADIPT+6                :NUMBER OUT OF RANGE
         STH  R10,HOLDPU              :SAVE PU NUMBER
         HLPLIN(LEFT07)
         LHI  R5,19
         STH  R5,INPTSW
         J    REST,,

:-:-:-:  ASKING FOR LU NUMBER

CONTB4   JAL  R4,GETCH,,              :LENGTH
         LR   R9,R0
         IF NUMPU-1
         ELSE
         LIS  R4,0 
         STH  R4,HOLDPU
         EI
         JAL  R4,GETCH,,
         SIS  R9,1
         JAL  R10,CHKECH
         NHI  R0,7F
         CHI  R0,1B
         JE   RETCM0
         CHI  R0,58                   :KILL EM ALL?
         JE   CONTB7
         CHI  R0,78                   :KILL EM ALL?
         JE   CONTB7
         LIS  R4,0
         STH  R4,HOLDLU
         LR   R10,R0
         LB   R0,AXAXAX,R10                          
         CHI  R0,0FF
         JE   BADIPT
         STH  R0,HOLDLU
         LR   R0,R9
         JAL  R4,FLUSH,,
         LHI  R5,16
         STH  R5,INPTSW
         J    REST,,
:--- come here with second digit of LU
CONTB5   JAL  R4,GETCH,,
         LR   R9,R0
         JAL  R4,GETCH,,
         SIS  R9,1
         JAL  R10,CHKECH
         NHI  R0,7F
         CHI  R0,1B
         JE   RETCM0
         CHI  R0,0D                   :END OF INPUT?
         JE   CNTB10
         LR   R10,R0
         LB   R0,AXAXAX,R10
         CHI  R0,0FF
         JE   BADIPT
         LHL  R4,HOLDLU
         SLLS R4,4
         AR   R0,R4                  :FINAL HEX VALUE FOR LU
         STH  R0,HOLDLU
CNTB10   LR   R0,R9
         JAL  R4,FLUSH,,
         LIS  R0,0
         STH  R0,INPTSW
         LHL  R2,HOLDPU
         JAL  R11,CALCIX
         LHL  R2,HOLDLU
         AR   R2,R6                  :ABSOLUTE LU NUMBER
         LHI  R7,43
         STB  R7,LUSTAT,R2,
         JAL  R4,BLDDAL
         LHI  R7,46
         STB  R7,LUSTAT,R2,
         HLPLIN(PROMPT)
         J    REST,,


:--- COME HERE TO DE-ACTIVATE ALL LUs FOR THIS PU ---:
CONTB7   LR   R0,R9
         JAL  R4,FLUSH,,
         LIS  R4,0
         STH  R4,INPTSW
         HLPLIN(PROMPT)
         LHL  R2,HOLDPU
         JAL  R11,CALCIX
         LR   R1,R2
         LR   R2,R6
         LB   R11,LUPRPU,R1,
CONTB8   LHI  R7,43
         STB  R7,LUSTAT,R2,
         STM  R0,SAVALL
         JAL  R4,BLDDAL
         LM   R0,SAVALL
         AIS  R2,1
         SIS  R11,1
         JG   CONTB8
         J    REST,,
:--- COME HERE TO DEACTIVATE ALL LUs
CONTB9   HLPLIN(WORKNG)
         LHI  R2,NUMLU-1
CNTB90   LHI  R7,43
         STB  R7,LUSTAT,R2,
         STM  R0,SAVALL
         JAL  R4,BLDDAL
         LM   R0,SAVALL
         SIS  R2,1
         JGE  CNTB90
         LIS  R4,0
         STH  R4,INPTSW
         HLPLIN(PROMPT)
         J    REST,,

:---------------------------------------------------------------------------

CONTC     LHI R4,11
          STH R4,INPTSW               :HAVE IMORG SEND YOU TO CONTL2
          HLPLIN(LUPRM0)
          HLPLIN(LUPRM1)
          J   REST,,

CONTL2    JAL R4,GETCH,,              :GET LENGTH
          LIS R9,0
          STH R0,BITSIZ
          JAL R4,GETCH,,              :GET FIRST CHARACTER
          LR  R7,R0
          NHI R7,7F
          JAL R10,CHKECH
          OHI R7,20                   :ACCOUNT FOR lower CASE
          CHI R7,78                   :X?
          JN  CONTL4
          LH  R0,BITSIZ               :GET ISIS LENGTH
          SIS R0,1
          JAL R4,FLUSH,,
          LHI R9,NUMLU-1
          LHI R10,80
          LIS R5,1
C0NTL3    STB R10,LUSTAT,R9,
          AM  R5,TMSTUF               :PUT ON TIMER LIST
          SIS R9,1
          JGEBS C0NTL3
          LIS R9,0
          STH R9,INPTSW
          HLPLIN(PROMPT)
          J   REST,,
CONTL4    LH  R6,CHARIX
          LIS R9,0
          LH  R7,DOECHO
          J   INPTP5

CONTL6    JAL R4,GETCH,,
          STH R0,BITSIZ
          LH  R6,CHARIX
          LR  R9,R0
CONTL7    JAL R4,GETCH,,
          SIS R9,1
          LR  R2,R0
          NHI R2,7F
          CHI R2,1B                   :ESCAPE?
          JE  RETCM0                  :ABORT COMMAND
          CHI R2,08                   :BACKSPACE?
          JN  CONTL8
          HLPLIN(BKSPC)
          CHI R6,0
          JEFS .+8
          SIS R6,1
          STH R6,CHARIX
          CHI R9,0
          JG  CONTL7
          JAL R4,ELIR,,
          J   REST,,
CONTL8    JAL R10,CHKECH
          CHI R2,58                   :X?
          JE  XACTLX                  :GO ACTIVATE ALL LU'S
          CHI R2,78                   :x?
          JE  XACTLX
          CHI R2,2C                   :COMMA?
          JE  CONTL9
          CHI R2,0D                   :END OF INPUT
          JE  CONTLB
          CHI R6,2                    :HAVE CHAR PAIR?
          JGE CXXXL5
          OHI R2,80
          STB R2,HLDHEX,R6            :STORE CHAR PAIR
          AIS R6,1
          STH R6,CHARIX
          CHI R9,0
          JG  CONTL7
          JAL R4,ELIR,,
          J   REST
CONTL9    CHI R6,2
          JN  CXXXL5
          LIS R6,0
          LIS R2,0
CXXXL1    LB  R4,PUACT,R2             :FIND A PUACT OF STATE 5
          CHI R4,85
          JE  CXXXL2
          AIS R2,1
          CHI R2,NUMPU
          JL  CXXXL1
          HC  0
CXXXL2    JAL R11,CALCIX
          SLLS R6,1
          LH  R1,HLDHEX
CONTLA    CH  R1,LUTABA,R6
          JE  CXXXL3
          AIS R6,2
          SIS R8,1
          JG  CONTLA
          J   CXXXL5
CXXXL3    SRLS R6,1
          LHI R4,80                   :SET STATE TO "BKGRND MAY NOW ACTIVATE"
          LIS R5,1
          AM  R5,TMSTUF               :PUT ON TIMER LIST
          STB R4,LUSTAT,R6,
          LH  R5,ENDSW
          JN  CXXXL4
          CHI R9,0
          JG  CONTL7
          JAL R4,ELIR,,
          J   REST,,
CXXXL4    LIS R5,5
          STB R5,PUACT,R2
          HLPLIN(PROMPT)
          LIS R5,0
          STH R5,ENDSW
          STH R5,INPTSW
          STH R5,CHARIX
          CHI R9,0
          JG  CONTL7
          JAL R4,ELIR,,
          J   REST,,

CXXXL5    HLPLIN(BADLUM)
          LIS R6,0
          STH R6,INPTSW
          STH R6,CHARIX
          CHI R9,0
          JG  CONTL7
          JAL R4,ELIR,,
          J   REST,,

CONTLB    LH  R5,1
          STH R5,ENDSW
          J   CONTL9

XACTLX    LIS R2,0
          LB  R10,PUACT,R2
          CHI R10,85                  :LOOK FOR PU WANTING LU ACTIVATION
          JE  XACTL2
          AIS R2,1
          CHI R2,NUMPU
          JL  XACTLX+2
          HLPLIN(LEFT01)
          LIS R5,0
          STH R5,CHARIX
          STH R5,INPTSW
          STH R5,ENDSW
          CHI R9,0
          JG  CONTL7
          JAL R4,ELIR,,
          J   REST,,
XACTL2    JAL R11,CALCIX
          LHI R10,80
          LIS R11,1
XACTL3    STB R10,LUSTAT,R6,
          AM  R11,TMSTUF              :PUT ON TIMER LIST
          AIS R6,1
          SIS R8,1
          JG  XACTL3
          LIS R5,5
          STB R5,PUACT,R2             :SET STATE TO PROCESS THEM LU-BOYS
          LIS R5,0
          STH R5,INPTSW
          STH R5,CHARIX
          CHI R9,0
          JG  CONTL7
          JAL R4,ELIR,,
          HLPLIN(PROMPT)
          J   REST,,

:--------------------------------------------------------------------------

CONTD     HLPLIN(PROMPT)
          J   REST,,



::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE HANDLES THE REQUEST FOR MANUAL ENTRY OF RU'S TO SEND :::

CONTF    HLPLIN(LEFT0C)
         LHI  R5,24                   :TELL IMORG TO GO TO CONTF2
         STH  R5,INPTSW
         J    REST,,

:- - - - - - - - - - - - - - - - -
: COME HERE WHEN USER INPUTS RELATIVE LU #

CONTF2   JAL  R4,GETCH,,
         LR   R9,R0
         JAL  R4,GETCH,,
         JAL  R10,CHKECH
         LR   R8,R0
         SIS  R9,1
         LR   R0,R9
         JAL  R4,FLUSH,,
         NHI  R8,7F
         CHI  R8,1B                   :ESCAPE?
         JE   RETCOM                  :YES, GO INTERUPT THE USER
         LB   R8,AXAXAX,R8
         CHI  R8,0FF
         JE   CONTF9
CONTF5   SBT  R8,MANUAL               :MARK THIS LU AS MANUAL OVERRIDE
         STH  R8,MANLU                :SAVE RELATIVE LU #
         LHI  R4,25                   :TELL IMORG TO GO TO CONTFA
         STH  R4,INPTSW
         HLPLIN(PROMPT)
         J    REST,,
CONTF9   HLPLIN(BADHEX)
         LIS  R5,0
         STH  R5,INPTSW
         HLPLIN(PROMPT)
         J    REST,,
:---------------------------------
: COME HERE TO ASK FOR RU

CONTFA   JAL  R4,GETCH,,
         LR   R9,R0
         JAL  R4,GETCH,,
         SIS  R9,1
         JAL  R10,CHKECH
         LR   R8,R0
         LR   R0,R9
         JAL  R4,FLUSH,,
         NHI  R8,7F
         CHI  R8,3F                   :?
         JE   CONTFH                  :ASKING FOR HELP LIST
         CHI  R8,1B                   :ESCAPE?
         JE   RETCOM
         CHI  R8,0F                   :CONTROL-O?
         JE   CONTFB
         CHI  R8,0D                   :CR?
         JN   REST
         HLPLIN(PROMPT)
         J    REST,,
CONTFB   LIS  R2,0
         STH  R2,RUCNT
         HLPLIN(LEFT0D)
         LHI  R5,26
         STH  R5,INPTSW
         J    REST,,

:--------------------------------
: COME HERE TO INPUT FIRST NIBBLE OF RU

CONTFC   JAL  R4,GETCH,,
         LR   R9,R0
         JAL  R4,GETCH,,
         SIS  R9,1
         JAL  R10,CHKECH
         LR   R10,R0
         NHI  R10,7F
         CHI  R10,3F                  :?
         JE   CONTFG                  :ASKING FOR HELP LIST
         CHI  R10,1B                  :ESCAPE?
         JE   RETCM0
         JAL  R10,CONATH              :GO CONVERT R0 FROM ASCII BYTE TO HEX NBL
         J    CONTFX                  :NORMAL RETURN=ERROR
         LH   R7,RUCNT                :SEE IF FIRST NIBBLE OF RU
         JN   CONTFD
         SLLS R0,4                    :SHIFT TO LEFT 4 BITS
         STB  R0,MANLRU
         LIS  R7,1
         STH  R7,RUCNT                :UPDATE NIBBLE COUNT
         CHI  R9,0
         JG   CONTFC+8                :GO GET NEXT CHAR
         JAL  R4,ELIR,,
         J    REST
CONTFD   LB   R7,MANLRU               :GET FIRST 4 BITS
         AR   R0,R7                   :COMBINE TO ONE BYTE
         STB  R0,MANLRU
         LIS  R7,0
         STH  R7,RUCNT                :ZERO OUT RU NIBBLE COUNTER
         LR   R0,R9
         JAL  R4,FLUSH,,
         LB   R0,MANLRU               :GET THE RU TO SEND
         JAL  R10,SCANRU              :SEE IF SUPPORTED
         J    CONTFZ                  :NORMAL RETURN=NOT SUPPORTED
         IF PKTSIZ-$A512
         CI   R15,BIGRU
         JNFS BIGBOY
         SLLS R14,1                   :MUST DOUBLE SIZE
BIGBOY   CI   R15,SSCPDT
         JNFS BOYBIG
         SLLS R14,1
BOYBIG   EQ   .
         EI
         LHI  R13,14
         CI   R15,NTFBUF              :SEE IF NOTIFY RESPONSE
         JNFS .+4                     :IF YES, DAF MUST BE 0
         LIS  R13,0
         CI   R15,VTAMBN              :IF VTAM BANNER , OAF MUST BE 0
         JNFS .+4
         LIS  R13,0
         CI   R15,FMDRSP              :SEE IF +RSP TO VTAM LOGON
         JNFS .+4
         LIS  R13,0                   :OAF MUST BE 0
         CI   R15,FMDNRP              :-RSP TO SSCP STUFF?
         JNFS .+4
         LIS  R13,0
         CI   R15,SSCPDT              :SSCP DATA?
         JNFS .+4
         LIS  R13,0                   :OAF IS 0 IF SSCP
         IF 1%RSHUTD
         CI   R15,TRMSRP
         JNFS .+4
         LIS  R13,0
         EI
         CI   R15,DALBUF              :DACTLU DAF MUST BE ZERO
         JNFS .+4
         LIS  R13,0
         CI   R15,MNACLU              :ACTLU DAF MUST BE 0
         JNFS .+4
         LIS  R13,0
         STH  R13,APPLIC
         LH   R2,MANLU                :GET REL LU #
         LB   R13,0A,R15              :GET FIRST BYTE OF RH
         NHI  R13,80                  :SEE IF RSP
         JE   CONTFE
         LH   R13,LUSNF,R2,R2         :GET SNF
         STH  R13,HLDSNF              :SAVE
         LH   R13,SNFLU,R2,R2         :GET SNF FROM HIF
         STH  R13,LUSNF,R2,R2         :USE IN RSP
CONTFE   JAL  R13,FNDLPU              :FIND MATCHING PU
         JAL  R7,BLDFRM
         LB   R13,0A,R15
         NHI  R13,80                  :SEE IF RSP
         JE   CONTFF
         LH   R13,HLDSNF
         STH  R13,LUSNF,R2,R2         :RESTORE
CONTFF   LHI  R7,4E                   :THIS STATE=MANUAL
         STB  R7,LUSTAT,R2,
         LIS  R7,0
         STH  R7,INPTSW
         HLPLIN(PROMPT)
         J    REST
CONTFX   HLPLIN(BKSPC)
         CHI  R9,0
         JG   CONTFC+6
         JAL  R4,ELIR,, 
         J    REST,,

:--- COME HERE TO PRINT HELP LIST FOR CONTROL-O (USER TYPED "?") ---:
CONTFG   LR   R0,R9
         JAL  R4,FLUSH,,
CONTFH   HLPLIN(MANHL1)
         HLPLIN(MANH1A)
         HLPLIN(MANHL2)
         HLPLIN(MANHL3)
         HLPLIN(MANHL4)
         HLPLIN(MANHL5)
         HLPLIN(MANHL6)
         HLPLIN(MANHL7)
         HLPLIN(MANHL8)
         HLPLIN(MANHL9)
         IF VTAMRF
         HLPLIN(MANHLX)
         HLPLIN(MANHLY)
         EI (VTAMFR)
         HLPLIN(MANHLA)
         J   CONTFB                   :ASK FOR THE RU NOW

CONTFZ   HLPLIN(NOTSUP)
         LIS  R5,0
         STH  R5,INPTSW
         STH  R5,RUCNT
         STB  R5,MANLRU
         HLPLIN(PROMPT)
         J    REST,,



:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE CONVERTS ASCII BYTES TO HEX NIBBLES

CONATH   NHI  R0,7F
         LR   R5,R0
         LB   R0,AXAXAX,R5
         CHI  R0,0FF                   :BAD VALUE?
         JER  R10
         J    4,R10

:----------------------------------
: THIS UTILITY ROUTINE FINDS THE LENGTH OF THE FRAME & ADDRESS OF BUFFER

SCANRU   LIS  R7,0
         LB   R9,RUTABL,R7 
         CR   R0,R9                   :IS THIS RU SUPPORTED?
         JE   SCANR4                  :YES
         AIS  R7,4
         CHI  R7,RUTLEN               :SEE IF END OF TABLE
         JL   SCANRU+2
         JR   R10                     :NORMAL RETURN=NOT SUPPORTED
SCANR4   LB   R14,RUTABL+1,R7         :GET LENGTH
         LHL  R15,RUTABL+2,R7         :ADDRESS OF BUFFER
         J    4,R10

:==========================================================================
: THIS ROUTINE HANDELS CONTROL-P (ACTIVATE PU)

CONT10   HLPLIN(PUPRM0)
         HLPLIN(PUPRMP)
         LHI R5,10                    :SET INPTSW=LOOKING FOR ACTPU ADDRESSES
         STH R5,INPTSW
         J   REST,,


:==========================================================================
: THIS ROUTINE ACCEPTS ASCII CHARACTER PAIRS SEPARATED BY COMMAS.  THESE
: CHARACTERS ARE IN RESPONSE TO "ACTIVATE PU" PROMPT

INPTPU   JAL R4,GETCH,,               :GET THE LENGTH
         STH R0,BITSIZ
         LH  R7,DOECHO                :GET ECHO SETTING (1=THIS SLOT ECHOS)
         LH  R6,CHARIX                :ASCII PAIR INDEX
         LIS R9,0                     :ISIS DATA LENGTH COUNTER
INPTP1   JAL R4,GETCH,,
         LR  R2,R0
         NHI R2,7F
         CHI R2,08                    :IS THIS A CONTROL-H?
         JN  INPTP4
         HLPLIN(BKSPC)
         CHI R6,0
         JE  INPTP2                   :IF NOTHING HAD BEEN ENTERED, DON'T BS
         SIS R6,1
         STH R6,CHARIX
INPTP2   AIS R9,1
         CH  R9,BITSIZ                :SEE IF ANYTHING LEFT IN IRING
         JN  INPTP1
         JAL R4,ELIR,,
         J   REST,,
INPTP4   CHI R7,1                     :CHECK ECHO SETTING
         JN  INPTP5
         JAL R10,CHKECH               :GO ECHO IF NECESSARY
INPTP5   LR  R2,R0
         NHI R2,7F
         CHI R2,58                    :IF X THEN ACTIVATE ALL PU'S
         JE  INPTPF
         CHI R2,78                    :IF x THEN ACTIVATE ALL PUs
         JE  INPTPF
         CHI R2,1B                    :ESCAPE?
         JE  ABRTCM
         CHI R2,2C                    :SHOULD BE COMMA
         JE  INPTP8
         CHI R2,0D
         JE  INPTP7
         CHI R6,2
         JGE INPTP6
         OHI R0,80
         STB R0,HLDHEX,R6             :BUILD ADDRESS
         AIS R6,1
         STH R6,CHARIX
         AIS R9,1
         CH  R9,BITSIZ                :SEE IF ANYTHING LEFT IN IRING
         JL  INPTP1
         JAL R4,ELIR,,
         J   REST,,
INPTP6   HLPLIN(BADPU)
INPTPX   AIS R9,1
         CH  R9,BITSIZ
         JL  INPTP1
         JAL R4,ELIR,,
         J   REST,,
INPTP7   CHI R6,2
         JE  INPTPY
         HLPLIN(BADPU2)
         J   INPTPX
INPTPY   LIS R5,1
         STH R5,ENDSW                 :SET "END OFF ADDRESSES" SWITCH
INPTP8   CHI R6,2
         JN  INPTP7
         LH  R8,HLDHEX
         LIS R6,0
         STH R6,CHARIX                :RESET PAIR INDEX
INPTP9   CH  R8,PUTABA,R6             :FIND ADDRESS MATCH
         JE  INPTPB
         AIS R6,2
         CHI R6,NUMPU*2
         JL  INPTP9
         HLPLIN(BADPU3)
         HLPLIN(BADPU4)
         J   INPTPX
INPTPB   SRLS R6,1
         LIS R2,1
         CHI R13,11                   :ACTING LU'S OR PU'S?
         JNFS .+6                      :NOT= IS PU'S
         LHI R2,85
         STB R2,PUACT,R6
         LH  R5,ENDSW
         JE  INPTPX
         CHI R13,11                   :SAVING THESE GUYS FOR ACTLU?
         JE  INPTPD                   :YES
         HLPLIN(PROMPT)
         LIS R5,0
         STH R5,INPTSW
         STH R5,ENDSW
         STH R5,CHARIX
         J   INPTPX
INPTPD   HLPLIN(LUPRM2)
         HLPLIN(LUPRM3)
         LHI R5,12                    :TELL IMORG WHERE TO GO
         STH R5,INPTSW
         LH  R0,BITSIZ
         AIS R9,1
         SR  R0,R9
         JAL R4,FLUSH,,
         J   REST,,
INPTPF   AIS R9,1
         CH  R9,BITSIZ
         JE  INPTPG
         LH  R0,BITSIZ
         SR  R0,R9
         JAL R4,FLUSH,,
         JFS .+6
INPTPG   JAL R4,ELIR,,
INPTPH   LIS R9,0
         LIS R10,1
INPTPJ   STB R10,PUACT,R9
         AIS R9,1
         CHI R9,NUMPU
         JL  INPTPJ
         LIS R5,0
         STH R5,INPTSW
         STH R5,ENDSW
         STH R5,CHARIX
         HLPLIN(PROMPT)
         J   REST,,



:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: COME HERE VIA CONTROL-R TO RESET THE FMD COUNTERS

CONT12   HLPLIN(LEFT1D)
         HLPLIN(PROMPT)
         LHI  R5,NUMLU-1
         LIS  R4,0
CONTR2   STH  R4,FMDCTR,R5,R5
         STH  R4,FRMCTR,R5,R5
         STH  R4,UNKNCT,R5,R5
         STH  R4,REXMCT,R5,R5
         STH  R4,TOOFST,R5,R5
         STH  R4,REJCTR,R5,R5
         STH  R4,RNRCTR,R5,R5
         SIS  R5,1
         JGE  CONTR2
         STH  R4,ADERCT
         STH  R4,SIORCT
         STH  R4,RSPERR
         ST   R4,TMSTUF
         ST   R4,PUSTUF
         ST   R4,LUSTUF
         J    REST,,

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  COME HERE WHEN A CONTROL-T IS ENTERED, TO PUT DATA IN THE FMD RU
:::  FOR USE WITH THE MANUAL OPTION

CONT14   HLPLIN(LEFT38)
         HLPLIN(LEFT39)
         HLPLIN(LEFT1A)
         LHI  R5,1A                   :GO RESOLVE SSCP OR LU ISSUE
         STH  R5,INPTSW
         J    REST,,

CONTT1   JAL  R4,GETCH,,
         LR   R9,R0                   :SAVE LENGTH
         JAL  R4,GETCH,,              :GET ANSWER
         SIS  R9,1
         JAL  R10,CHKECH
         LR   R10,R0
         LR   R0,R9
         JAL  R4,FLUSH,,
         LR   R0,R10
         NHI  R0,7F
         CHI  R0,1B
         JE   RETCOM
         CHI  R0,31
         JEFS CONTT0
         CHI  R0,32
         JE   CONTT5
         J    BADIP2
CONTT0   HLPLIN(LEFT18)
         LHI  R5,1B                   :NOW GO TO INPUT OF TEXT MODE
         STH  R5,INPTSW
         LHI  R5,0D                   :DATA STARTS AT MANDAT+0D
         STH  R5,MANIX
         LIS  R5,0
         STH  R5,RUCNT                :INIT NIBBLE HOLDER
         STH  R5,MODESW
         STH  R5,NIBHLD
         J    REST,,

CONTT2   LA   R12,MANDAT              :ADDRESS OF BUFFER TO STORE DATA TO
         LIS  R5,0D                   :0D=LU-LU SESSION
         STB  R5,DEFSES
         LHI  R5,$A220                :MAX RU SIZE
         STH  R5,MANMAX

:---- COME HERE TO STORE TEXT TO MANDAT

CONTT3   JAL  R4,GETCH,,              :GET LENGTH
         LR   R9,R0                   :SAVE IT
         LH   R6,MANIX                :GET INDEX TO MANDAT
CONTT4   JAL  R4,GETCH,,
         SIS  R9,1
         LR   R4,R0
         NHI  R4,7F
         CHI  R4,1B                   :ABORT?
         JE   RETCM0
         CHI  R4,18                   :CONTROL-X?
         JE   CHNGMD                  :SWITCH MODES
         CHI  R4,08                   :BACKSPACE?
         JE   MOVEBK
         CHI  R4,0D
         JE   MANEND
         JAL  R10,CHKECH
         LH   R4,MODESW               :HEX OR ASCII
         JN   CONTTA                  :HEX
         LR   R4,R0
         NHI  R4,7F
         LB   R0,EBCONT,R4            :CONVERT TO EBCDIC
         STB  R0,0,R12,R6             :R12 HAS ADDRESS OF BUFFER
         AIS  R6,1
CONTT6   LR   R9,R9                   :RING EMPTY?
         JG   CONTT4
         JAL  R4,ELIR,,
         STH  R6,MANIX
         CH   R6,MANMAX               :MAX SIZE REACHED?
         JL   REST,,
         LIS  R5,0
         STH  R5,INPTSW
         STH  R5,RUCNT
         HLPLIN(PROMPT)
         J    REST,,

CONTTA   JAL  R10,CONATH              :CONVERT ASCII TO HEX NIBBLE
         J    CONTTX                  :ERROR
         LH   R5,RUCNT
         JE   CONTTB
         AHM  R0,NIBHLD               :SECOND HALF OF BYTE
         LIS  R5,0
         STH  R5,RUCNT
         LH   R0,NIBHLD
         STB  R0,0,R12,R6             :R12 HAS ADDRESS OF BUFFER
         AIS  R6,1
         J    CONTT6
CONTTB   SLLS R0,4
         STH  R0,NIBHLD
         LIS  R5,1
         STH  R5,RUCNT                :NOW LOOKING FOR SECOND HALF OF BYTE
         J    CONTT6
CONTTX   HLPLIN(BKSPC)
         J    CONTT6

:--- come here to input to SSCPDT ---:
CONTT5   HLPLIN(LEFT18)
         LHI  R5,17
         STH  R5,INPTSW
         LIS  R5,0D                   :START INPUT AT SSCPDT+0D
         STH  R5,MANIX
         LIS  R5,0
         STH  R5,RUCNT
         STH  R5,MODESW
         STH  R5,NIBHLD
         J    REST,,

CONTT7   LA   R12,SSCPDT
         LHI  R5,45                   :45=SSCP-LU SESSION
         STB  R5,DEFSES
         LHI  R5,$A200
         STH  R5,MANMAX
         J    CONTT3

:---- TOGGLE ASCII/HEX MODE
CHNGMD   LIS   R4,0
         LH    R5,MODESW              :0=ASCII 1=HEX
         JE    CHNGM4
         STH   R4,MODESW
         J     CONTT6
CHNGM4   AIS   R5,1
         STH   R5,MODESW
         J     CONTT6

:----  RECEIVED BACKSPACE
MOVEBK   LH   R4,MODESW               :GET MODE
         JE   MOVEB4
         HLPLIN(BELL)                 :IN HEX MODE JUST BEEP
         J    CONTT6
MOVEB4   HLPLIN(BKSPC)
         SIS  R6,1                    :DECREMENT MANIX
         J    CONTT6

:--- GOT CR, END OF TEST INPUT
MANEND   HLPLIN(PROMPT)
         LB   R4,DEFSES
         STB  R6,RUTABL,R4            :SAVE LENGTH OF MANUAL RU
         LIS  R5,0
         STH  R5,INPTSW
         STH  R5,RUCNT
         LIS  R6,0
         J    CONTT6

:=========================================================================
: COME HERE VIA CONTROL-X (IF SPCSEQ => 1) TO SEND THE SPECIAL FRAME SEQ

         IF SPCSEQ
CONT18   HLPLIN(LEFT17)
         HLPLIN(PROMPT)
         LIS   R5,05                  :TELL B.G. TO PUT FRAMES INTO SIO BUF
         STB   R5,PUSTAT              :ALWAYS USES THE FIRST PU
         J     REST,,
         EI (SPCSEQ)

:=========================================================================
:= COME HERE (VIA CONTROL-Y) TO CHANGE THE RH FOR THE MANUAL DATA BIU

CONT19   HLPLIN(LEFT13)
         HLPLIN(LEFT14)
         HLPLIN(LEFT10)
         HLPLIN(LEFT16)
         HLPLIN(LEFT26)               :CHANGE RH OF SSCPDT
         HLPLIN(LEFT27)               :CHANGE FIRST SEG BIT OF SSCPDT
         HLPLIN(LEFT28)               :CHANGE LAST SEG BIT OF SSCPDT
         HLPLIN(LEFT34)               :CHANGE UNBIND REASON CODE
         HLPLIN(LEFT37)               :DISPLAY DATA FOR LU 0
         IF VTAMRF                    :IF GENNED FOR CMH
         HLPLIN(LEFT19)
         EI
         HLPLIN(LEFT1A)               :--> PROMPT
         LHI  R5,1F                   :TELL IMORG TO GO TO CONTY5 NEXT
         STH  R5,INPTSW
         J    REST,,

CONTYO   HLPLIN(LEFT11)               :ASK FOR THE RH
         LHI  R5,1C
         STH  R5,INPTSW               :TELL IMORG TO GO TO CONTY0 NEXT
         LIS  R5,1
         STH  R5,MODESW               :USE HEX MODE TO INPUT RH
         LIS  R5,0
         STH  R5,RUCNT
         LIS  R5,0A                   :STARTING POINT IN BUFFER MANDAT
         STH  R5,MANIX
         J    REST,,

:--- COME HERE IN RESPONSE TO LENGTH OR RH QUESTION
CONTY5   JAL  R4,GETCH,,
         LR   R7,R0
         JAL  R4,GETCH,,
         LR   R6,R0
         SIS  R7,1
         LR   R0,R7
         JAL  R4,FLUSH,,
         NHI  R6,7F
         CHI  R6,32                   :32=CHANGE RH
         JE   CONTYO
         CHI  R6,31
         JE   CONTY1                  :31=CHANGE RU LENGTH
         CHI  R6,33                   :33=SET THE EXPEDITE BIT IN THE TH
         JE   CONTYJ
         CHI  R6,34                   :34=RESET THE EXPEDITE BIT IN THE TH
         JE   CONTYK
         CHI  R6,35                   :35=CHANGE RH OF SSCPDT
         JE   CONTYP
         CHI  R6,36                   :36=CHANGE FIRST SEG BIT OF SSCPDT
         JE   CONTYR
         CHI  R6,37                   :37=CHANGE LAST SEG BIT IN SSCPDT
         JE   CONTYS
         CHI  R6,38                   :38=CHANGE UNBIND REASON CODE
         JE   CONTYY
         CHI  R6,39                   :39=DISPLAY DATA FOR LU 0
         JE   DSPLU0
         IF VTAMRF
         CHI  R6,41
         JE   CONTYM                  :GO SET VTAUTO BIT ARRAY
         EI (VTAMRF)
         CHI  R6,1B
         JE   RETEXC,,                :GOT ESCAPE, RETURN TO EXEC
         HLPLIN(BKSPC)
         J    REST,,

:---COME HERE TO ASK ABOUT SSCP OR LU RU LENGTH---:
CONTY1   HLPLIN(LEFT3A)
         HLPLIN(LEFT3B)
         HLPLIN(LEFT1A)
         LHI  R5,23                   :TELL IMORG TO GO TO CONTY2
         STH  R5,INPTSW
         J    REST,,
   
CONTY2   JAL  R4,GETCH,,
         LR   R9,R0
         JAL  R4,GETCH,,
         SIS  R9,1
         JAL  R10,CHKECH
         LR   R10,R0
         LR   R0,R9
         JAL  R4,FLUSH,,
         LR   R0,R10
         NHI  R0,7F
         LIS  R9,0D                   :DEFAULT TO LU-LU
         STB  R9,DEFSES
         CHI  R0,1B                   :ABORT?
         JE   RETCOM
         CHI  R0,31                   :CHANGE LU-LU RU LENGTH
         JE   CONTY6
         CHI  R0,32
         JN   BADIP2
         LHI  R9,45                   :SSCP-LU SESSION
         STB  R9,DEFSES
CONTY6   HLPLIN(LEFT15)               :ASK FOR LENGTH
         LIS  R5,1
         STH  R5,MODESW
         LIS  R5,0
         STH  R5,RUCNT
         STH  R5,NIBHLD
         LHI  R5,22
         STH  R5,INPTSW               :TELL IMORG TO GO TO CONTY8 NEXT
         J    REST,,

CONTY8   JAL  R4,GETCH,,
         LR   R9,R0
CONTY9   JAL  R4,GETCH,,
         NHI  R0,7F
         CHI  R0,0D                   :END OF INPUT?
         JE   CONTYB
         JAL  R10,CONATH              :CONVERT TO HEX
         J    CONTYC                  :ERROR
         LH   R10,RUCNT
         JN   CONTYA                  :SECOND NIBBLE
         SLLS R0,4
         STH  R0,NIBHLD
         LIS  R5,1
         STH  R5,RUCNT
CONTYZ   SIS  R9,1
         JG   CONTY9
         JAL  R4,ELIR,,
         J    REST,,
CONTYA   AHM  R0,NIBHLD
         LH   R0,NIBHLD               :GET COMPLETE BYTE
CONTYX   AIS  R0,0D                   :ADD LENGTH OF TH & RH
         LB   R4,DEFSES               :LU-LU OR SSCP-LU?
         STB  R0,RUTABL,R4
         LR   R0,R9
         SIS  R0,1
         JAL  R4,FLUSH,,
         LIS  R5,0
         STH  R5,INPTSW
         STH  R5,RUCNT
         STH  R5,MODESW
         STH  R5,NIBHLD
         HLPLIN(PROMPT)
         J    REST,,

CONTYB   LH   R0,RUCNT                :GOT CR, END THE INPUT
         JE   CONTYX                  :TREAT NO INPUT AS ZERO
         LH   R0,NIBHLD               :GET PARTIAL LENGTH
         SRLS R0,4
         J    CONTYX

:--- ERROR IN INPUT, NOT HEX CHARACTER
CONTYC   HLPLIN(BKSPC)
         J    CONTYZ


:---- COME HERE TO INPUT HEX CHARACTERS TO MANDAT RH

CONTY0   LIS  R5,0D                   :STOP INPUT AFTER LAST RH BYTE
         STH  R5,MANMAX
         LA   R12,MANDAT              :BUFFER TO INPUT THE DATA TO
         J    CONTT3                  :USE THE CONTROL-T ROUTINE

:---- COME HERE TO SET THE EXPEDITE BIT IN THE TH ----:
CONTYJ   LHI  R5,$A39                 :BIT 39 IS THE EXPEDITE BIT
         SBT  R5,MANDAT
         LIS  R5,0
         STH  R5,INPTSW
         HLPLIN(PROMPT)
         J    REST,,

:---- COME HERE TO RESET THE EXPEDITE BIT IN THE TH OF MANDAT ----:
CONTYK   LHI  R5,$A39                 :BIT 39 IS EXPEDITE
         RBT  R5,MANDAT
         LIS  R5,0
         STH  R5,INPTSW
         HLPLIN(PROMPT)
         J    REST,,

:---- COME HERE TO SET OR RESET THE VTAUTO BIT ARRAY ----:
         IF VTAMRF                    :IF GENNED FOR CMH
CONTYM   HLPLIN(LEFT0C)
         LHI  R5,28                   :TELL IMORG TO BORROW CONTN0 FOR LU INPT
         STH  R5,INPTSW
         J    REST,,

:----- COME HERE FROM CONTN0 TO SET/RESET THE VTAUTO ARRAY -----:
CONTYN   LIS  R5,0
         STH  R5,INPTSW
         LH   R6,HOLDLU               :GET RELATIVE LU NUMBER
         LA   R3,LEFT1B               :VTAUTO NOW SET
         CBT  R6,VTAUTO               :CHANGE VALUE
         JEFS CYYN02
         LA   R3,LEFT1C               :VTAUTO ARRAY NOW RESET
CYYN02   LH   R2,RPORT
         JAL  R5,OCS,,
         HLPLIN(PROMPT) 
         J    REST,,
         EI (VTAMRF)
:-----  COME HERE TO CHANGE RH OF SSCPDT -----
CONTYP   HLPLIN(LEFT11)
         LHI   R5,2C
         STH   R5,INPTSW              :TELL IMORG TO GO TO CONTYQ
         LIS   R5,1
         STH   R5,MODESW
         LIS   R5,0
         STH   R5,RUCNT
         LIS   R5,0A
         STH   R5,MANIX
         J     REST,,

:------ COME HERE FROM IMORG TO INPUT THE NEW SSCPDT RH -----
CONTYQ   LIS   R5,0D                  :SEE CONTY0 & CONTYO FOR COMMNETS
         STH   R5,MANMAX
         LA    R12,SSCPDT
         J     CONTT3

:------ COME HERE TO COMPLIMENT THE FIRST SEG BIT OF SSCPDT -------
CONTYR   LHI   R5,$A36                :FIRST SEG IS 36th BIT
CNTYRR   LA    R3,LEFT29              :BIT IS NOW 0
         CBT   R5,SSCPDT
         JNFS  .+6                    :WAS 1 IS NOW 0
         LA    R3,LEFT2A              :BIT IS NOW 1
         LH    R2,RPORT
         JAL   R5,OCS,,
         HLPLIN(PROMPT)
         LIS   R5,0
         STH   R5,INPTSW
         J     REST,,

:------ COME HERE TO CHANGE THE LAST SEG BIT OF SSCPDT ------
CONTYS   LHI   R5,$A37                :LAST SEG BIT=37
         J     CNTYRR

:------ COME HERE TO INPUT THE NEW UNBIND REASON CODE -------
CONTYY   HLPLIN(LEFT35)
         LHI   R5,21                  :TELL IMORG TO GO TO CNTYY0
         STH   R5,INPTSW
         LIS   R5,0
         STH   R5,RUCNT
         STH   R5,CHARIX
         J     REST,,
CNTYY0   JAL   R4,GETCH,,
         LR    R9,R0
CNTYY1   JAL   R4,GETCH,,
         SIS   R9,1
         JAL   R10,CHKECH
         JAL   R10,CONATH
         J     RETCM0
         LH    R10,CHARIX
         JN    CNTYY2
         LIS   R10,1
         STH   R10,CHARIX
         SLLS  R0,4
         STB   R0,RUCNT               :SAVE FIRST NIBBLE
         CHI   R9,0
         JG    CNTYY1
         JAL   R4,ELIR,,
         J     REST,,
CNTYY2   LB    R10,RUCNT
         AR    R0,R10
         STB   R0,MANUBN+0E,,         :SAVE NEW REASON
         LR    R0,R9
         JAL   R4,FLUSH,,
         LIS   R4,0
         STH   R4,RUCNT
         STH   R4,CHARIX
         STH   R4,INPTSW
         HLPLIN(PROMPT)
         J     REST,,

:!@#!@#!@#!@#!@#!@#!@#!@#!@#!@#!@#!@#!@#
: part of CONTROL-Y
: come here to display data for LU 0
DSPLU0   HLPLIN(CRALF)
         LB    R5,BUFLIX,,            :GET POINTER TO NEXT BUFFER
DSPL01   SIS   R5,1                   :NOW POINTS TO LAST FRAME
         JGEFS DSPL02
         LIS   R5,WINDSZ-1
DSPL02   LR    R6,R5
         LHI   R4,LUBSIZ
         MHR   R6,R4
         LHL   R7,BUFLU,R6,           :GET LENGTH OF DATA
         JE    DSPLND                 :NO DATA, SO QUIT
         LB    R4,BUFLU+2,R6,         :GET 1st TH BYTE
         NHI   R4,08                  :1st SEGMENT?
         JE    DSPL01
         STB   R5,HLDSPT              :SAVE YOUR PLACE IN LINE
         HLPLIN(THEADR)               :SEND ---- TH -----
         HLPLIN(RHEADR)               :SEND -- RH --
DSPL04   CHI   R7,LUBSIZ-2
         JLEFS .+6
         LHI   R7,LUBSIZ-2
         LIS   R12,2
         LIS   R11,0
DSPL05   LA    R10,BUFLU+2,R6,R11,
         LIS   R9,1
         LA    R8,LUDMP,R12 
         JAL   R4,BINHEX,,
         JAL   R13,DSPCH2             :SEE IF TIME TO SEND PRINTLINE
         AIS   R11,1
         SIS   R7,1
         JLE   DSPL06
         LA    R10,BUFLU+2,R6,R11,
         LIS   R9,1
         LA    R8,LUDMP,R12
         JAL   R4,BINHEX,,
         JAL   R13,DSPCHK             :SEE IF TIME TO SEND PRINT LINE
         AIS   R11,1
         SIS   R7,1
         JG    DSPL05
DSPL06   STB   R12,LUDMPL
         HLPLIN(LUDMPL)
         LB    R4,BUFLU+2,R6,
         NHI   R4,04                  :LAST SEGMENT?
         JN    DSPFIN                 :YES, ALL DONE
         LB    R6,HLDSPT              :GET YOUR PLACE IN LINE BACK
         AIS   R6,1
         CHI   R6,WINDSZ
         JLFS  .+4
         LIS   R6,0
         STB   R6,HLDSPT
         LHI   R4,LUBSIZ
         MHR   R6,R4
         LHL   R7,BUFLU,R6,           :GET LENGTH
         JLE   DSPERR
         HLPLIN(THEADR)
         HLPLIN(CRALF)
         J     DSPL04
DSPFIN   HLPLIN(PROMPT)
         LIS   R5,0
         STH   R5,INPTSW
         J     REST,,
DSPERR   HLPLIN(DSPERM)
         J     DSPFIN
DSPLND   HLPLIN(DSPNDT)
         J     DSPFIN

:--- THIS IS THE SUSPENDER ---:
DSPCHK   AIS   R12,1
DSPCH2   AIS   R12,2
         CHI   R12,29                 :PRINT LINE FULL?
         JLR   R13
         STB   R12,LUDMPL             :LENGTH OF PRINT LINE
         HLPLIN(LUDMPL)               :PRINT IT
         HLPLIN(CRALF)
         LHI   R4,20
DSPCH4   STB   R4,LUDMP,R12           :ERASE PRINT LINE
         SIS   R12,1
         JGBS  DSPCH4
         SBT   R12,SUSPEND
         LIS   R12,2
         STM   R6,DSPSAV
         J     REST2,,


         
:========================================================================
: COME HERE VIA CONTROL-N TO INPUT A NEW SNF

CONTE    HLPLIN(LEFT0C)
         LHI  R5,1D                   :TELL IMORG TO GO TO CONTN0
         STH  R5,INPTSW
         J    REST,,

:---- COME HERE TO GET THE LU NUMBER

CONTN0   JAL  R4,GETCH,,              :GET LENGTH
         LR   R7,R0
         JAL  R4,GETCH,,
         LR   R6,R0
         LR   R0,R7
         SIS  R0,1
         JAL  R4,FLUSH,,
         NHI  R6,7F
         CHI  R6,30
         JL   CONTN1
         CHI  R6,46
         JG   CONTN1
         CHI  R6,39
         JLEFS .+6
         SHI  R6,7                    :CONVERT TO HEX
         NHI  R6,0F
         STH  R6,HOLDLU
         IF VTAMRF                    :IF GENNED FOR CMH
         LH   R5,INPTSW
         CHI  R5,28                   :IF 28 THEN GO TO CONTYN TO CHANGE 
         JE   CONTYN                  :VTAUTO
         EI (VTAMRF)
         LHI  R5,1E                   :TELL IMORG TO GO TO CONTT2 NEXT
         STH  R5,INPTSW
         HLPLIN(LEFT12)
         LIS  R5,0
         STH  R5,MANIX
         STH  R5,RUCNT
         LIS  R5,2
         STH  R5,MANMAX               :SNF IS TWO BYTES
         STH  R5,MODESW               :USE HEX MODE IN CONTT3
         J    REST,,
CONTN1   HLPLIN(BKSPC)
         J    REST,,

:---- COME HERE TO INPUT THE SNF

CONTN3   LH  R5,HOLDLU                :GET THE SPECIFIED LU (IN CONTN0)
         LA  R12,LUSNF,R5,R5          :ADDRESS OF BUFFER FOR CONTT3
         J   CONTT3






:===========================================================================
: THIS ROUTINE PRINTS THE STATE FOR EACH L.U.
:  STATE  MEANING
:  -----  -------
:   00    NOT ACTIVATED
:   01    PENDING ACTIVATION
:   02    ACTIVE
CONT15   LIS R7,0                     :CONTROL-U
         LIS R14,2                    :PRINT INDEX
         LIS R6,0                     :P.U. INDEX
CNT151   LA  R8,STAT1+$A14            :BINHEX OUTPUT AREA
         LIS R9,1                     :CONVERT 2 DIGITS
         LA  R10,PUTAB,R6             :BINHEX INPUT AREA
         JAL R4,BINHEX,,              :CONVERT PU ADDRESS FROM HEX TO ASCII
         JAL R13,PRTHDG               :PRINT PU & LU HEADINGS
         RBT R6,REJIND                :SEE IF FRAME REJ RECEIVED
         JEFS HELWEN
         HLPLIN(STAT9)
HELWEN   RBT R6,FRMIND                :SEE IF FRMR CAME IN FOR THIS GUY
         JEFS CNT150
         HLPLIN(STAT8)
CNT150   LB  R12,LUPRPU,R6,           :GET NUMBER OF LU'S FOR THIS PU
         STH R12,LUPUNM
         LIS R12,0                    :16 STATES PER LINE COUNTER
CNT152   LA  R8,STAT3,R14             :BINHEX OUTPUT AREA
         LIS R9,1                     :TWO BYTES LONG (ASCII BYTES)
         LA  R10,DAF,R7,              :GET HEX LU ADDRESS
         JAL R4,BINHEX,,              :CONVERT HEX LU ADDRESS TO ASCII
         LA  R8,STAT5,R14             :ADDRESS OF BINHEX OUTPUT AREA
         LIS R9,1                     :TWO ASCII BYTES LONG
         LA  R10,LUSTAT,R7,           :GET HEX LU STATE
         JAL R4,BINHEX,,              :CONVERT STATE FROM BINARY TO ASCII
         LA  R8,STAT7,R14             :OUTPUT AREA
         LIS R9,1                     :ONE BYTE
         LA  R10,FMDCTR+1,R7,R7       :GET FMD COUNTER AS INPUT
         JAL R4,BINHEX,,
         AIS R14,4                    :INCREMENT PRINT LINE INDEX
         AIS R7,1                     :INCREMENT LU COUNTER
         AIS R12,1                    :INCREMENT 16/LINE COUNTER
         LCS R4,1
         AHM R4,LUPUNM                :DECREMENT LU-PER-PU COUNTER
         JLE CNT154
         CHI R12,$A15
         JL  CNT152
         JAL R13,PRTSTE               :PRINT STATE & ADDRESS
         LIS R12,0
         LIS R14,2
         J   CNT152
CNT154   JAL R13,PRTSTE               :PRINT LU ADDRESS & STATE
         AIS R6,1
         LIS R14,2
         SVC DISMIS                   :LET ISIS REMOVE PREVIOUS JUNK
         CHI R6,NUMPU                 :SEE IF ALL PU'S PROCESSED
         JL  CNT151
         HLPLIN(PROMPT)
         J   REST,,

:-------------------------------------------------------------------------

PRTSTE   HLPLIN(STAT2)                :PRINT "LU ADDR."
         HLPLIN(STAT3)                :PRINT LU ADDRESSES
         HLPLIN(STAT4)
         HLPLIN(STAT5)
         LB  R2,STAT3
         LIS R3,1
         LHI R4,0A0                   :FILL IN STAT3 WITH SPACES
PRTST4   STB R4,STAT3,R3
         AIS R3,1
         CR  R3,R2
         JLE PRTST4
         LB  R2,STAT5
         LIS R3,1
PRTST6   STB R4,STAT5,R3
         AIS R3,1
         CR  R3,R2
         JL  PRTST6
         HLPLIN(STAT6)
         HLPLIN(STAT7)
         LB  R5,STAT7
         SIS R5,1
         LHI R4,0A0
PRTST7   STB R4,STAT7,R5
         SIS R5,1
         JGBS PRTST7
         JR  R13



:-------------------------------------------------------------------------

PRTHDG   HLPLIN(STAT1)                :PRINT PU STATE
         LB  R2,PUACT,R6              :GET PU ACTIVATION STATE
         CHI R2,0FE                   :SEE IF IT IS IDLE
         JN  PRTHD0
         HLPLIN(PUSFE)
         JR  R13
PRTHD0   CHI R2,0FF                   :SEE IF IT IS POLLING
         JN  PRTH00
         HLPLIN(PUSFF)
         JR  R13
PRTH00   CHI R2,0
         JN  PRTHD1
         HLPLIN(PUS0)
         JR  R13
PRTHD1   CHI R2,3
         JGE PRTHD2
         HLPLIN(PUS12)
         JR  R13
PRTHD2   CHI R2,3
         JN  PRTHD3
         HLPLIN(PUS3)
         JR  R13
PRTHD3   CHI R2,7                     :DISC STATE?
         JE  PRTHD5
         HLPLIN(PUS4)
         JR   R13
PRTHD5   HLPLIN(PUS7)
         JR  R13



::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE TURNS OFF MANUAL OVERRIDE FOR THE SPECIFIED LU       :::

CONT16   HLPLIN(LEFT0C)
         LHI  R5,27
         STH  R5,INPTSW
         J    REST,,

CNT162   JAL  R4,GETCH,,
         LR   R9,R0
         JAL  R4,GETCH,,
         SIS  R9,1
         LR   R8,R0
         LR   R0,R9
         JAL  R4,FLUSH,,
         LR   R0,R8
         JAL  R10,CHKECH
         JAL  R10,CONATH
         J    CNT169
         RBT  R0,MANUAL
         HLPLIN(LEFT0E)
         LIS  R5,0
         STH  R5,INPTSW
         HLPLIN(PROMPT)
         J    REST,,
CNT169   HLPLIN(BKSPC)
         J    REST,,
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::    THIS ROUTINE TOGGLES THE SECOND BIT OF "WAITBT" TO CONTROL THE  :::
::: SENDING OF THE RESPONSE TO TERMSELF/RSHUTD                         :::

CONT17   LIS  R5,1
         SBT  R5,WAITBT,,
         JE   CNT174
         HLPLIN(LEFT0B)
         LHI  R5,20
         STH  R5,INPTSW               :SET IMORG SWITCH
         J    REST,,
CNT174   HLPLIN(LEFT09)
         J    CNT178

CNT176   JAL  R4,GETCH,,
         LR   R9,R0
         JAL  R4,GETCH,,              :GET ANSWER
         LIS  R4,0
         STH  R4,INPTSW
         LR   R8,R0
         LR   R0,R9
         SIS  R0,1
         JAL  R4,FLUSH,,
         LR   R0,R8
         NHI  R0,7F
         LIS  R4,1
         RBT  R4,WAITBT,,             :EITHER WAY THIS GETS TURNED OFF
         OHI  R0,20                   :ACCOUNT FOR LOWER CASE
         CHI  R0,79                   :Y?
         JN   CNT178
         HLPLIN(LEFT0A)
         HLPLIN(PROMPT)
         LA   R4,CKLUT4               :RETURN ADDRESS FOR BLDTRP/RRP
         LHI  R5,NUMLU-1
CNT177   LB   R7,LUSTAT,R5,
         JEFS .+0A
         LHI  R7,0BB
         STB  R7,LUSTAT,R5,
         SIS  R5,1
         JGE  CNT177
         LIS  R2,0                    :INITIALIZE TO LU 0
         JAL  R5,CKLUTM               :GO SEND TERMSELFs/RSHUTDs
         J    REST,,
CNT178   LH   R2,RPORT
         LA   R3,PROMPT
         JAL  R5,OCS,,
         J    REST,,

:-------------------------------------------------------------------------
:  THIS IS THE OPERATOR LOGOFF ROUTINE (CONTROL-Z)

CONT1A   LH  R2,RPORT
         LA  R3,AUFWDR
         JAL R5,OCS,,
         LH  R2,RPORT
         LA  R3,DETCH
         JAL R5,OCM,,
         LIS R5,0
         STH R5,RPORT
         J   REST,,

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE EXPECTS THE DATA TO BE FLUSHED, IT SENDS THE WORD
:::  "ESCAPE" AND THE EXEC PROMPT AND SET INPTSW BACK TO ZERO
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

RETEXC   LIS  R5,0
         STH  R5,INPTSW
         HLPLIN(LEFT08)               :<escape!>
         HLPLIN(PROMPT)
         J    REST,,

:---------------------------------------------------------------------------


:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::                                                                     :::
:::                 F  O  R  E  G  R  O  U  N  D                        :::
:::                                                                     :::
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

         REMARK %   genning FOREGROUND
STRFGN   LIS R1,LUN          :START FOREGROUND, LOAD LOGIC UNIT NUM
         LA  R2,SIOSTR,,     :GET BEGINNING OF SIO AREA
         LA  R3,SIOEND,,     :GET END OF SIO AREA
         LA  R4,SIOSTS,,
         SVC IO,CONMOM+R1
         HC  0,0
         SVC DISMIS,1
CHOUT    LIS R1,LUN          :OUTPUT SETUP CHANNEL COMMAND PROG
         LA  R2,SETUP,,
         SVC IO,FRCMBO+R1
         HC  0,0
         SVC DISMIS,1
STINP    LIS R1,LUN            :START INPUT
         LA  R2,SIOIN,,
         SVC IO,FRCMBI+R1
         HC  0,0
         LIS R2,0
         SVC DISMIS,1




:<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
:<><>                                                                  <><>
:<><> THIS IS WHERE THE VARIOUS PUSTATES ARE HANDLED                   <><>
:<><>                                                                  <><>
:----- 00 = SEND SNRM (SET WITH ^F IN BACKGROUND)
:----- 01 = SNRM TIME OUT, WAITING 6 SECONDS TO RETRY
:----- 02 = UA RECEIVED (IN RESPONSE TO SNRM)
:----- 03 = SENT RR, WAITING 1/2 SECOND
:----- 04 = RR RECEIVED
:----- 05 = B.G. REQUESTED TO CONSTRUCT SPECIAL FRAME SEQUENCE (VIA CONTROL-X)
:----- 06 = F.G. TO SEND SPECIAL FRAME SEQUENCE
:----- 07 = SEND RR
:----- 08 = TELL B.G. TO WAIT UNTIL SPECIAL SEQ SENT
:----- 09 = ACTIVATE LU
:----- 0A = WAITING FOR LAST INFO FRAME WITH THE FINAL BIT SET
:----- 0B = SNRM SENT, WAITING 1 SECOND FOR A UA
:----- 0C = F.G. WILL SEND 1 XID AND THEN GO TO IDLE (FF)
:----- 0D = F.G. WILL SEND XID, START TIMER AND CHANGE TO 0E
:----- 0E = B.G. WILL CHECK XID TIMER, CHANGE TO 0D WHEN IT EXPIRES
:----- 0F = IDLE (DO NOTHING)
:----- 10 = B.G. REQUESTED DACTPU TO BE SENT
:----- 11 = DISC SENT, WAITING 1 SECOND FOR UA
:----- 12 = SEND DISC (SET WITH ^D IN BACKGROUND)
:----- 13 = DISC TIME OUT, WAITING 6 SECONDS FOR UA
:----- 14 = B.G. WANTS TEST FRAME SENT, THEN SWITCH TO STATE=3
:----- 15 = F.G. SENDING RESPONSE-TIME TESTING DATA FRAMES


FGLOOP   JAL R4,SNDSCK        :SEE IF WAITING FOR UA TO SNRM OR DISC
         J   FGNRS2           :NORMAL RETURN=WAITING
         L   R1,FGRTAR,,      :RESPONSE TIME TESTING?
         JN  RSPPUT           :YES
         LB  R5,PUSTAT,R2,    :GET FOREGROUND STATE
         CHI R5,15            :RANGE CHECK
         JLEFS FGLOP0         :GOOD
         HC  0
FGLOP0   LHL R4,FGTABL,R5,R5  :GET ADDRESS TO EXECUTE
         J   FSEG,R4,

FGTABL   HC  SNDSNM-FSEG      :0=SEND SNRM
         HC  FGNRST-FSEG      :1=F.G. DOES NOTHING
         HC  FGNRST-FSEG      :2=F.G. DOES NOTHING
         HC  FGNRST-FSEG      :3=F.G. DOES NOTHING
         HC  FGNRST-FSEG      :4=F.G. DOES NOTHING
         HC  FGNRST-FSEG      :5=F.G. DOES NOTHING
         IF SPCSEQ
         HC  SNDSPC-FSEG      :6=SEND SPECIAL SEQUENCE
         ELSE
         HC  FGNRST-FSEG      :6=F.G. DOES NOTHING
         EI
         HC  SETUPR-FSEG      :7=SEND RECEIVE READY
         HC  FGNRST-FSEG      :8= F.G. DOES NOTHING
         HC  FGNRST-FSEG      :9= F.G. DOES NOTHING
         HC  FGNRST-FSEG      :A= F.G. DOES NOTHING
         HC  FGNRST-FSEG      :B= F.G. DOES NOTHING
         HC  SND1XD-FSEG      :C= F.G. SENDS 1 XID AND RETURNS TO FF
         HC  SNDXID-FSEG      :D= F.G. SEND XID AND STARTS TIMER
         HC  FGNRST-FSEG      :E= F.G. DOES NOTHING
         HC  FGNRST-FSEG      :F= F.G. DOES NOTHING
         HC  FGNRST-FSEG      :10 - F.G. DOES NOTHING (FORMERLY DE-ACTPU)
         HC  FGNRST-FSEG      :11 = F.G. DOES NOTHING
         HC  SNDISC-FSEG      :12 = SEND DISCONNECT
         HC  FGNRST-FSEG      :13 = F.G. DOES NOTHING
         HC  SNDTST-FSEG      :14 = F.G. SENDS TEST FRAME
         HC  FGNRST-FSEG      :15 = F.G. SENDING RESPONSE-TIME TEST DATA

FGNRST   AIS R2,1
         CHI R2,NUMPU
         JL  FGLOOP
         LIS R2,0
FGNRS2   JAL R12,CKSIN
         J   FGNRS5
         J   PULSIO
FGNRS5   JAL R12,FLGTST               :GO CHECK SPECIAL FLAGS
         JAL R0,LUSTLP                :GO RUN THROUGH LU STATE LOOP
FGNRS6   SVC DISMIS
         LIS R2,0
         J   FGLOOP

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::   this routine checks special flags to see if 0. waiting for UA  
:::                                               1. change state of DTR
:::   Skip return if waiting for UA to prevent processing LUSTLP.

FLGTST   LIS  R1,0
         TBT  R1,DONTHG,,             :WAITING FOR UA?
         JN   4,R12                   :YES, SKIP LUSTLP
         AIS  R1,1                    :CHECK DTR BIT
         RBT  R1,DONTHG,,
         JER  R12                     :DON'T CHANGE DTR
         L    R15,DTRDCM,,            :ASSUME DROPPING DTR
         TBT  R1,DTRARY,,             :VERIFY
         JNFS FLGT10                  :YES, DROP IT
         L    R15,DTRUCM,,            :RAISE DTR
FLGT10   JAL  R13,SIODTR
         JR   R12




:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE CHECKS TO SEE IF IS IS TIME TO SEND RR OR DATA FOR EACH
:::  PU DURING RESPONSE TIME TESTING

RSPPUT   JAL  R10,SIOCHK
         FGLOG(RSPPUT)
         L    R1,RREEFI               :RECEIVED INFO FRAME
         JEFS RSPP03                  :NO
         LIS  R2,0
         ST   R2,FGRTAR,,             :GO TO WORK ON PU IN R1
         JFFO R1,RSPP01
RSPER0   HC   0
RSPP01   RBT  R2,RREEFI               :SEND FOR PU WHICH JUST GOT INFO
         J    RSPP23
RSPP03   L    R1,FGRTAR,,
         JFFO  R1,RSPP10              :R2=PU#
RSPER1   HC   0                       :NO PU TO SEND
RSPP10   RBT  R2,RRARAY,,             :TIME TO SEND RR?
         JN   RSPP20                  :NO
         JAL  R4,XRR                  :GO SEND RR
         RBT  R2,FGRTAR,,             :RESET F.G. ARRAY, LETT B.G. SCAN
         SBT  R2,BGRTAR,,
         LIS  R4,0
         SBT  R4,XMTRCV               :WILL BE RESET WHEN SOMETHING IS RCV'D
         J    FGNRS2
RSPP20   RBT  R2,RNRARY,,             :SEE IF RECEIVING RNRs
         JN   RSPP10                  :YES, JUST SEND RR
RSPP23   LB   R6,HIFRR,R2,            :RUNNING SLOW?
         CLB  R6,EXPNS,R2,
         JN   RSPP80                  :YES, GO REXMT
         LR   R12,R2
         SLLS R12,2
         L    R4,LUTXMT,R2,           :GET LU BIT ARRAY
         JFFO R4,RSPP30               :R5 WILL HAVE LU #
         LIS  R5,0                    :DEFAULT TO 1st LU
RSPP30   LR   R4,R5
         AIS  R4,1                    :ADVANCE TO NEXT LU
         CLB  R4,LUPRPU,R2,
         JLFS RSPP33
         LIS  R4,0
RSPP33   SBT  R4,LUTXMT,R12,          :MARK NEXT LU
         JAL  R4,XLU                  :XMT FOR THIS LU
         RBT  R2,FGRTAR,,             :TRANSFER CONTROL TO BG
         SBT  R2,BGRTAR,,
         LIS  R4,0
         SBT  R4,XMTRCV               :WILL BE RESET WHEN SOMETHING IS RCV'D
         J    FGNRS2
:-- come here to prepare to rexmt --:
RSPP80   LB   R9,EXPNS,R2,            :GET OUR EXPECTED NEXT N(S)
         CR   R9,R6
         JGFS RSPP82
         AHI  R9,10
RSPP82   SR   R9,R6                   :NEED TO RESEND R9/2
         LHI  R12,IFSIZE*2
         SRLS R9,1                    :NEED TO RESEND THIS MANY
         LR   R7,R9
         LIS  R13,6
         SR   R13,R9                  :CALCULATE STARTING SECTOR
         LR   R9,R13
         IF S7200
         LI   R13,(IFSIZE*2*8*$A600)/7200
         else
         LI   R13,(IFSIZE*2*8*$A600)/56000
         ei
         MHR  R13,R7
         A    R13,FASTC,,
         AI   R13,$A600
         LR   R10,R2
         SLLS R10,2
    :    ST   R13,PUTIM,R10,
         ST   R13,LINTIM,,            :JUST USE 1 LINE TIMER
         LR   R7,R9                   :save starting rexmt sec
         MHR  R12,R9                  :INDEX TO IOUT0
         SLLS R9,4                    :INDEX TO SIOCHN
         LR   R13,R2
         SLLS R13,2
         L    R10,LUTXMT,R13,
         JFFO R10,RSPP86
         LB   R11,LUPRPU,R2,          :DEFAULT TO LAST LU
RSPP86   CHI  R11,0
         JGFS RSPP88
         LB   R11,LUPRPU,R2,
RSPP88   SIS  R11,1                   :RESEND FOR THIS LU
         JAL  R4,XLUE                 :GO REXMT
         RBT  R2,FGRTAR,,
         SBT  R2,BGRTAR,,             :TRANSFER CONTROL TO BG
         LIS  R4,0
         SBT  R4,XMTRCV               :WILL BE RESET WHEN SOMETHING IS RCV'D
         J    FGNRS2                  :PREVENT LOOP

:========================================================================
: THIS ROUTINE SENDS A RESPONSE-TIME-TESTING RR

XRR      JAL   R10,SIOCHK
         FGLOG(XRR   )
         LIS   R5,2
         STH   R5,OUTBUF,,
         LB    R5,PUTAB,R2
         STB   R5,OUTBUF+2,,
         LB    R5,PURRNR,R2,
         AHI   R5,11
         STB   R5,OUTBUF+3,,
         LIS   R5,1
         STH   R5,SIOOUT,,
         JAL   R13,SIOSND
         LR    R13,R2
         SLLS  R13,1
         L     R5,FASTC,,
         AI    R5,$A600               :ALLOW 1 SECOND TO RESPOND
 :       ST    R5,PUTIM,R13,R13
         ST    R5,LINTIM,,            :JUST USE 1 LINE TIMER
         JR    R4



::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE XMTs THE FRAMES FOR THE LUs DURING RESPONSE-TIME-TESTING

XLU      LIS  R8,0
         FGLOG(XLU   )
         LIS  R9,0
         LB   R6,PUTAB,R2             :GET THIS PUs ADDRESS
         LHI  R10,0C6C1               :FA
         LHI  R7,0E300                :T00
         LR   R2,R2                   :PU 0?
         JNFS XLU12
         LB   R13,RATLU,R5,           :SEE IF SELECTED LU
         JEFS XLU12
         LHI  R10,0D9C1               :RA
XLU12    STH  R10,IOUT0+$A42,,
         STH  R7,IOUT0+$A44,,
         LR   R13,R2
         SLLS R13,5
         LB   R13,DAFR,R13,R5         :GET DAF
         SLLS R5,1
         LIS  R15,1  
         AHM  R15,LUSNFR,R13,R5
         LHL  R15,LUSNFR,R13,R5
XLU15    STB  R6,IOUT0+2,R9,          :SAVE PU ADDRESS
         LB   R7,EXPNS,R2             :OUR N(S)
         LB   R10,PURRNR,R2
         AR   R10,R7
         CHI  R8,5
         JNFS XLU16
         OHI  R10,10                  :TURN ON POLL BIT FOR LAST FRAME
XLU16    STB  R10,IOUT0+3,R9,         :CONTROL FIELD
         AIS  R7,2
         NHI  R7,0E
         CHI  R8,4                    :NEXT TO LAST FRAME?
         JNFS XLU18
         RBT  R2,RREEFS,,             :BUMP N(S) BY 2 MORE?
         JEFS XLU18                   :NO
         AIS  R7,2
         NHI  R7,0E
XLU18    STB  R7,EXPNS,R2
         STB  R13,IOUT0+6,R9,
         STH  R15,IOUT0+8,R9,
         L    R10,FASTC,,
         ST   R10,IOUT0+$A24,R9,
         AHI  R9,IFSIZE*2
         AIS  R8,1
         CHI  R8,6
         JL   XLU15
    :    LIS  R10,2
    :    STH  R10,IOUT0,R9,
    :    STB  R6,IOUT0+2,R9,
    :    LB   R7,PURRNR,R2
    :    AHI  R7,11
    :    STB  R7,IOUT0+3,R9,
         LIS  R10,1
         LIS  R9,0
         LIS  R7,2
XLU20    STH  R10,SIOCHN,R9,
         STH  R7,SIOCHN+4,R9,
         AHI  R9,10
         CHI  R9,60
         JL   XLU20
         L    R7,FASTC,,
         if S7200
         AI   R7,(8*IFSIZE*2*6*$a600)/7200
         else
         AI   R7,(8*IFSIZE*2*6*$A600)/56000
         ei
         AI   R7,$A600
         lr   r8,r2
         slls r8,2
 :       st    r7,putim,r8,
         ST    R7,LINTIM,,           :JUST USE 1 LINE TIMER
         LIS  R7,0
         STH  R7,SIOCHN+4-10,R9,     :don't chain for 6th frame (used to be rr)
    :    STH  R10,SIOCHN,R9,
         LIS  R8,0
         LA   R9,SIOCHN,,
         SVC  IO,FRCMBO+R8
         HC   0,0
         JR   R4

:==========================================================================
:  THIS ROUTINE HANDLES LOST DATA FRAMES

XLUE     LIS  R10,1                   :XMT CMD FOR CCW
         FGLOG(XLUE  )
         LB   R6,HIFRR,R2,            :GET EXPECTED HIF N(S)
         LR   R13,R2
         SLLS R13,5
         SLLS R11,1
         LHL  R14,LUSNFR,R11,R13
         SIS  R14,1
         SRLS R11,1
         LB   R15,DAFR,R11,
XLUE22   STH  R10,SIOCHN,R9,          :SET UP XMT CCW AGAIN
         LB   R13,PUTAB,R2,           :GET PU ADDRESS
         STB  R13,IOUT0+2,R12,
         LB   R13,PURRNR,R2,          :GET N(R)
         AR   R13,R6                  :ADD IN N(S)
         CHI  R9,50                   :LAST FRAME?
         JNFS XLUE24
         OHI  R13,10                  :SET POLL BIT IN LIEU OF RR
XLUE24   STB  R13,IOUT0+3,R12,
         AIS  R6,2
         NHI  R6,0E
         L    R13,FASTC,,
         ST   R13,IOUT0+$A24,R12,     :NEW TIME-STAMP
         STB  R15,IOUT0+6,R12,        :INSERT OLD LU ADDRESS
         STH  R14,IOUT0+8,R12,
         AHI  R12,IFSIZE*2
         AHI  R9,10
         CHI  R9,60
         JL   XLUE22
     :   LB   R13,PURRNR,R2,          :GET RR
     :   OHI  R13,11                  :ALLOW HIF TO SEND
     :   STB  R13,IOUT0+3,R12,
     :   LB   R13,PUTAB,R2,
     :   STB  R13,IOUT0+2,R12,
     :   STH  R10,SIOCHN,R9,          :SEND RR TOO
         AHM  R10,DTLCTR              :COUNT DATA-LOSS EVENTS
         LIS  R8,0
         SLLS R7,4
         LA   R9,SIOCHN,R7,
         SVC  IO,FRCMBO+R8
         HC   0,0
         JR   R4


:--------------------------------------------------------------------------
: THIS ROUTINE SENDS A SNRM FOR PU ADDRESSED BY R2 INDEX.  IT ALSO STARTS
: A SNRM RETRY TIMER.  IT SETS THE "PUSTAT"=1 AND SETS PUACT=FF.

SNDSNM   JAL R10,SIOCHK
         FGLOG(SNDSNM)
         LHI R5,0B
         STB R5,PUSTAT,R2             :SET STATE OF PU TO "SENT SNRM"
         L   R5,FASTC,,
         STH R2,CURPU
         LIS R1,4
         MHR R2,R1
         ST  R5,PUTIM,R2              :SAVE CURRENT TIME
         LH  R2,CURPU
         LB  R7,PUTAB,R2
         LIS R5,2
         STH R5,OUTBUF,,              :NUMBER OF BYTES TO SEND
         LB  R8,SNRM
         STB R7,OUTBUF,R5,
         AIS R5,1
         STB R8,OUTBUF,R5,
         LHI R8,0FF
         STB R8,PUACT,R2              :SET PU ACT STATE=POLLING
         LIS R8,0
         SBT R8,DONTHG                :SET WAIT FLAG
         J   GOOUT
                    
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE SENDS THE SDLC TEST FRAME (E3)

SNDTST   JAL  R10,SIOCHK              :SEE IF SIO IS FINISHED
         fglog(SNDTST)
         LHI  R10,TESTFL-2            :LENGTH OF TEST FRAME
         STH  R10,OUTBUF,,
         LB   R10,PUTAB,R2            :GET PU ADDRESS
         STB  R10,OUTBUF+2,,
         LIS  R7,3
SNDTS2   LB   R6,TESTFM,R7,
         STB  R6,OUTBUF,R7,
         AIS  R7,1
         CHI  R7,TESTFL
         JL   SNDTS2
         LIS  R10,3                   :CHANGE TO "RR SENT" STATE
         STB  R10,PUSTAT,R2
         LR   R6,R2
         SLLS R6,2
         L    R10,FASTC,,
         ST   R10,TFRMTM,R6           :START TIMER
         ST   R10,OUTBUF+4,,          :TIME STAMP
         J    GOOUT



:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE SENDS OUT THE SPECIAL FRAME SEQUENCE REQUESTED BY CONTROL-X

        IF SPCSEQ
SNDSPC  JAL  R10,SIOCHK
        FGLOG(SNDSPC)
        LHI  R6,NUMSPC
        LIS  R5,1
        LIS  R4,0
        LIS  R10,0
SNDSP2  STH  R5,SIOCHN,R4,            :PUT SEND (1) COMMAND IN EACH SECTOR
        LB   R9,PURRNR,,
        LB   R8,PURRNS,,
        AR   R9,R8
        AIS  R8,2
        NHI  R8,0F
        STB  R8,PURRNS,,
        CHI  R6,1                          
        JNFS .+6
        OHI  R9,10                    :set poll bit
        STB  R9,IOUT0+3,R10,          :insert CONTROL field
        AHI  R10,IFSIZE*2
        AHI  R4,10
        SIS  R6,1
        JGE  SNDSP2
        LIS  R8,0
        JAL  R13,SIOGRP
        LIS  R13,0
        RBT  R13,WAITBT,,
        LHI  R5,3
        STB  R5,PUSTAT                :DO NOTHING UNTIL ALL FRAMES SENT
        J    FGNRST
        EI (SPCSEQ)

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  COME HERE TO SEND XID

SND1XD   LIS   R5,0F                  :GO IDLE AFTER SENDING XID
         JFS   SNDXI0
SNDXID   LIS   R5,0E                  :TELL BACKGROUND TO CHECK XID TIMER
SNDXI0   STB   R5,PUSTAT
SNDXI1   JAL   R10,SIOCHK
         FGLOG(SNDXI1)
         L     R5,FASTC,,
         ST    R5,PUTIM,,
         LIS   R5,2
         STH   R5,OUTBUF,,
         LB    R5,XID
         STB   R5,OUTBUF+3,,
         LHI   R5,0FF
         STB   R5,OUTBUF+2,,
         J     GOOUT




:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: THIS ROUTINE SENDS A DISC AND WAITS FOR A UA.

SNDISC   JAL  R10,SIOCHK
         FGLOG(SNDISC)
         SLLS R2,2
         L    R5,FASTC,,
         ST   R5,PUTIM,R2
         SRLS R2,2
         LIS  R5,2                    :LENGTH OF DISC
         STH  R5,OUTBUF,,
         LB   R8,DISC                 :CONTROL FIELD FOR DISC (WITH POLL BIT)
         LB   R7,PUTAB,R2             :PU ADDRESS
         STB  R7,OUTBUF,R5,
         STB  R8,OUTBUF+1,R5,
         LIS  R8,7                    :SET PUACT STATE TO DISC
         STB  R8,PUACT,R2
         LHI  R8,11                   :CHANGE STATE TO DISC SENT
         STB  R8,PUSTAT,R2
         LIS  R8,0
         SBT  R8,DONTHG               :SET WAIT FLAG
         J    GOOUT

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: THIS ROUTINE CHECKS TO SEE IF ANY PU IS IN THE "WAITING FOR UA" STATE
::: IF YES, NOTHING ELSE IS DONE ON THE LINE UNTIL THE TIMER EXPIRES

SNDSCK   LIS  R12,0
         LB   R5,PUSTAT,R12
         CHI  R5,0B                   :WAITING FOR UA-TO-SNRM?
         JE   SNDSC4                  :YES
         CHI  R5,11                   :WAITING FOR UA-TO-DISC?
         JE   SNDSC4                  :YES
         AIS  R12,1
         CHI  R12,NUMPU
         JL   SNDSCK+2
         LIS  R12,0
         J    4,R4                    :SKIP RETURN=NO ONE IS WAITING

SNDSC4   L    R6,FASTC,,
         SLLS R12,2
         L    R7,PUTIM,R12
         SR   R6,R7
         CHI  R6,SNMRTM               :SNRM TIMEOUT REACHED?
         JL   SNDSC6                  :NO
         L    R6,FASTC,,
         ST   R6,PUTIM,R12
         SRLS R12,2
         LHI  R5,13                   :ASSUME DISC
         LB   R9,PUSTAT,R12
         CHI  R9,11                   :11=DISC, IF NOT 11 THEN SNRM
         JEFS SNDSC5
         LIS  R5,1
SNDSC5   STB  R5,PUSTAT,R12
         LIS  R12,0
         RBT  R12,DONTHG
         J    4,R4

SNDSC6   LIS  R12,0
         JR   R4

:==========================================================================
: THIS ROUTINE RUNS THROUGH EACH LU'S STATE IN LUSTAT AND TAKES THE APPROPRIATE
: ACTION WHERE NECESSARY.
:  01 - ACTIVATE LU
:  03 - SEND VTAM BANNER (NOTIFY=0)
:  04 - READY FOR LOGON STATE
:  07 - SEND VTAM BANNER
:  0D - NEGATIVE RSP RECEIVED FOR DFC REQ
:  0F - RECEIVED NOTIFY REQ.                                                
:  10 - TIME TO SEND +RSP TO THE NOTIFY REQ (B.G.)
:  11 - +RSP TO NOTIFY WAS SENT (F.G.)                                    
:  13 - TIME TO SEND BIND REQ (B.G.)
:  14 - BIND REQ WAS SENT (F.G.)  WHEN BACKGROUND RECEIVES A +RSP TO THE 
:       BIND REQ, IT WILL CHANGE TO 16 WHICH TELLS THE F.G. TO SEND A SDT.
:  15 - UNUSED
:  16 - +RSP TO BIND REQ WAS RECEIVED, BACKGROUND NOW WANTS TO SEND SDT.
:  17 - SDT REQ HAS BEEN SENT (F.G.)
:  24 - send 1st part of screen 4
:  25 - 1st part of screen 4 sent
:  26 - send 2nd part of screen 4
:  27 - 2nd part of screen 4 sent
:  28 - send 3rd part of screen 4
:  29 - 3rd part of screen 4 sent
:  2E - B.G. WANTS RICHARD/JEFF SCREEN 1 SENT
:  2F - F.G. SENT R/J SCREEN
:  30 - BACKGROUND REQUEST BRACKET BID BE SENT
:  31 - F.G. SENT BRACKET BID
:  33 - NEG RSP RECEIVED FOR SESSON CONTROL REQ
:  34 - F.G. SENDS UNBIND
:  35 - AN UNBIND HAS BEEN SENT AND ACKD
:  37 - CKLUTM IS RUNNING THE UNBIND CLEANUP TIMER
:  41 - F.G. SENT LAST PART OF LU1 PRINT W/PACING
:  46 - B.G. REQUESTED GENERIC SEND    
:  47 - F.G. COMPLETED GENERIC SEND
:  51 - B.G. REQUESTED A PRINT RECORD BE SENT
:  52 - F.G. SENT A PRINT RECORD
:  62 - B.G. REQUESTED "END OF PRINT" MSG BE SNET
:  63 - F.G. SENT END OF PRINT MSG
:  64 - CKLUTM WILL START PRINT



LUSTLP   ST  R0,LUSRET
         LHI R1,NUMPU-1
LUSTL2   RBT R1,RRARAY,,              :CAN WE SEND?
         JE  LUSTL4
         TBT R1,RNRARY,,              :HIF TELLING US TO SHUT UP?
         JN  SNDRR                    :YES
         TBT R1,GOTRR,,               :RR RECEIVED SINCE LAST DATA SENT?
         JN  SNDRR                    :NO, GO SEND RR TO GET ACCURATE PURRNS
         LHL R7,TRAILX,R1,R1          :SEE IF B.G. QUEUED ANYTHING
         LHL R6,LEADIX,R1,R1
         CR  R7,R6
         JE  SNDRR                    :NOPE
         JAL R6,CHKWND                :SEE IF LAST BATCH ACCEPTED
         J   REXMIT                   :NON-SKIP RETURN=NO
         LIS R6,0
         STH  R6,TOOFST,R1,R1         :RESET TOO-FAST COUNTER
         LR  R7,R4                    :UPDATE TRAILX TO FGIX+1
         AI  R7,IFSIZE*2
         CI  R7,FOLDYT                :END OF BUFFER?
         JLFS .+4
         LIS R7,0
         STH R7,TRAILX,R1,R1
         LHL R8,LEADIX,R1,R1          :STILL ANYTHING TO SEND?
         CR  R7,R8
         JE  SNDRR                    :NO
         LB  R8,SIOHL0+6,R5,R7        :GET DAF
         JE  NODAF                    :ERROR! NO DESTINATION
         STH R8,FGCURL                :SAVE
         JAL R6,MCHLUS                :FIND STARTING POINT IN LUSTAT FOR PU
         SIS R8,2                     :CONVERT DAF TO RELATIVE LU
         AR  R8,R9                    :R9 IS STARTING POINT IN LUSTAT
         LB  R9,LUSTAT,R8,            :GET STATE FOR THIS LU
         LB  R9,LUSTBL,R9, 
         LHL R9,LUSXXX,R9,R9          :GET ROUTINE TO EXECUTE
         J   FSEG,R9,
LUSTL4   SIS R1,1
         JGE LUSTL2
         L   R0,LUSRET
         JR  R0

NODAF    HC  0                        :DAF IN SIOHL0 IS 0


LUSXXX   HC  SNDGEN-FSEG              :NO STATE OR UNDEFINED STATE
         HC  SNDBID-FSEG              :ACTIVATE LU
         HC  SNDVTM-FSEG
         HC  SNDLUR-FSEG
         HC  SNDVTM-FSEG
         HC  SNDFRP-FSEG
         HC  SNDNTF-FSEG
         HC  SNDBND-FSEG
         HC  SNDSDT-FSEG
         HC  SNDBID-FSEG
         HC  SNDNTV-FSEG              :0A - SEND VTAM BANNER TO NOTIFY




:--------------------------------------------------------------------------
: THIS ROUTINE SETS A BIT FLAG FOR LUSTLP IF THIS PU NEEDS TO SEND A RR

SETUPR   SBT  R2,RRARAY,,
         J    FGNRST                  :GO CHECK NEXT PU

:==========================================================================
: THIS SENDS OUT A FRAME FOLLOWED BY A RECEIVE READY

SNDFRM   ST  R12,HOLD8F
         JAL R10,SIOCHK 
         FGLOG(SNDFRM)
         LIS R11,0                   :WHICH IOUT# TO USE
         LIS R12,0                   :LOCAL INDEX TO IOUT#
         LIS R15,0                   :NUMBER OF FRAMES SENT
SNDF10   LHL R10,SIOHL0,R5,R7        :GET LENGTH OF FRAME
         LR  R14,R7                  :SAVE LOCAL INDEX TO SIOHL#
         STH R10,IOUT0,R11,R12       :SAVE LENGTH OF FRAME
         AIS R10,2                   :ACCOUNT FOR TWO BYTES AT BEGINNING
         AIS R7,2                    :MOVE PAST LENGTH IN SIOHL#
         AIS R12,2                   :MOVE PAST LENGTH IN IOUT#
SNDF20   LB  R13,SIOHL0,R5,R7
         STB R13,IOUT0,R11,R12
         AIS R7,1
         AIS R12,1
         CR  R12,R10                  :SEE IF ENTIRE FRAME MOVED TO IOUT0
         JL  SNDF20
         LB  R13,PURRNR,R1,           :BUILD CONTROL FIELD
         LB  R10,PURRNS,R1,
         AR  R13,R10
         STB R13,IOUT0+3,R11,         :INSERT CONTROL FIELD
         STB R13,SIOHL0+3,R5,R14      :NEED HERE FOR REXMT
         AIS R10,2                    :INCREMENT N(S)
         NHI R10,0F 
         STB R10,PURRNS,R1,
         AIS R15,1                    :INCREMENT NUMBER OF FRAMES SENT
         JAL R6,ANYLFT                :SEE IF ANY MORE TO SEND
         J   SNDF10                   :NON-SKIP RETURN=MORE TO SEND
         STH R14,FGIX,R1,R1           :SAVE POINTER TO LAST FRAME FG SENT
         IF S7200
         LHI R6,$A170                 :TIMEOUT FOR 1 FRAME /7200 BPS
         ELSE
         LHI R6,$A23                  :TIMEOUT FOR 1 FRAME AT 56000 BPS
         EI
         MHR R6,R15                   :MULTIPLY BY NUMBER OF FRAMES TO SEND
         L   R11,FASTC,,
         AR  R11,R6                   :VALUE OF TRANSMISSION TIMEOUT
         AH  R11,T1TIME               :ALLOW TIME TO RECEIVE 1 MAX FRAME
         LR  R6,R1
         SLLS R6,1
  :      ST  R11,PUTIM,R6,R6
         ST  R11,LINTIM               :TRY ONE TIMER FOR ENTIRE LINE
         LA  R11,SIOCHN+10,,         
         SRLS R11,4
         LIS R13,0                    :INDEX TO SIOCHN
         LIS R12,2                    :SIO "CHAIN" COMMAND
         LIS R14,1                    :SIO "SEND" COMMAND
SNDF40   STH R14,SIOCHN,R13,          :"SEND" COMMAND
         STH R12,SIOCHN+4,R13,        :"CHAIN" COMMAND
         SIS R15,1                    :ANY MORE FRAMES SENT?
         JE  SNDF50                   :NO
         STH R11,SIOCHN+6,R13,        :ADDRESS TO CHAIN TO
         AHI R13,10
         LA  R11,SIOCHN+10,R13,       :NEXT ADDRESS TO CHAIN TO
         SRLS R11,4
         J   SNDF40
SNDF50   LA  R11,SIOOUT,,
         SRLS R11,4
         STH R11,SIOCHN+6,R13,        :CHAIN TO SEND RR
         STH R14,SIOOUT,,
         STH R12,OUTBUF,,             :LENGTH OF RR
         LB  R10,PUTAB,R1,            :PU ADDRESS
         STB R10,OUTBUF+2,,
         LB  R10,PURRNR,R1,
         AHI R10,11                   :BUILD RR CONTROL FIELD
         STB R10,OUTBUF+3,,
         LIS R10,0
         STH R10,SIOOUT+4,,           :DON'T CHAIN AFTER THIS
         LA  R10,OUTBUF,,
         SRLS R10,4
         STH R10,SIOOUT+2,,
         JAL R13,SIOGRP               :SEND THE FRAMES
         RBT R1,DATSNT,,              :TELL B.G. DATA WAS SENT
         SBT R1,GOTRR,,               :DON'T SESEND MORE DATA UNTIL RR RECEIVED
         L   R12,HOLD8F               :GET RETURN ADDRESS
         LIS R13,3                    :SET PUSTAT TO "RR SENT"
         STB R13,PUSTAT,R1,
         STH R1,LASTRR                :SAVE REL# OF LAST PU TO SEND RR
         JR  R12
 


:-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
: UTILITY ROUTINE FOR SNDFRM.  THIS ROUTINE CHECKS TO
: SEE IF THE HIF ACK'd ALL THE LAST BATCH OF FRAMES
: SENT.
CHKWND   LHL  R4,FGIX,R1,R1           :GET F.G. POINTER TO BUFFER
         LR   R5,R1                                               
         SLLS R5,1
         L    R5,SIOBBF,R5,R5         :BEGINNING OF BUFFER FOR THIS PU
         LB   R3,SIOHL0+3,R5,R4       :GET CONTROL FIELD OF LAST FRAME SENT
         AIS  R3,2
         NHI  R3,0F
         LB   R0,PURRNS,R1,           :WHAT THE HIF EXPECTS NEXT
         CR   R0,R3                   :MATCH?
         JE   4,R6                    :YES, NOTHING TO REXMIT
CHKWN4   LB   R3,SIOHL0+3,R5,R7       :FIND LAST THING HIF DID LIKE
         NHI  R3,0F
         CR   R3,R0                   :RR FOR PREVIOUS FRAME?
         JE   SLOWDN                  :YES, RUNNING TOO FAST
         AIS  R3,2
         NHI  R3,0F
         CR   R0,R3
         JE   CHKWN6                  :HIF ACK'd THIS FRAME
         AI   R7,IFSIZE*2             :TRY NEXT FRAME
         CI   R7,FOLDYT
         JLFS .+4
         LIS  R7,0
         CR   R7,R4                   :IF TRAILX=FGIX AND NO MATCH, THAT'S BAD
         JN   CHKWN4
         HC   0
CHKWN6   STH  R7,TRAILX,R1,R1         :NEW TRAILX
         AI   R7,IFSIZE*2             :SINCE TRAILX DOESN'T POINT TO NEW DATA
         CI   R7,FOLDYT               :MOVE R7 TO UNACK'D DATA
         JLR  R6
         LIS  R7,0
         JR   R6
SLOWDN   LIS  R3,1
         AHM  R3,TOOFST,R1,R1
         LHL  R3,TOOFST,R1,R1
         CHI  R3,4
         JL   SNDRR
         LIS  R3,0
         STH  R3,TOOFST,R1,R1
         JR   R6                      :DUE TO INTERNAL TIMING SCREW UP REXMT
                                      :TRAILX FRAME

:::::::----::::--::--::--::--::--::--::--::--::--::--::
:: ANOTHER UTILITY ROUTINE, FOR LUSTLP.  THIS ROUTINE
:: FINDS THE STARTING POINT IN LUSTAT FOR THE PU IN R1
MCHLUS   LIS  R9,0
         LIS  R3,0
         CR   R1,R3
         JER  R6                      :MATCH, OFFSET IN R9
         LB   R0,LUPRPU,R3,
         AR   R9,R0
         AIS  R3,1
         J    MCHLUS+4

:.-_.-_.-_.-_.-_.-_.-_.-_.-_.-_.-_.-_.-_.-_.-_
:ANOTHER UTILITY ROUTINE, FOR SNDFRM.  THIS
:ROUTINE CHECKS TO SEE IF ALL FRAMES FOR AN LU
:HAVE BEEN SENT.
ANYLFT   LR   R7,R14                  :RESTORE BEGINNING OF LOCAL INDEX
         AI   R7,IFSIZE*2
         CI   R7,FOLDYT
         JLFS .+4
         LIS  R7,0
         LHL  R10,LEADIX,R1,R1        :EMPTY?
         CR   R7,R10
         JE   4,R6                    :YES
         LB   R10,SIOHL0+6,R5,R7      :GET DAF OF THIS NEXT GUY
         CH   R10,FGCURL              :SAME AS ONE WE'VE BEEN PROCESSING?
         JN   4,R6                    :NO, STOP FOR NOW
         LIS  R12,0                   :RESET LOCAL IOUT# INDEX
         AHI  R11,IFSIZE*2            :MOVE TO NEXT IOUT#
         JR   R6

:========================================================================
:  COME HERE TO REXMIT FRAMES NOT ACK'd BY THE HIF
REXMIT   JAL  R12,SNDFRM
         LIS  R12,1
         AHM  R12,REXMCT,R1,R1       :COUNT RETRANSMISSIONS
         L    R0,LUSRET
         JR   R0



:=========================================================================
: THIS ROUTINE SENDS OUT A +RSP TO FMD LAYER

SNDFRP   JAL  R12,SNDFRM
         L    R5,FASTC,,
         SLLS R8,2
         ST   R5,LUTIME,R8,
         SRLS R8,2
         LB   R5,LUSTAT,R8,
         AHI  R5,81
         STB  R5,LUSTAT,R8,
         L    R0,LUSRET
         JR   R0

:==========================================================================
: THIS ROUTINE SENDS A CHANGE DIRECTION REQ

SNDCDI   JAL  R12,SNDFRM
         LB   R5,LUSTAT,R8,
         AHI  R5,81                   :SHOW NEW STATE PENDING
         STB  R5,LUSTAT,R8,
         L    R0,LUSRET
         JR   R0

:==========================================================================
: THIS ROUTINE SENDS OUT THE RESPONSE TO LUSTAT

SNDLUR   JAL  R12,SNDFRM
         LB   R5,LUSTAT,R8,
         AHI  R5,81                   :CHANGE STATE TO"RESEND VTAM" TIMER
         STB  R5,LUSTAT,R8,           :IS RUNNING
         SLLS R8,2
         L    R5,FASTC,,
         ST   R5,LUTIME,R8,
         SRLS R8,2
         L    R0,LUSRET
         TBT  R8,LU1ARY               :IF LU TYP1, DON'T SEND VTAM BANNER
         JNR  R0
         LHI  R5,91                   :GO STRAIGHT TO BIND
         STB  R5,LUSTAT,R8,
         JR   R0     



:===========================================================================
: THIS ROUTINE SENDS THE RSP TO NOTIFY

SNDNTF   JAL  R12,SNDFRM
         IF VBANER
         LHI  R5,0A1
         ELSE
         LHI  R5,91
         EI
         STB  R5,LUSTAT,R8,           :CHANGE LU STATE TO "BIND TIMER RUNNING"
         L    R0,LUSRET
         JR   R0

:===========================================================================
: THIS ROUTINE SENDS THE BIND

SNDBND   JAL  R12,SNDFRM
         LB   R5,LUSTAT,R8,
         AHI  R5,81
         STB  R5,LUSTAT,R8,           :CHANGE LU STATE TO "BIND SENT" (14)
         L    R0,LUSRET
         JR   R0


:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::   THIS IS A GENERIC SEND ROUTINE CALLED WHEN AN ERROR HAS OCCURRED ::
:::   SO ALL THE OTHER FRAMES AREN'T STUCK BEHIND THIS ONE            :::
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
SNDGEN   LIS  R12,0E
         FGLOG(SNDGEN)
         STB  R12,LUSTAT,R8,

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::  THIS ROUTINE SENDS OUT A BRACKET BID

SNDBID   JAL  R12,SNDFRM
         LB   R9,LUSTAT,R8,
         AHI  R9,81                 :SHOW NEW STATE IS PENDING COMPLETION
         STB  R9,LUSTAT,R8,
         L    R0,LUSRET,,
         L    R5,FASTC,,
         SLLS R8,1
         ST   R5,LUTIME,R8,R8
         SRLS R8,1
         JR   R0 

:========================================================================
: THIS ROUTINE SENDS OUT A SDT REQ

SNDSDT   JAL  R12,SNDFRM  
         LB   R5,LUSTAT,R8,
         AHI  R5,81                   :SHOW PENDING NEW STATE  
         STB  R5,LUSTAT,R1,
         L    R0,LUSRET
         JR   R0


:=====================================================================
: SEND VTAM BANNER WHEN SLU ENABLED NOTIFY RECEIVED
SNDNTV   LHI  R7,7                    :CHANGE STATE TO USER LOGGING ON
         STB  R7,LUSTAT,R8,
         J    SNDVTM
         
:============================================================================
: TIME TO SEND THE VTAM BANNER TO THIS GUY.

SNDVTM   JAL R12,SNDFRM
         LB  R5,LUSTAT,R8,
         AHI R5,81                    :SHOW NEW STATE PENDING
         STB R5,LUSTAT,R8,
         L   R0,LUSRET
         JR  R0






:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE GETS THE CURRENT N(R) FOR THE PU IN QUESTION AND SENDS  :::
:::  A RECEIVE READY                                                      :::

SNDRR    JAL R10,SIOCHK
         FGLOG(SNDRR )
         L   R5,FASTC,,
         LHL R3,T1TIME,,              :ALLOW TIME TO RECEIVE 1 MAX FRAME
         AR  R5,R3
         LR  R3,R1
         SLLS R3,2
         ST  R5,PUTIM,R3              :SAVE CURRENT FASTC TIME
         ST  R5,LINTIM                :SAVE TIME FOR ENTIRE LINE
         STH R1,LASTRR                :SAVE REL # OF LAST PU TO SEND RR
         RBT R1,PUDACR                :NEED TO DE-ACTIVATE A PU?
         JN  DACPU
         RBT R1,PUACTR                :NEED TO ACTIVE A PU?
         JN  ACTVPU
         RBT R1,NMVTAR                :NEED TO SEND SSCP-PU NMVT?
         JN  NMVTPU
         RBT R1,OUTWSW                :SEND A CRUMMY FRAME?
         JN  SNDOTW                   :YES (CONT-D,8)
         LB  R3,PURRNR,R1             :GET CORRECT N(R) FOR RR
         AHI R3,11                    :CREATE RR FORMAT
SNDRR9   STB R3,OUTBUF+3,,
         LIS R5,2
         STH R5,OUTBUF,,              :NUMBER OF BYTE IN RR
         LB  R3,PUTAB,R1              :GET PU ADDRESS
         STB R3,OUTBUF,R5,
SNDRRX   LIS R5,1
         STH R5,SIOOUT,,
         LIS R5,0                     :TURN OFF CHAIN COMMAND
         STH R5,SIOOUT+4,,
         LIS R5,3                     :CHANGE STATE TO RR SENT
         STB R5,PUSTAT,R1,
         JAL R13,SIOSND
         L    R0,LUSRET
         JR   R0

:--- COME HERE TO SEND A BAD FRAME ---:
SNDOTW   RBT  R1,BDRRSW               :SEND BAD RR?
         JN   SNDBRR
         RBT  R1,BDNSSW               :SEND FRAME WITH BAD N(S)?
         JN   SNDBNS
         RBT  R1,BDNRSW
         JN   SNDCNR                  :(sndbnr is already in use)
         RBT  R1,BDSRSW
         JN   SNDBSR
         RBT  R1,BDFMSW               :SEND ILLEGAL FRAME?
         JNFS SNDBFR
OWDEAD   HC   0
SNDBFR   LHI  R13,37                  :ILLEGAL FRAME
SNDBAD   LB   R3,PUTAB,R1
         STB  R3,OUTBUF+2,,
         STB  R13,OUTBUF+3,,
         LIS  R5,0
SNDBD1   LB   R6,CRUMFM,R5
         STB  R6,OUTBUF+4,R5,
         AIS  R5,1
         CHI  R5,40
         JLBS SNDBD1
         STH  R5,OUTBUF,,
         J    SNDRRX

SNDBNS   LB   R13,PURRNR,R1           :GET CORRECT N(R)
         LB   R6,PURRNS,R1
         AIS  R6,2
         NHI  R6,0E                   :CORRUPT THE N(S)
         AR   R13,R6
         OHI  R13,10                  :TURN ON POLL BIT
         J    SNDBAD

SNDCNR   LB   R13,PURRNR,R1
         AHI  R13,20                  :CORRUPT THE N(R)
         NHI  R13,0E0
         LB   R6,PURRNS,R1
         AR   R13,R6
         OHI  R13,10                  :POLL BIT
         J    SNDBAD

SNDBSR   LB   R13,PURRNR,R1
         AHI  R13,20
         NHI  R13,0E0
         LB   R6,PURRNS,R1
         AHI  R6,2
         NHI  R6,0E
         AR   R13,R6
         OHI  R13,10
         J    SNDBAD

SNDBRR   LB   R3,PURRNR,R1
         AHI  R3,20                   :CREATE CRUMMY RR
         NHI  R3,0E0
         OHI  R3,11
         J    SNDRR9

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  COME HERE FROM FNDINW TO SEND AN EXPEDITED FRAME

SNDEXP   JAL  R10,SIOCHK 
         FGLOG(SNDEXP)
         LB   R6,PUADLU,R9,           :GET PU ADDRESS FOR THIS LU
         STB  R6,IOUT0+2,,
         LB   R6,PURRNR,R1
         LB   R5,PURRNS,R1
         AR   R6,R5
         STB  R6,IOUT0+3,,
         LHI  R6,2D00                 :EXPEDITED, FID2
         STH  R6,IOUT0+4,,
         LB   R6,DAF,R9,
         STB  R6,IOUT0+6,,
         LHI  R6,14
         STB  R6,IOUT0+7,,
         LH   R6,LUSNF,R9,R9
         STH  R6,IOUT0+8,,
         LA   R5,MANDAT+0A            :BEGINNING OF MANDAT RH
         LB   R4,RUTABL+0D            :LENGTH OF MANDAT
         SIS  R4,0A
         LIS  R3,0
         LIS  R13,0A
SNDEX5   LB   R6,0,R5,R3
         STB  R6,IOUT0,R13,
         AIS  R13,1
         AIS  R3,1
         SIS  R4,1
         JG   SNDEX5
         LB   R4,RUTABL+0D
         SIS  R4,2
         STH  R4,IOUT0,,
         LA   R4,IOUT0,,
         SRLS R4,4
         STH  R4,SIOCHN+2,,
         LIS  R8,0
         STH  R8,SIOCHN+4,,
         LIS  R5,1
         STH  R5,SIOCHN,,
         JAL  R13,SIOGRP
         J    FGNRS2


:=======================================================================
: THIS ROUTINE SENDS OUT A GROUP OF FRAMES FOR 1 PU

SIOGRP   LIS R10,LUN
         FGLOG(SIOGRP)
         LA  R11,SIOCHN,, 
         SVC IO,FRCMBO+R10
         HC  0,0
         JR  R13

:-----------------------------------------------------------------------

SIOSND   LIS R1,LUN          :SIO OUTPUT ROUTINE
         FGLOG(SIOSND)
         LR  R15,R2
         LA  R2,SIOOUT,,
         SVC IO,FRCMBO+R1
         HC  0,0
         LR  R2,R15
         JR  R13

:--------------------------------------------------------------------------
: THIS ROUTINE CALLS SIOSND WHICH SENDS THE SDLC FRAME.

GOOUT    LIS R5,1
         FGLOG(GOOUT )
         STH R5,SIOOUT,,
         LIS R5,0
         STH R5,SIOOUT+4,,            :DON'T CHAIN
         JAL R13,SIOSND
         J   FGNRST

:...---...---...---...---...---...---...---...---...---...---...---...:
:   THIS ROUTINE IS USED TO MANIPULATE DTR

SIODTR   JAL  R10,SIOCHK
         FGLOG(SIODTR)
         TBT  R1,DTRARY               :IF DROPPING DTR, DON'T ENABLE XMTR
:        JN   SIODT2
         LI   R5,385EB                :ENABLE TRANSMITTER
:        ST   R5,SIOOUT,,
         LA   R5,SIOOUT,,
         LIS  R4,0
:        SVC  IO,FRCMBO+R4
:        HC   0,0
:        SVC  DISMIS
:        JAL  R10,SIOCHK
SIODT2   ST   R15,DTRMIP,,
         LA   R5,DTRMIP,,
         LIS  R4,0
         SVC  IO,FRCMBO+R4
         HC   0,0
         JR   R13




:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: CHECK TO SEE THAT ALL PREVIOUS SIO COMMANDS HAVE BEEN EXECUTED  :::

SIOCHK   STM  R0,SIOALL
         FGLOG(SIOCHK)
         L    R5,FASTC,,
         AI   R5,$A6000                :5 SECOND TIMEOUT
         ST   R5,SCTIME                :SAVE CURRENT TIME
         LHI  R5,70
SIOCH2   LH   R4,SIOOUT,R5,
         CHI  R4,1
         JE   SIOSLP
         LH   R4,SIOCHN,R5,
         CHI  R4,1
         JE   SIOSLP
         SHI  R5,10
         JGE  SIOCH2
         LM   R0,SIOALL
         JR   R10
SIOSLP   SVC  DISMIS
         L    R4,SCTIME
         S    R4,FASTC,,
         JG   SIOCH2
         LIS  R4,0
         LHI  R5,70         
SIORS2   STH  R4,SIOCHN,R5,           :GIVE UP ON THIS COMMAND AND ERASE IT
         STH  R4,SIOOUT,R5,
         SHI  R5,10
         JGE  SIORS2
         STH  R4,HLDPTR               :RESET SIO RCV POINTER
         LA   R5,SIOIN,,
         SVC  IO,FRCMBI+R4            :RESET SIO RCV
         HC   0,0
         SVC  DISMIS
         LIS  R5,1
         AHM  R5,SIORCT               :INCREMENT SIO-RETRY COUNTER
         l    r5,fastc,,
         ST   R5,RSNTIM               :SAVE THIS, COMPARE TO REJTIM
         LM   R0,SIOALL
         JR   R10   


:========================================================================
:= THIS ROUTINE CHECKS THE SIO INPUT BUFFER.  IF NO DATA HAS COME IN,
:= IT HAS A NORMAL RETURN (J=R12).  IF THERE IS DATA IN THE BUFFER IT
:= RETURNS R12+4.  WHEN THE POINTER (HLDPTR) => IDXWRP THE POINTER IS 
:= RESET TO THE TOP OF THE BUFFER AND WHEN THE POINTER IS BETWEEN 100x
:= AND 200x IT WRITES A HALFWORD OF FFFF INTO THE FIRST HALFWORD OF THE
:= BUFFER.

CKSIN    LH  R4,HLDPTR
         CHI R4,IDXWRP                :SEE IF ROOM FOR 1 MORE FULL PACKET
         JLFS CKSIN2
         LIS R4,0
CKSIN2   LH  R7,INBUF,R4,
         JLR R12
         CHI R4,120
         JG  CKSIN3
         LH  R9,MARKER
         STH R9,INBUF,,
CKSIN3   CHI R7,0FFFF
         JE  CKSIN4                   :NORMAL RETURN = NO INPUT
         CHI R7,0
         JE  CKSIN4
         IF SIODBG
         L   R9,FASTC,,               :SAVE TIME OF LAST FRAME
         ST  R9,SIXTIM
         EI
         AIS R12,4
         JR  R12
CKSIN4   EQ  .
         IF SIODBG
         L   R7,SIXTIM                :GET TIME OF LAST RECEIVED FRAME
         JER R12                      :NO SIO RECEIVED YET
         L   R9,FASTC,,               :CURRENT TIME
         SR  R9,R7                    :GET ELAPSED TIME
         CHI R9,$A1200                :SHOULD NEVER EXCEED 2 SECONDS
         JLR R12
         HC  0
         ELSE
         JR  R12
         EI



:=========================================================================
:= THIS ROUTINE GETS THE CONTROL FIELD OUT OF THE SIO INPUT BUFFER AND
:= SENDS THE PROGRAM TO THE APPROPRIATE ROUTINE.  IF THE CONTROL BYTE
:= DOESN'T MATCH ANYTHING CURRENTLY IN THE PROGRAM, THIS ROUTINE THEN
:= FLUSHES THE INPUT BUFFER.

PULSIO   LIS R5,0
         FGLOG(PULSIO)
         RBT R5,XMTRCV                :SHOW SOMETHING WAS RECEIVED
         AIS R4,2                     :ADVANCE POINTER PAST BYTE COUNT
         STH R7,HLDCNT                :SAVE BYTE COUNT
         LB  R8,INBUF,R4,              :GET ADDRESS
         JAL R5,MCHPU                 :GO FIND MATCHING PU INDEX
         J   ADDERR                   :ADDRESS ERROR ON RECEIVED FRAME
         SIS R7,1                     :DECREMENT BYTE COUNT
PULSI1   AIS R4,1                     :INCREMENT INDEX
         LB  R8,INBUF,R4,              :GET CONTROL FIELD
         SIS R7,1
         STB R8,HLDBYT
         CHI R8,97                    :IS IT FRAME ERROR?
         JE  FRMERR                   :YES, MUST SEND DISC
         CHI R8,73                    :IS IT A UA WITH POLL BIT SET?
         JE  FNDUA
         CHI R8,1F                    :IS IT A DISCONNECT?
         JE  FNDDM 
         CHI R8,53                    :IS IT REQUEST-DISCONNECT?
         JE  FNDRD
         NHI R8,0F
         CHI R8,1                     :IS IT A RECEIVE READY?
         JE  FNDRR
         CHI R8,5                     :RNR?
         JE  FNDRNR
         CHI R8,9                     :FRAME REJECT?
         JE  FRMREJ
         LB  R8,HLDBYT                :RESTORE ANDED OFF BITS
         NHI R8,1
         CHI R8,0
         JE  FNDINF                   :FOUND INFORMATION FRAME
PULSI2   AIS R4,1
         AR  R4,R7
         NHI R7,1
         AR  R4,R7
         STH R4,HLDPTR                :SAVE INDEX
         LIS R4,1
         AHM R4,UNKNCT,R1,R1          :COUNT THIS ERROR
         J   FGNRS2
ADDERR   AR  R4,R7                    :FLUSH REST OF THIS FRAME
         FGLOG(ADDERR)
         NHI R7,1
         AR  R4,R7
         STH R4,HLDPTR
         LIS R7,1
         AHM R7,ADERCT                :RECORD ERROR
         J   FGNRS2



:------------------------------------------------------------------------
:- THIS ROUTINE CHECKS THE N(R) & N(S) COUNTERS OF THE INFORMATION
:- FRAMES RECEIVED FROM THE SNA HOST INTERFACE.  IT ALSO UPDATES THE 
:- N(R) COUNTER FOR THE SPECIFIC PU.

FNDINF   LB  R8,HLDBYT                :RESTORE CONTROL FIELD
         FGLOG(FNDINF)
         LB  R14,PUSTAT,R1,           :SEE IF DOING RESPONSE TIME TESTING
         CHI R14,15
         JE  FNDI00                   :YES
         STB R8,PREVRR,R1
         JAL R14,CKFINL               :GO CHECK FINAL BIT
         LIS R14,0
         STB R14,RRTMOC,R1,           :INDICATE THIS PU IS STILL ALIVE
         AIS R4,1
         NHI R8,0E0                   :GET N(R) BITS
         SRLS R8,4                    :TURNS THEIRS INTO N(S)
         STB R8,PURRNS,R1,            :THIS IS WHAT THEY EXPECT NEXT
         RBT R1,GOTRR                 :INDICATE CAN SEND NEXT DATA FRAME
         LB  R8,HLDBYT                :RESTORE CONTROL FIELD AGAIN
         AIS R8,2                     :THIS IS THE NEXT FRAME WE EXPECT
         NHI R8,0E                    :GET TH                      
         SLLS R8,4                    :TURN THEIRS INTO N(R) FOR US
         STB R8,PURRNR,R1
         LB  R8,INBUF+3,R4,           :GET THE OAF
         JNFS FNDIN6                  :PROCESSING LU
         JAL R5,CALBFP                :DETERMINE INDEX INTO BUFPU
FNDIN6   JAL R5,CALLIX                :GO FIND INDEX TO BUFLU, PUT IN R3
         LH  R11,HLDCNT               :GET BYTE COUNT
         SIS R11,2                    :SUBTRACT ADDRESS & CONTROL
         STH R11,0,R13,R3             :SAVE LENGTH (R13 HAS BUFLU OR BUFPU)
         AIS R3,2
         LHI R5,LUBSIZ-2
FNDIN7   LB  R11,INBUF,R4,            :GET EACH BYTE FROM SIO BUFFER
         STB R11,0,R13,R3             :SAVE IN BUFFER FOR BACKGROUND
         AIS R3,1
         AIS R4,1                     :INCREMENT SIO POINTER
         SIS R5,1                     :SEE IF BUFFER IS FULL
         JLEFS FNDIN8
         SIS R7,1                     :DECREMENT BYTE COUNT
         JG  FNDIN7
         J   FNDIN9
FNDIN8   SIS R7,1
         AR  R4,R7
FNDIN9   LH  R7,HLDCNT
         NHI R7,0001                  :SEE IF ODD NUMBER
         AR  R4,R7                    :ACCOUNT FOR POSSIBLE TRASH BYTE
         STH R4,HLDPTR
FNDINX   LH  R5,PIXLIX,,              :SEE IF THIS IS FROM LU OR PU (PU=0)
         JE  FNDINY
         LH  R9,HLDLIX                :GET BUFLIX INDEX
         LB  R11,BUFLPW,R9,           :GET NUMBER OF BKGND UNPROCESSED PKTS
         AIS R11,1
         CHI R11,WINDSZ               :SEE IF MORE THAN YOU CAN HOLD
         JLE FNDLOK
         HC  0,0                      :BACKGROUND TOO SLOW, GONNA LOSE DATA
FNDLOK   STB R11,BUFLPW,R9,
         LB  R11,BUFLIX,R9,
         AIS R11,1
         CHI R11,WINDSZ               :SEE IF ALL ENTRIES ARE FULL
         JL  FNDINW
         LIS R11,0
FNDINW   STB R11,BUFLIX,R9,           :UPDATE ENTRY COUNT
         LIS R11,1
         AM  R11,LUSTUF               :TELL B.G. THAT SOMETHING CAME IN
         RBT R9,INTRPT                :EXPEDITED FRAME WAITING TO GO?
         JN  SNDEXP                   :YES
         J   FGNRS2
FNDINY   LB  R11,BUFPIX,R1,
         AIS R11,1
         CHI R11,WINDSZ               :SEE IF ALL ENTRIES FULL
         JL  FNDINZ
         LIS R11,0
FNDINZ   STB R11,BUFPIX,R1,
         LB  R11,BUFPPW,R1,
         AIS R11,1
         CHI R11,WINDSZ               :SEE IF MORE PACKETS THAN YOU CAN HOLD
         JLE FNDPOK
         HC  0,0                      :GONNA LOSE DATA
FNDPOK   STB R11,BUFPPW,R1,
         LIS R11,1
         AM  R11,PUSTUF               :TELL B.G. THAT STUFF IS HERE
         J   FGNRS2

:--- come here when data frame rcv'd during response time testing ---:
FNDI00   AIS R4,1                     :MOVE PAST CONTROL FIELD
         FGLOG(FNDI00)
         AR  R4,R7                    :DISCARD DATA
         NHI R7,1
         AR  R4,R7
         STH R4,HLDPTR
         RBT R1,GOTRR,,
         LIS R4,0
         STB R4,RRTMOC,R1,
         LB  R4,HLDBYT                :GET CONTROL FIELD
         NHI R4,0E0
         SRLS R4,4                    :CONVERT N(R) TO OUR N(S)
         STB R4,PURRNS,R1,
         STB R4,HIFRR,R1,             :SHOW WHAT HIF EXPECTS
         LB  R4,HLDBYT
         AIS R4,2
         NHI R4,0E
         SLLS R4,4                    :CONVERT HIF N(S) TO OUR N(R)
         STB R4,PURRNR,R1,
         lis r4,1
         ahm r4,rreefc,,              :count it too
         IF RREEF
         SBT R1,RREEFI,,              :SHOW INFO RECEIVED
         SBT R1,RREEFS,,              :INDICATE TO SKIP N(S)
         EI
         LB  R4,HLDBYT
         NHI R4,10                    :FINAL BIT ON?
         JE  FGNRS2                   :NO
         SBT R1,RRARAY,,              :YES, RESPOND NOW
         J   FGNRS2

:-------------------------------------------------------------------------
: THIS ROUTINE IS CALLED TO FIND THE CORRESPONDING INDEX TO PUSTAT.
: IT USES THE PU ADDRESS JUST RECEIVED FROM THE SNA HIF.

MCHPU    LIS   R1,NUMPU-1                                
         CLB   R8,PUTAB,R1,
         JE    4,R5
         SIS   R1,1
         JGEBS MCHPU+2
         JR  R5

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::  THIS ROUTINE USES R1 - RELATIVE PU NUMBER
:::  R1 IS USED TO FIND THE STARTING POINT IN THE ARRAY "LUSTAT".
:::  THE POINTER IS RETURNED IN R6

GTLUBG   LIS  R10,0
         LIS  R6,0
GTLUB4   LB   R7,LUPRPU,R10,
         CR   R1,R10                  :SEE IF FOUND LU IN QUESTION
         JER  R5
         AR   R6,R7
         AIS  R10,1
         CHI  R10,NUMPU
         JL   GTLUB4
         HC   0



:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: THIS ROUTINE CHECKS THE FINAL BIT OF INFO FRAMES TO SEE IF MORE ARE
::: COMING

CKFINL   LR   R6,R8                   :COPY CONTROL BYTE
         NHI  R6,10                   :FINAL BIT ON?
         JN   CKFIN3
         L    R6,FASTC,,
         ST   R6,LSTFTM               :SAVE TIME FOR DEBUGGING
         AI   R6,FINALT               :ADD WAIT TIME
         LR   R5,R1
         SLLS R5,2
         ST   R6,PUTIM,R5
         ST   R6,LINTIM               :SAVE FOR ENTIRE LINE
         LIS  R6,0A
         STB  R6,PUSTAT,R1            :WAIT FOR FRAME WITH FINAL BIT SET
         JR   R14
CKFIN3   LR   R5,R1
         SLLS R5,2
         L    R6,FASTC,,
         ST   R6,PUTIM,R5             :TURN OFF TIMER SO RR WILL BE SENT
         ST   R6,LINTIM               :TURN OFF FOR ENTIRE LINE
         LIS  R6,4
         STB  R6,PUSTAT,R1            :CHANGE STATE TO SEND RR
         JR   R14

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::::  THIS ROUTINE USES THE REL LU# IN R1 TO DETERMINE THE REL PU# FOR :::
::::  THAT LU.  THE PU NUMBER IS RETURNED IN R2                        :::

FFDLPU   LB   R6,PUADLU,R1,           :GET PU ADDRESS
         LIS  R2,0
FFDLP2   LB   R8,PUTAB,R2
         CR   R8,R6
         JER  R7
         AIS  R2,1
         CHI  R2,NUMPU
         JL   FFDLP2
         HC   0


:----------------------------------------------------------------------------

CALBFP  STH R8,PIXLIX                 :FRAME IS FOR PU
        LR  R3,R1                     :GET CURRENT RELATIVE LU NUMBER
        LHI R9,LUBSIZ                 :NUMBER OF BYTES TO BUFFER
        MHR R3,R9
        LHI R9,WINDSZ                 :NUMBER OF PACKETS TO SAVE IN BUFPU
        MHR R3,R9
        LB  R11,BUFPIX,R1,            :NEXT ENTRY INDEX
        LHI R9,LUBSIZ
        MHR R11,R9
        AR  R3,R11
        LA  R13,BUFPU,,               :STORE IN PU BUFFER
        J   4,R5                      :SKIP CALLIX



:---------------------------------------------------------------------------
: THIS ROUTINE DETERMINES THE STARTING POINT IN BUFLU TO SAVE THIS PACKET

CALLIX  LIS R9,0
        CHI R1,0                      :SEE IF PROCESSING FIRST PU
        JE  CALLX3                    :YES, ALREADY HAVE THE ANSWER
        LIS R11,0
CALLX2  LB  R6,LUPRPU,R11,            :ADD UP LU'S PER PU UP TO CURRENT PU
        AR  R9,R6
        AIS R11,1
        CR  R11,R1                    :SEE IF AT CURRENT PU YET
        JL  CALLX2
CALLX3  LB  R6,LUPRPU,R1,             :GET NUMBER FOR CURRENT PU
CALLX4  LB  R11,DAF,R9,               :FIND OUT WHICH LU THIS IS
        CR  R11,R8
        JE  CALLX5
        AIS R9,1
        SIS R6,1
        JG  CALLX4
        HC  0,0                       :FOUND AN LU THAT DOESN'T FIT
CALLX5  LHI R3,WINDSZ
        MHR R3,R9
        LHI R11,LUBSIZ                :NUMBER OF BYTES OF FRAME TO SAVE
        MHR R3,R11
        LB  R6,BUFLIX,R9,             :GET BUFLU ENTRY INDEX
        MHR R11,R6
        AR  R3,R11
        STH R9,HLDLIX                 :SAVE INDEX TO BUFLIX
        LIS R6,1
        STH R6,PIXLIX                 :SET SWITCH TO "PROCESSING LU"
        LH  R11,HLDCNT                :GET PACKET SIZE
        LA  R13,BUFLU,,
        JR  R5


:=========================================================================
:=  THIS ROUTINE UPDATES THE SIO POINTER AND THEN USES THS FNDDM ROUTINE
:=  TO INITIALIZE THE COUNTERS

FRMERR   AIS  R4,1
         FGLOG(FRMERR)
         AR   R4,R7                   :ADD REMAINING LENGTH
         LH   R7,HLDCNT               :SEE IF ODD BYTE COUNT
         NHI  R7,1
         AR   R4,R7
         STH  R4,HLDPTR
         L    R4,FASTC,,
         ST   R4,FRMTIM
         LIS  R4,1
         AHM  R4,FRMCTR,R1,R1         :INCREMENT COUNTER
         SBT  R1,FRMIND               :USED IN STATUS DISPLAY
         J    FNDDM2
 
:[[[[[[[[[[[[[[[[[[]]]]]]]]]]]]]]]]]
: this routine handles a FRAME REJECT
FRMREJ   AIS  R4,1
         FGLOG(FRMREJ)
         AR   R4,R7
         LH   R7,HLDCNT
         NHI  R7,1
         AR   R4,R7
         STH  R4,HLDPTR
         LIS  R4,1
         AHM  R4,REJCTR,R1,R1         :COUNT EROR
         L    R4,FASTC,,
         ST   R4,REJTIM
         SBT  R1,REJIND
         RBT  R1,GOTRR
         LB   R4,PREVRR,R1            :GET PREVIOUS RR
         STB  R4,HLDBYT               :TRICK FNDRR
         J    FNDRR3                  :GO TRY TO RECOVER

:-------------------------------------------------------------------------
: THIS ROUTINE ZEROS OUT THE LUSTAT TABLE FOR ALL THIS PU'S LU'S.  TI ALSO
: SETS PUACT TO "07" WHICH MEANS "DISC", AND IT SETS PUSTAT TO 12.

FNDDM    AIS R4,1                     :UPDATE SIO
         FGLOG(FNDDM )
         STH R4,HLDPTR
         SBT R1,RPDMSW                :2nd DM RECEIVED?
         JEFS FNDDM2                  :NO, SEND DISC
         LHI R6,0FE                   :SET PU STATE DISPLAY TO IDLE
         LIS R8,0F                    :SET PU STATE TO IDLE
         RBT R1,RPDMSW                :RESET SWITCH
         JFS FNDDSX
FNDDM2   LHI R6,07 
         LHI R8,12                    :set PU state to "send DISC"
FNDDSX   STB R6,PUACT,R1              :SET PU STATE TO "DISC"  
         LIS R6,0
         STB R6,PURRNR,R1             :SET N(R) TO 0
         STB R6,PURRNS,R1             :SET N(S) TO 0
         LIS R4,0
         LIS R6,0
FNDDS3   LB  R3,LUPRPU,R1,
         CR  R4,R1
         JE  FNDDS5
         AR  R6,R3
         AIS R4,1
         J   FNDDS3
FNDDS5   LIS R4,0
         LIS R5,0
FNDDS7   STB R4,LUSTAT,R6,            :SET LU STATES TO "INACTIVE"
         AIS R6,1
         AIS R5,1
         CR  R5,R3
         JL  FNDDS7
         STB R8,PUSTAT,R1
         J   FGNRS2

:iIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIi
: Come here when an RD has been received

FNDRD    AIS R4,1
         FGLOG(FNDRD )
         STH R4,HLDPTR
         TBT R1,UAIGNR                :IGNORE THE RD REQUEST?
         JN  FNDRD2                   :YES
         LHI R8,12                    :SET STATUS DISPLAY TO "DISC"
         LIS R6,7                     :SET PUSTAT TO "SEND DISC"
         J   FNDDSX
FNDRD2   LIS R8,0F                    :SET PU STATE TO IDLE
         LHI R6,0FE                   :SET PU DISPLAY TO IDLE
         J   FNDDSX



:----------------------------------------------------------------------------

FNDUA    CHI R7,0                     :SHOULD BE NO MORE DATA IN PACKET
         JEFS FNDUA2
         HC  0,0
FNDUA2   STB R7,RRTMOC,R1,            :RESET RR TIMEOUT COUNTER
         FGLOG(FNDUA2)
         AIS R4,1
         STH R4,HLDPTR
         STH R7,LEADIX,R1,R1
         STH R7,TRAILX,R1,R1
         LI  R8,FOLDYT-(IFSIZE*2)
         STH R8,FGIX,R1,R1
         TBT R1,UAIGNR
         JN  FGNRS2
         LB  R8,PUACT,R1
         CHI R8,00FF                  :IF UA RCVD, STATE SHOULD BE "POLLING"
         JN  FNDUA3
         LIS R8,0
         STB R8,PUACT,R1              :CHANGE STATE TO "INACTIVE"
         RBT R8,DONTHG                :NO LONGER WAITING
         LIS R8,2
         STB R8,PUSTAT,R1
         J   FNDUA4
FNDUA3   CHI R8,7                     :STATE SHOUD BE "DISC SENT"
         JEFS .+4
         HC  0
         LHI R8,0F                    :SET STATE TO "IDLE"
         STB R8,PUSTAT,R1
         LHI R8,0FE
         STB R8,PUACT,R1
FNDUA4   LIS R8,0
         STB R8,PURRNR,R1             :INIT RR COUNTER
         STB R8,PURRNS,R1             :INIT N(S) COUNTER
         JAL R5,GTLUBG                :GET BEGINNING OF THIS PU'S LU'S
         LB  R5,LUPRPU,R1,            :GET NUMBER OF LU'S FOR THIS PU
FNDUA5   STB R8,LUSTAT,R6,            :SET LU STATES TO 0
         AIS R6,1
         SIS R5,1
         JG  FNDUA5
         RBT R8,DONTHG                :NO LONGER WAITING
         J   FGNRS2

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: GOT A RNR SO SET RNRARY

FNDRNR   CHI  R7,0
         JEFS FNDRN2
         HC   0
FNDRN2   SBT  R1,RNRARY,,             :SET RNR RECEIVED ARRAY
         FGLOG(FNDRN2)
         LIS  R7,1
         AHM  R7,RNRCTR,R1,R1         :COUNT RNRs
         J    FNDRR2



:--------------------------------------------------------------------------
: THIS SECTION HANDLES "RECEIVE READY'S" RECEIVED FROM THE SNA HIF

FNDRR    FGLOG(FNDRR )
         CHI R7,0
         JEFS FNDRR1
         HC  0,0
FNDRR1   RBT R1,RNRARY,,              :RESET RNR ARRAY
         RBT R1,GOTRR,,               :GOT RR, CAN NOW SEND MORE DATA
FNDRR2   AIS R4,1
         STH R4,HLDPTR
FNDRR3   LIS R4,0
         STB R4,RRTMOC,R1,            :RESET RR TIMEOUT COUNTER
         LB  R4,PUSTAT,R1             :SEE IF RESPONSE-TIME-TESTING
         CHI R4,15
         JE  FNDRR8
         LB  R8,HLDBYT                :GET COMPLETE RR
         STB R8,PREVRR,R1             :SAVE FOR FRMREJ
         NHI R8,0E0                   :GET JUST N(R) BITS
         SRLS R8,4                    :CHANGE THEM TO N(S) BITS
         L   R6,FASTC,,
         AHI R6,RRTMO                 :TIME TO SEND NEXT RR
         ST  R6,LINTIM
         ST  R6,PUTIM,R1,
         LB  R7,PUSTAT,R1
         CHI R7,0F                    :SEE IF IN IDLE STATE
         JE  FGNRS2                   :YES, STAY THAT WAY
         LIS R6,4
         STB R6,PUSTAT,R1,            :TELL B.G. TO CKRRTM
         LB  R7,PURRNS,R1             :GET OUR N(S) FOR THIS PU
         CR  R8,R7
         JE  FGNRS2                   :WINDOW MATCHES
         STB R8,PURRNS,R1             :CORRECT OUR COUNTER
         LB  R6,PURTN,R1              :GET WINDOW ERROR COUNTER
         AIS R6,1
         STB R6,PURTN,R1              :UPDATE COUNTER
         J   FGNRS2                   :YES

FNDRR8   SBT R1,RRARAY,,              :TELL F.G. TO SEND RR OR DATA
         LB  R4,HLDBYT
         NHI R4,0E0                   :GET HIF'S N(R) BITS
         SRLS R4,4
         STB R4,PURRNS,R1
         STB R4,HIFRR,R1              :WHAT THE HIF THINKS IS HAPPENING
         J    FGNRS2


RTRNFM   J  FGNRS2



:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::   COME HERE TO ACTIVATE A PU                                      :::

ACTVPU   LR  R2,R1
         FGLOG(ACTVPU)
         LHI R14,ACVPUL               :SIZE OF ACTVPU
         LA  R15,ACVPU
         JAL R10,SENDPU               :GO SEND PU STUFF
         LIS R5,3                     :SHOW "PENDING"
         STB R5,PUACT,R2,
         L   R0,LUSRET
         JR  R0

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
::: COME HERE TO SEND NMVT.  AS OF 03/08/90 THE FORMAT OF NMVT IS JUST
::: A GUESS AND SHOULD BE CORRECTED WHEN ACTUAL FORMAT IS KNOWN

NMVTPU   LHI  R14,NMVTLN
         FGLOG(NMVTPU)
         LA   R15,NMVTBF,,  
         LR   R2,R1              
         JAL  R10,SENDPU
         L    R0,LUSRET
         JR   R0

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::    DE-ACTIVATE THE PU

DACPU    LR   R2,R1     
         FGLOG(DACPU )
         LHI  R14,DACTPL 
         LA   R15,DACTPU,,
         JAL  R10,SENDPU
         L    R0,LUSRET
         JR   R0



:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:::   COMMON PU SEND ROUTINE                                            :::
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

SENDPU   LB  R8,PURRNR,R2             :GET CURRENT N(R)
         FGLOG(SENDPU)
         LB  R7,PURRNS,R2             :GET CURRENT N(S)
         AR  R8,R7
         SIS R14,2 
         STH R14,OUTBUF,,
         LB  R7,PUTAB,R2              :GET PU ADDRESS TO BE ACTIVATED
         LIS R5,2
         STB R7,OUTBUF,R5,
         STB R7,OUTRR+2,,             :ADDRESS FOR RR
         AIS R5,1
         STB R8,OUTBUF,R5,            :INFORMATION CONTROL BYTE
         AIS R14,1
         LIS R8,4
SENDP2   AIS R5,1
         LB  R7,0,R15,R8
         STB R7,OUTBUF,R5,
         AIS R8,1
         CR  R8,R14 
         JLE SENDP2
         LIS R5,2
         STH R5,OUTRR,,               :BUILD RR TRAILER
         LB  R7,PURRNR,R2,
         OHI R7,11
         STB R7,OUTRR+3,,             :RR CONTROL FIELD
         LB  R5,PURRNS,R2,
         LR  R8,R2     
         SLLS R8,1
         L   R8,SIOBBF,R8,R8
         LHL R7,FGIX,R2,R2            :PUT THIS N(S) AS LAST ONE SENT
         STB R5,SIOHL0+3,R7,R8
         AIS R5,2                     :UPDATE N(S)
         NHI R5,0F
         STB R5,PURRNS,R2,
         LIS R5,1
         STH R5,SIOOUT,,
         STH R5,SIOOUT+10,,
         LIS R5,2                     :CHAIN COMMAND
         STH R5,SIOOUT+4,,
         LA  R5,SIOOUT+10,,
         SRLS R5,4
         STH R5,SIOOUT+6,,
         LA  R5,OUTRR,,
         SRLS R5,4
         STH R5,SIOOUT+12,,
         LIS R4,0
         LA  R5,SIOOUT,,
         SVC IO,FRCMBO+R4
         HC  0,0
         LIS R5,3                     :CHANGE STATE TO RR SENT
         STB R5,PUSTAT,R2,
         LHI R5,30                    :A FEW MORE FASTC TICKS TO XMT
         AM  R5,PUTIM,R3, 
         AM  R5,LINTIM
         JR  R10






:-----------------------------------------------------------------------
: THIS ROUTINE SENDS OUT THE "ACTIVATE LU" COMMANDS

ACTVLU   JAL R10,SIOCHK
         FGLOG(ACTVLU)
         JAL R7,FFDLPU                :GET PU NUMBER
         TBT R2,RRARAY,,              :SEE IF TIME TO SEND RR
         JE  LUSTL4                   :NO
         SLLS R2,2
         L  R5,FASTC,,
         ST R5,PUTIM,R2               :SAVE RR TIME
         SRLS R2,2
         LIS R5,3
         STB R5,PUSTAT,R2             :SET STATE TO RR SENT
         LIS R13,0
         LIS R7,0
         LHI R5,81                    :PENDING STATE
ACTVL4   LB  R10,LUSTAT,R13,          :LOOK FOR LU'S IN STATE = 1
         CHI R10,1
         JNFS ACTVL7
         STH R10,SIOCHN,R7,           :PUT IN "OUTPUT" COMMAND
         AHI R7,10                    :GO TO NEXT SIO ROTOR
         STB R5,LUSTAT,R13,           :CHANGE TO PENDING
ACTVL7   AIS R13,1
         CHI R13,NUMLU
         JL  ACTVL4
         LIS R10,1
         STH R10,SIOCHN,R7,           :SET UP TRAILING RR
         LIS R8,0
         JAL R13,SIOGRP
         RBT R2,RRARAY,,              :DON'T NEED TO SEND RR
         J   FGNRST                   :GO PROCESS NEXT PU

:/>/>/>/>/>/>/>/>/>/>/>/>/>/>/>/>/>/>/>/>/>/>/>/>/>/>/>/>/
:  THIS SPACE IS FOR ONLINE TESTING
PIGLET   WS 80

         if fgtrce
         if lgqq-mxent
         remark % increase FEVENT by 
         number lgqq-mxent
         remark %
         ei
         ei
         END

   